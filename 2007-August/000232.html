<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN">
<HTML>
 <HEAD>
   <TITLE> [Medick-svn] r452 - in trunk: . libs/action/controller	libs/action/view libs/active/record libs/context/configurator	libs/creole/drivers/sqlite libs/medick
   </TITLE>
   <LINK REL="Index" HREF="http://lists.berlios.de/pipermail/medick-svn/2007-August/index.html" >
   <LINK REL="made" HREF="mailto:medick-svn%40lists.berlios.de?Subject=Re%3A%20%5BMedick-svn%5D%20r452%20-%20in%20trunk%3A%20.%20libs/action/controller%0A%09libs/action/view%20libs/active/record%20libs/context/configurator%0A%09libs/creole/drivers/sqlite%20libs/medick&In-Reply-To=%3C200708150806.l7F86vqi012298%40sheep.berlios.de%3E">
   <META NAME="robots" CONTENT="index,nofollow">
   <style type="text/css">
       pre {
           white-space: pre-wrap;       /* css-2.1, curent FF, Opera, Safari */
           }
   </style>
   <META http-equiv="Content-Type" content="text/html; charset=us-ascii">
   <LINK REL="Previous"  HREF="000231.html">
   <LINK REL="Next"  HREF="000233.html">
 </HEAD>
 <BODY BGCOLOR="#ffffff">
   <H1>[Medick-svn] r452 - in trunk: . libs/action/controller	libs/action/view libs/active/record libs/context/configurator	libs/creole/drivers/sqlite libs/medick</H1>
    <B>aurelian at mail.berlios.de</B> 
    <A HREF="mailto:medick-svn%40lists.berlios.de?Subject=Re%3A%20%5BMedick-svn%5D%20r452%20-%20in%20trunk%3A%20.%20libs/action/controller%0A%09libs/action/view%20libs/active/record%20libs/context/configurator%0A%09libs/creole/drivers/sqlite%20libs/medick&In-Reply-To=%3C200708150806.l7F86vqi012298%40sheep.berlios.de%3E"
       TITLE="[Medick-svn] r452 - in trunk: . libs/action/controller	libs/action/view libs/active/record libs/context/configurator	libs/creole/drivers/sqlite libs/medick">aurelian at mail.berlios.de
       </A><BR>
    <I>Wed Aug 15 10:06:57 CEST 2007</I>
    <P><UL>
        <LI>Previous message: <A HREF="000231.html">[Medick-svn] r451 - in trunk: . libs/action/controller	libs/action/controller/http
</A></li>
        <LI>Next message: <A HREF="000233.html">[Medick-svn] r453 - in exp: . ar5
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#232">[ date ]</a>
              <a href="thread.html#232">[ thread ]</a>
              <a href="subject.html#232">[ subject ]</a>
              <a href="author.html#232">[ author ]</a>
         </LI>
       </UL>
    <HR>  
<!--beginarticle-->
<PRE>Author: aurelian
Date: 2007-08-15 10:06:49 +0200 (Wed, 15 Aug 2007)
New Revision: 452

Modified:
   trunk/CHANGELOG
   trunk/VERSION
   trunk/boot.php
   trunk/libs/action/controller/Base.php
   trunk/libs/action/view/HTML.php
   trunk/libs/active/record/Association.php
   trunk/libs/active/record/Base.php
   trunk/libs/active/record/QueryBuilder.php
   trunk/libs/active/record/Validator.php
   trunk/libs/context/configurator/LoggerConfigurator.php
   trunk/libs/creole/drivers/sqlite/SQLiteConnection.php
   trunk/libs/medick/ErrorHandler.php
   trunk/libs/medick/Medick.php
   trunk/libs/medick/Object.php
   trunk/libs/medick/util.php
Log:
 * ETag is disabled by deafult
 * Added MTimer class
 * More on logger message
 * SQLiteConnection forced to use Medick Error Handler
 * Small speed improvements and refactorings to ActiveRecord
 * Prepare for release 0.4.1



Modified: trunk/CHANGELOG
===================================================================
--- trunk/CHANGELOG	2007-08-01 14:57:17 UTC (rev 451)
+++ trunk/CHANGELOG	2007-08-15 08:06:49 UTC (rev 452)
@@ -1,15 +1,17 @@
 $Id$
 
-0.4.1-svn
-    - (bug) fixed URL::create when rewrite is off (still needs more testing)
-    - (bug) fixed a syntax error in JSON
+0.4.1 (15.Aug.2007)
+    - (fixed) URL::create when rewrite is off (still needs more testing)
+    - (fixed) syntax error in HTML.JSON
+    - added MTimer for timing code execution
     - moved configurator to context
-    - added support for ETag
+    - added support for ETag (disabled by default)
     - unifyed logger messages
     - unifyed HTTPReqest Headers (If-None-Match for Apache was If_None_March on non Apache Web servers)
     - added methods to allow more control of HTTPResponse headers
     - some docs on HTTPResponse
     - using ORIG_PATH_INFO in HTTPRequest so it can work with lighttpd
+    - small refactorings to ActiveRecord and Creole SQLiteConnection
     
 0.4.0 (17.Jun.2007)
     - added HTTPRequest::is_xhr() method

Modified: trunk/VERSION
===================================================================
--- trunk/VERSION	2007-08-01 14:57:17 UTC (rev 451)
+++ trunk/VERSION	2007-08-15 08:06:49 UTC (rev 452)
@@ -1 +1 @@
-0.4.1-svn
+0.4.1

Modified: trunk/boot.php
===================================================================
--- trunk/boot.php	2007-08-01 14:57:17 UTC (rev 451)
+++ trunk/boot.php	2007-08-15 08:06:49 UTC (rev 452)
@@ -2,7 +2,7 @@
 // {{{ License
 // ///////////////////////////////////////////////////////////////////////////////
 //
-// Copyright (c) 2005, 2006 Oancea Aurelian &lt;aurelian[at]locknet[dot]ro&gt;
+// Copyright (c) 2005 - 2007 Aurelian Oancea &lt;aurelian[at]locknet[dot]ro&gt;
 //
 // Redistribution and use in source and binary forms, with or without
 // modification, are permitted provided that the following conditions are met:
@@ -12,7 +12,7 @@
 //   * Redistributions in binary form must reproduce the above copyright notice,
 //   this list of conditions and the following disclaimer in the documentation
 //   and/or other materials provided with the distribution.
-//   * Neither the name of Oancea Aurelian nor the names of his contributors may
+//   * Neither the name of Aurelian Oancea nor the names of his contributors may
 //   be used to endorse or promote products derived from this software without
 //   specific prior written permission.
 //
@@ -43,14 +43,14 @@
 set_include_path( MEDICK_PATH . 'libs'   . DIRECTORY_SEPARATOR );
 
 // this should depend on environment
-error_reporting( E_ALL | E_STRICT );
+error_reporting( E_ALL | E_STRICT | E_RECOVERABLE_ERROR );
 // php 5.1 strict sdandards.
 if (version_compare(PHP_VERSION, '5.1.0') &gt; 0) {
     date_default_timezone_set('Europe/Bucharest');
 }
 
 // load core classes
-require('medick/Medick.php');
-set_error_handler(array(new ErrorHandler(), 'raiseError'));
+require( 'medick/Medick.php' );
+set_error_handler( array(new ErrorHandler(), 'raiseError') );
 require('action/controller/Dispatcher.php');
 

Modified: trunk/libs/action/controller/Base.php
===================================================================
--- trunk/libs/action/controller/Base.php	2007-08-01 14:57:17 UTC (rev 451)
+++ trunk/libs/action/controller/Base.php	2007-08-15 08:06:49 UTC (rev 452)
@@ -266,11 +266,11 @@
 
     /** @var string
         the layout to use */
-    protected $use_layout= TRUE;
+    protected $use_layout= true;
 
     /** @var bool  
         etag flag, set to true to use the Etag caching, false to disable-it */
-    protected $use_etag= TRUE;
+    protected $use_etag= false;
 
     /** @var ActiveViewBase
         Template Engine */

Modified: trunk/libs/action/view/HTML.php
===================================================================
--- trunk/libs/action/view/HTML.php	2007-08-01 14:57:17 UTC (rev 451)
+++ trunk/libs/action/view/HTML.php	2007-08-15 08:06:49 UTC (rev 452)
@@ -223,23 +223,19 @@
  */
 class URL extends Object {
 
-    public static function create($controller, $action='index', $params=array(), $ext='html') {
+    public static function create( $controller, $action='index', $params=array(), $ext='html' ) {
         $config = Registry::get('__configurator');
-        $base   = (string)$config-&gt;getWebContext()-&gt;document_root;
+        $base   = (string)$config-&gt;getWebContext()-&gt;server_name . (string)$config-&gt;getWebContext()-&gt;document_root;
         $rewrite= (string)strtolower($config-&gt;getWebContext()-&gt;rewrite);
         if ($rewrite == 'false' || $rewrite == 'off' || $rewrite == '0') {
-            $base .= 'index.php';
+            $base .= 'index.php/';
         }
-        $buff= $base . '/';
-        if ($controller) $buff .= $controller . '/';
-        $buff .= $action;
-        
+        if ($controller) $base .= $controller . '/';
+        $base .= $action;
         foreach ($params as $key=&gt;$value) {
-            $buff .= '/' . $value;
+            $base .= '/' . $value;
         }
-        
-        if ($ext=='') return $buff;
-        else return $buff . '.' . $ext;
+        return $ext == '' ? $base : $base . '.' . $ext;
     }
 }
 

Modified: trunk/libs/active/record/Association.php
===================================================================
--- trunk/libs/active/record/Association.php	2007-08-01 14:57:17 UTC (rev 451)
+++ trunk/libs/active/record/Association.php	2007-08-15 08:06:49 UTC (rev 452)
@@ -2,7 +2,7 @@
 // {{{ License
 // ///////////////////////////////////////////////////////////////////////////////
 //
-// Copyright (c) 2005 - 2007 Oancea Aurelian &lt; aurelian [ at ] locknet [ dot ] ro &gt;
+// Copyright (c) 2005 - 2007 Aurelian Oancea &lt; aurelian [ at ] locknet [ dot ] ro &gt;
 //
 // Redistribution and use in source and binary forms, with or without
 // modification, are permitted provided that the following conditions are met:
@@ -12,7 +12,7 @@
 //   * Redistributions in binary form must reproduce the above copyright notice,
 //   this list of conditions and the following disclaimer in the documentation
 //   and/or other materials provided with the distribution.
-//   * Neither the name of Oancea Aurelian nor the names of his contributors may
+//   * Neither the name of Aurelian Oancea nor the names of his contributors may
 //   be used to endorse or promote products derived from this software without
 //   specific prior written permission.
 //

Modified: trunk/libs/active/record/Base.php
===================================================================
--- trunk/libs/active/record/Base.php	2007-08-01 14:57:17 UTC (rev 451)
+++ trunk/libs/active/record/Base.php	2007-08-15 08:06:49 UTC (rev 452)
@@ -71,28 +71,32 @@
 
     /** @var string
         class name: Person */
-    protected $class_name = NULL;
+    protected $class_name  = null;
 
     /** @var string
-        table mane: persons */
-    protected $table_name = NULL;
+        table name: persons */
+    protected $table_name  = null;
 
     /** @var CreoleConnection
         database connection */
-    static protected $conn= NULL;
+    static protected $conn = null;
+    
+    /** @var array
+        this Object fields */
+    protected $fields   = array();
 
-    /** @var DatabaseRow
-        our database row. */
-    // protected $row;
+    /** @var array
+        an array of validators attached to this object */
+    private $validators = array();
 
-    protected $fields=array();
+    /** @var array
+        an array of errors associated with this object */
+    private $errors     = array();
     
-    private $validators= array();
+    /** @var bool
+        flag that indicates if the errors where collected or not */
+    private $collected  = false;
     
-    private $errors= array();
-
-    private $collected= FALSE;
-    
     /** @var string
         primary key name */
     private $pk;
@@ -108,9 +112,8 @@
      * Constructor
      *
      * @param array, params, parameters as pair of `field name` =&gt; `value`
-     * @final because there is no reason to overwrite in parent classes, PHP Engine will call this constructor by default.
      */
-    public function ActiveRecord($params= array()) {
+    public function ActiveRecord( Array $params= array() ) {
         $this-&gt;class_name = $this-&gt;getClassName();
         $this-&gt;table_name = Inflector::pluralize(strtolower(Inflector::underscore($this-&gt;class_name)));
         $table_info = ActiveRecordTableInfo::getInstance(ActiveRecord::connection(), $this-&gt;table_name);
@@ -134,11 +137,13 @@
             }
             $this-&gt;fields[$field-&gt;getName()]= $field;
         }
-        // confused?
+        // confused? this sets the field values
         if(!empty($params)) { foreach ($params as $field_name =&gt; $field_value) {
             $this-&gt;$field_name = $field_value;
         }}
     }
+    
+    // private $inc=null;
 
     /**
      * It sets the value of the field
@@ -149,8 +154,25 @@
      * @throws ActiveRecordException if the field is not found.
      */
     public function __set($name, $value) {
-        if ($this-&gt;hasField($name)) $this-&gt;getField($name)-&gt;setValue($value);
-        else throw new ActiveRecordException('No such Filed: ' . $name);
+
+        /*$tmp = explode(&quot;.&quot;, $name);
+
+        if( sizeof($tmp) &gt; 1 ) {
+          if( $tmp[0] == $this-&gt;table_name ) {
+            $name= $tmp[1];
+          } else {
+            if( !$this-&gt;inc ) {
+              $this-&gt;inc= ActiveRecord::reflect_class( Inflector::singularize( $tmp[0] ) )-&gt;newInstance();
+            }
+            return $this-&gt;inc-&gt;getField($tmp[1])-&gt;setValue($value);
+          }
+        }*/
+
+        if ( $this-&gt;hasField( $name ) ) return $this-&gt;getField( $name )-&gt;setValue( $value );
+        if ( $value instanceof ActiveRecord &amp;&amp; $this-&gt;belongs_to( $value-&gt;getClassName() ) ) {
+            return $this-&gt;getField( $name.'_id' )-&gt;setValue($value-&gt;id);
+        }
+        throw new ActiveRecordException('No such Field: ' . $name);
     }
 
     /**
@@ -162,13 +184,15 @@
      * @return field value
      */
     public function __get($name) {
-        if ($this-&gt;hasField($name)) return $this-&gt;getField($name)-&gt;getValue();
+        if ( $this-&gt;hasField($name) ) return $this-&gt;getField( $name )-&gt;getValue();
+        // if ( $this-&gt;inc &amp;&amp; $this-&gt;inc-&gt;getClassName()==ucfirst($name) ) return $this-&gt;inc;//-&gt;getField( $name )-&gt;getValue();
         try {
-            return Association::resolve($this, $name)-&gt;execute();
+            return Association::resolve( $this, $name )-&gt;execute();
         } catch (AssociationNotFoundException $anfEx) {
             throw new ActiveRecordException(
                 'Cannot Get the value of field: `' . $name . '`. No such field!', $anfEx-&gt;getMessage() );
         }
+
     }
     
     /**
@@ -180,12 +204,6 @@
      *    &lt;i&gt;validates_&lt;/i&gt;*, it loads a Validator, eg. validates_presence_of will load PresenceOfValidator&lt;br /&gt;
      *  &lt;/li&gt;
      *  &lt;li&gt;
-     *    &lt;i&gt;before_&lt;/i&gt;* , if not defined, a call to a before filter will return true
-     *  &lt;/li&gt;
-     *  &lt;li&gt;
-     *    &lt;i&gt;after_&lt;/i&gt;* , if not defined this will return
-     *  &lt;/li&gt;
-     *  &lt;li&gt;
      *    &lt;i&gt;get&lt;/i&gt;* , if not defined will try to return a Field, eg.: assuming Person is an ActiveRecord class:&lt;br /&gt;
      *    &lt;code&gt;$p= Person::find(1);
      * $p-&gt;getName(); // returns a Field object
@@ -214,8 +232,8 @@
             $this-&gt;validators[]= $validator;
             return $validator;
         }
-        if (substr($method,0,7) == 'before_') return true; 
-        if (substr($method,0,6) == 'after_')  return;
+        // if (substr($method,0,7) == 'before_')return true; 
+        // if (substr($method,0,6) == 'after_')  return;
         if (substr($method,0,3) == 'get' &amp;&amp; $this-&gt;hasField(strtolower(substr($method, 3)))) {
             return $this-&gt;getField(strtolower(substr($method, 3)));
         }
@@ -265,7 +283,7 @@
     public function getTableName() {
         return $this-&gt;table_name;
     }
-    
+
     /**
      * Check if it has a Field with the given name
      *
@@ -279,7 +297,7 @@
     /**
      * It gets all the Fields of this Object
      *
-     * @return Array
+     * @return Array of Field
      */ 
     public function getFields() {
         return $this-&gt;fields;
@@ -301,6 +319,7 @@
      * @return Field
      */ 
     public function getPrimaryKey() {
+        if($this-&gt;hasField('id')) return $this-&gt;getField('id');
         foreach($this-&gt;fields as $field) {
             if ($field-&gt;isPk) return $field;
         }
@@ -320,25 +339,63 @@
     }
     
     /**
+     * Checks if this Object has declared a has_one association
+     *
+     * @return bool
+     */ 
+    public function has_one( $thing ) {
+        return in_array( strtolower($thing), $this-&gt;has_one );
+    }
+
+    /**
+     * Checks if this Object has declared a belongs_to association
+     *
+     * @return bool 
+     */  
+    public function belongs_to( $thing ) {
+        return ( in_array( strtolower($thing), $this-&gt;belongs_to ) &amp;&amp; $this-&gt;hasField(strtolower($thing).'_id') );
+    }
+    
+    /**
      * Check if this object has errors
      *
-     * @return bool TRUE if it has
+     * @return bool true if it has
      */ 
     public function hasErrors() {
         return sizeof($this-&gt;errors) &gt; 0;
     }
-
+    
+    /**
+     * Gets the Object Errors
+     *
+     * @return array
+     */ 
     public function getErrors() {
         return $this-&gt;errors;
     }
-    
-    public function isValid($force= FALSE) {
-        if ($this-&gt;collected) return !$this-&gt;hasErrors();
+
+    /**
+     * Check if this Object is Valid
+     * 
+     * Note: You have to perform an action on the object before checking it's 
+     * validity, otherwise it will return true
+     *
+     * @return @bool
+     */
+    public function isValid( $force= false ) {
+        if ( $this-&gt;collected ) return !$this-&gt;hasErrors();
         else return $this-&gt;collect_errors($force) === 0;
     }
-
-    private function collect_errors($force= FALSE) {
-        if ($this-&gt;collected &amp;&amp; !$force) return sizeof($this-&gt;errors);
+    
+    /**
+     * Collects the errors associated with this object
+     * 
+     * It also builds the errors array
+     *
+     * @return int number of errors
+     */ 
+    private function collect_errors( $force= false ) {
+        if ($this-&gt;collected &amp;&amp; !$force) return sizeof( $this-&gt;errors );
         $this-&gt;run_validators();
         foreach ($this-&gt;fields as $field) {
             if ($field-&gt;hasErrors()) {
@@ -349,16 +406,32 @@
                 // $this-&gt;errors= $field-&gt;getErrors();
             }
         }
-        $this-&gt;collected= TRUE;
+        $this-&gt;collected= true;
         return sizeof($this-&gt;errors);
     }
-    
+
+    /**
+     * Runs each validator
+     *
+     * @return void
+     */ 
     private function run_validators() {
         foreach ($this-&gt;validators as $v) {
             $v-&gt;validate_each();
         }
     }
-    
+
+    // {{{ filters
+    protected function before_insert() { return true; }
+    protected function after_insert() { }
+    protected function before_update() { return true; }
+    protected function after_update() { }
+    protected function before_save() {   return true; }
+    protected function after_save() { }
+    protected function before_delete() { return true; }
+    protected function after_delete() { }
+    // }}}
+
     // {{{ save
     /**
      * Save,
@@ -366,24 +439,21 @@
      *    or an Update returning the number of affected rows.
      * If the primary key is affected (changed) on this run we will do an update, otherwise an insert.
      * &lt;code&gt;
-     *      $author = new Author();
-     *      $author-&gt;name = 'Mihai';
-     *      $author-&gt;firstName = 'Eminescu';
-     *      $author-&gt;save(); // will do the insert, returning the ID of the last field inserted.
-     *      // a mistake, let`s update.
-     *      $author-&gt;firstName = 'Sadoveanu';
-     *      $author-&gt;save(); // performs the update and returns the number of affected rows (1).
+     *  $author = new Author();
+     *  $author-&gt;name = 'Mihai';
+     *  $author-&gt;firstName = 'Eminescu';
+     *  $author-&gt;save(); // will do the insert, returning the ID of the last field inserted.
+     *  // a mistake, let`s update.
+     *  $author-&gt;firstName = 'Sadoveanu';
+     *  $author-&gt;save(); // performs the update and returns the number of affected rows (1).
      * &lt;/code&gt;
      */
     public function save() {
-        if ( !$this-&gt;before_save() || !$this-&gt;isValid()) {
-            return false;
-        }
-        if ($this-&gt;getPrimaryKey()-&gt;isAffected) {
-            return $this-&gt;update();
-        } else {
-            return $this-&gt;insert();
-        }
+        if ( !$this-&gt;before_save() || !$this-&gt;isValid()) return false;
+        if ( $this-&gt;getPrimaryKey()-&gt;isAffected ) $af= $this-&gt;update();
+        else $af= $this-&gt;insert();
+        $this-&gt;after_save();
+        return $af;
     }
     // }}}
 
@@ -392,11 +462,9 @@
      * Executes an SQL insert
      *
      * &lt;code&gt;
-     *     $author = new Author();
-     *     $author-&gt;name= 'Mihai';
-     *     $author-&gt;insert();
-     *     // is translated into:
-     *     // INSERT INTO authors (name) VALUES ('Mihai');
+     *  $author = new Author();
+     *  $author-&gt;name= 'Mihai';
+     *  $author-&gt;insert(); // INSERT INTO authors (name) VALUES ('Mihai');
      * &lt;/code&gt;
      *
      * @return int next primary key id or, 1 (affected rows).
@@ -418,22 +486,24 @@
      * Executes a SQL update
      *
      * &lt;code&gt;
-     *     $author = new Author(array('id'=&gt;5));
-     *     // or: $author= new Author(); $author-&gt;id = 5;
-     *     $author-&gt;name= 'Mihai';
-     *     $author-&gt;update();
-     *     // is translated into:
-     *     // UPDATE authors set name='Mihai' WHERE id=5;
+     *  $author = new Author( array('id'=&gt;5) );
+     *  // or: $author= new Author(); $author-&gt;id = 5;
+     *  $author-&gt;name= 'Mihai';
+     *  $author-&gt;update(); // UPDATE authors set name='Mihai' WHERE id=5;
      * &lt;/code&gt;
      *
      * @return int affected rows.
      * @throws SQLException
      */
     public function update() {
-        if ( !$this-&gt;before_update() || !$this-&gt;isValid()) {
-            return false;
-        }
-        $af= $this-&gt;performQuery($this-&gt;getUpdateSql());
+        $this-&gt;before_update();
+        if( !$this-&gt;isValid() ) return false;
+        
+        // if ( !$this-&gt;before_update() || !$this-&gt;isValid()) {
+        //     return false;
+        // }
+
+        $af= $this-&gt;performQuery( $this-&gt;getUpdateSql() );
         $this-&gt;after_update();
         return $af;
     }
@@ -445,15 +515,16 @@
      *   $author= Author::find(5); // select * from authors where id=5;
      *   $author-&gt;attributes(array('name'=&gt;'Jon'))-&gt;save(); // update authors set name='Jon' where id=5;
      * &lt;/code&gt;
-     * This method is also useful when receiving an array of parameters from HTTPRequest (form).
+     *
+     * This method is also useful when receiving an array of parameters from HTTPRequest (form):
      * &lt;code&gt;
      *   // controller
-     *   $user= User::find($request-&gt;getParameter('id'))-&gt;attributes($request-&gt;getParameter('user'))-&gt;save();
+     *   $user= User::find( $request-&gt;getParameter('id') )-&gt;attributes($request-&gt;getParameter('user'))-&gt;save();
      * &lt;/code&gt;
      *
      * @return ActiveRecord
      */ 
-    public function attributes(/*Array*/ $params=array()) {
+    public function attributes( Array $params=array() ) {
         foreach($params as $name=&gt;$value) {
             $this-&gt;$name=$value;
         }
@@ -467,12 +538,8 @@
      * Performs an SQL delete.
      *
      * &lt;code&gt;
-     *     $affected_rows= new Author(array('id'=&gt;5, 'name'=&gt;'Mihai'))-&gt;delete();
-     *     // translated into:
-     *     // DELETE FROM authors WHERE id=5 and name='Mihai';
-     *     $affected_rows = new Author(array('name'=&gt;'Mihai'))-&gt;delete();
-     *     // is translated to:
-     *     // DELETE FROM authors WHERE name='Mihai'
+     *  $author= Author::find(5);
+     *  $author-&gt;delete(); // delete from authors where id=5
      * &lt;/code&gt;
      *
      * @return int affected rows.
@@ -485,10 +552,13 @@
         if ($this-&gt;getPrimaryKey() !== NULL &amp;&amp; $this-&gt;getPrimaryKey()-&gt;getValue()===NULL) {
             throw new ActiveRecordException('Refusing to delete everything from ' . $this-&gt;table_name . ', Primary Key was NULL');
         }
+        $timer= new MTimer();
         $sql= 'delete from ' . $this-&gt;table_name . ' where id=?';
-        $stmt= ActiveRecord::$conn-&gt;prepareStatement($sql);
+        $stmt= ActiveRecord::$conn-&gt;prepareStatement( $sql );
         $stmt-&gt;setInt(1, $this-&gt;getPrimaryKey()-&gt;getValue());
         $af_rows= $stmt-&gt;executeUpdate();
+        $stmt-&gt;close();
+        ActiveRecord::log( $timer, $af_rows );
         $this-&gt;after_delete();
         return $af_rows;
     }
@@ -519,18 +589,25 @@
      * @return int affected rows
      * @throws SQLException
      */
-    private function performQuery($sql) {
+    private function performQuery( $sql ) {
+        $timer= new MTimer();
         $stmt = ActiveRecord::$conn-&gt;prepareStatement($sql);
         ActiveRecord::populateStmtValues($stmt, $this-&gt;getAffectedFields());
         $af_rows = $stmt-&gt;executeUpdate();
         $stmt-&gt;close();
-        Registry::get('__logger')-&gt;debug(sprintf(&quot;[Medick] &gt;&gt; SQLQuery\n\t%s&quot;, ActiveRecord::$conn-&gt;lastQuery));
-        // $this-&gt;_reset();
+        ActiveRecord::log($timer, $af_rows);
         return $af_rows;
     }
 
+    protected static function log( $timer=null, $rows=null ) {
+      Registry::get('__logger')-&gt;debug(
+        sprintf(&quot;[Medick] &gt;&gt; SQLQuery ( %s %.3f sec. )\n\t%s&quot;, $rows!==null ? $rows==1 ? $rows.' row.':$rows.' rows.' :'', $timer-&gt;stop(), ActiveRecord::$conn-&gt;lastQuery)
+      );
+      unset($timer);
+    }
+
     /**
-     * It gets the sql snippet that will be  used to execute an update
+     * It gets the sql snippet that will be used to execute an update
      *
      * FIXME:
      * &lt;tt&gt;UPDATE __TABLE__ SET foo='12' WHERE bar='ee';&lt;/tt&gt;
@@ -546,14 +623,16 @@
         $sql  = 'UPDATE ' . $this-&gt;table_name . ' SET ';
         // $sql .= implode(' = ?, ', $this-&gt;row-&gt;getAffectedFieldsNames());
 
-        foreach($this-&gt;getAffectedFields() as $field) {
-            $sql .= $field-&gt;getName() . ' = ?, ';
+        // foreach($this-&gt;getAffectedFields() as $field) {
+        foreach($this-&gt;fields as $field) {
+            if($field-&gt;isAffected()) $sql .= $field-&gt;getName() . ' = ?, ';
         }
         return substr($sql, 0, -2) . $sqlSnippet;
     }
 
     /**
      * It gets the sql snippet to use for an insert
+     *
      * @return string
      */
     private function getInsertSql() {
@@ -603,9 +682,10 @@
      * @param string sql query to execute
      * @return ResultSet
      */ 
-    protected static function execute($sql) {
-        $r= ActiveRecord::connection()-&gt;executeQuery($sql);
-        Registry::get('__logger')-&gt;debug( ActiveRecord::$conn-&gt;lastQuery );
+    protected static function execute( $sql ) {
+        $timer = new MTimer();
+        $r= ActiveRecord::connection()-&gt;executeQuery( $sql );
+        ActiveRecord::log( $timer );
         return $r;
     }
 
@@ -620,11 +700,13 @@
     }
        
     /**
+     *
      * @return ActiveRecord or a RowsAggregate (Collection of ActiveRecords)
      */
     public static function build(QueryBuilder $builder) {
-        $class= ActiveRecord::reflect_class($builder-&gt;getOwner());
-        $rs= ActiveRecord::create_result_set($builder);
+        // $class= ActiveRecord::reflect_class( $builder-&gt;getOwner() );
+        $class= $builder-&gt;getOwnerClass();
+        $rs= ActiveRecord::create_result_set( $builder );
         if ($builder-&gt;getType() == 'first') return ActiveRecord::fetch_one($rs, $class);
         return ActiveRecord::fetch_all($rs, $class);
     } 
@@ -634,7 +716,7 @@
      *
      * @return ReflectionClass
      */
-    protected static function reflect_class($class_name, $r=0) {
+    public static function reflect_class( $class_name, $r=0 ) {
         try {
             return new ReflectionClass($class_name);
         } catch (ReflectionException $rEx) {
@@ -649,12 +731,13 @@
      * @return ResultSet
      */
     protected static function create_result_set(QueryBuilder $builder) {
+        $timer = new MTimer();
         $stmt = ActiveRecord::connection()-&gt;prepareStatement($builder-&gt;compile()-&gt;getQueryString());
         $i=1; foreach($builder-&gt;getBindings() as $binding) $stmt-&gt;set($i++, $binding);
         if ($limit  = $builder-&gt;getLimit())  $stmt-&gt;setLimit($limit);
         if ($offset = $builder-&gt;getOffset()) $stmt-&gt;setOffset($offset);
         $rs= $stmt-&gt;executeQuery();
-        Registry::get('__logger')-&gt;debug(sprintf(&quot;[Medick] &gt;&gt; SQLQuery\n\t%s&quot;, ActiveRecord::$conn-&gt;lastQuery));
+        ActiveRecord::log( $timer );
         $stmt-&gt;close();
         return $rs;
     }
@@ -698,7 +781,7 @@
      */ 
     protected static function connection() {
         if (ActiveRecord::$conn === NULL) {
-            ActiveRecord::$conn = Creole::getConnection(ActiveRecord::parse_dsn());
+            ActiveRecord::$conn = Creole::getConnection( ActiveRecord::parse_dsn() );
         }
         return ActiveRecord::$conn;
     }
@@ -717,14 +800,6 @@
      */ 
     private static function parse_dsn() {
         return Registry::get('__configurator')-&gt;getDatabaseDsn();
-        /*
-        $ini_file= Registry::get('__configurator')-&gt;getApplicationPath() . DIRECTORY_SEPARATOR . 'conf' . DIRECTORY_SEPARATOR . 'database.ini';
-        if (!is_file($ini_file)) {
-            throw new ActiveRecordException('Cannot load database settings from: ' . $ini_file . ' No such file or directory!');
-        }
-        $settings= parse_ini_file($ini_file, true);
-        return $settings[Registry::get('__configurator')-&gt;getEnvName()];
-        */
     }
     // }}}
 }

Modified: trunk/libs/active/record/QueryBuilder.php
===================================================================
--- trunk/libs/active/record/QueryBuilder.php	2007-08-01 14:57:17 UTC (rev 451)
+++ trunk/libs/active/record/QueryBuilder.php	2007-08-15 08:06:49 UTC (rev 452)
@@ -2,7 +2,7 @@
 // {{{ License
 // ///////////////////////////////////////////////////////////////////////////////
 //
-// Copyright (c) 2005 - 2007 Oancea Aurelian &lt; aurelian [ at ] locknet [ dot ] ro &gt;
+// Copyright (c) 2005 - 2007 Aurelian Oancea &lt; aurelian [ at ] locknet [ dot ] ro &gt;
 //
 // Redistribution and use in source and binary forms, with or without
 // modification, are permitted provided that the following conditions are met:
@@ -12,7 +12,7 @@
 //   * Redistributions in binary form must reproduce the above copyright notice,
 //   this list of conditions and the following disclaimer in the documentation
 //   and/or other materials provided with the distribution.
-//   * Neither the name of Oancea Aurelian nor the names of his contributors may
+//   * Neither the name of Aurelian Oancea nor the names of his contributors may
 //   be used to endorse or promote products derived from this software without
 //   specific prior written permission.
 //
@@ -121,6 +121,15 @@
     }
     
     /**
+     * It creates an instance of the owner
+     *
+     * @return ReflectionClass
+     */ 
+    public function getOwnerClass() {
+        return ActiveRecord::reflect_class( $this-&gt;owner );
+    }
+
+    /**
      * It gets the current list of bindings
      *
      * @return array the list of bindings
@@ -155,6 +164,9 @@
      * @return SQLCommand
      */
     public function compile() {
+        if(isset($this-&gt;clauses['include'])) {
+          $this-&gt;clauses['left join'] = Inflector::pluralize($this-&gt;clauses['include']) . ' on ' . Inflector::pluralize($this-&gt;clauses['include']).'.id='.Inflector::tabelize($this-&gt;owner).'.'.$this-&gt;clauses['include'].'_id';
+        }
         $command= SQLCommand::select()-&gt;from(Inflector::tabelize($this-&gt;owner));
         if (isset($this-&gt;clauses['from']))       $command-&gt;from($this-&gt;clauses['from']);
         if (isset($this-&gt;clauses['condition']))  $command-&gt;where($this-&gt;clauses['condition']);

Modified: trunk/libs/active/record/Validator.php
===================================================================
--- trunk/libs/active/record/Validator.php	2007-08-01 14:57:17 UTC (rev 451)
+++ trunk/libs/active/record/Validator.php	2007-08-15 08:06:49 UTC (rev 452)
@@ -2,7 +2,7 @@
 // {{{ License
 // ///////////////////////////////////////////////////////////////////////////////
 //
-// Copyright (c) 2005 - 2006 Oancea Aurelian &lt; aurelian [ at ] locknet [ dot ] ro &gt;
+// Copyright (c) 2005 - 2007 Aurelian Oancea &lt; aurelian [ at ] locknet [ dot ] ro &gt;
 //
 // Redistribution and use in source and binary forms, with or without
 // modification, are permitted provided that the following conditions are met:
@@ -12,7 +12,7 @@
 //   * Redistributions in binary form must reproduce the above copyright notice,
 //   this list of conditions and the following disclaimer in the documentation
 //   and/or other materials provided with the distribution.
-//   * Neither the name of Oancea Aurelian nor the names of his contributors may
+//   * Neither the name of Aurelian Oancea nor the names of his contributors may
 //   be used to endorse or promote products derived from this software without
 //   specific prior written permission.
 //
@@ -236,7 +236,7 @@
      * @see Validator::validates
      */ 
     public function validate(Field $field) {
-        if ($field-&gt;getValue() == '') { 
+        if ( $field-&gt;getValue() == '' ) { 
             $field-&gt;addError(sprintf($this-&gt;message, $field-&gt;getFormattedName()));
         }
     }

Modified: trunk/libs/context/configurator/LoggerConfigurator.php
===================================================================
--- trunk/libs/context/configurator/LoggerConfigurator.php	2007-08-01 14:57:17 UTC (rev 451)
+++ trunk/libs/context/configurator/LoggerConfigurator.php	2007-08-15 08:06:49 UTC (rev 452)
@@ -32,7 +32,7 @@
 // ///////////////////////////////////////////////////////////////////////////////
 // }}}
 
-include_once('configurator/IConfigurator.php');
+include_once('context/configurator/IConfigurator.php');
 
 /**
  * A plain Application Configurator

Modified: trunk/libs/creole/drivers/sqlite/SQLiteConnection.php
===================================================================
--- trunk/libs/creole/drivers/sqlite/SQLiteConnection.php	2007-08-01 14:57:17 UTC (rev 451)
+++ trunk/libs/creole/drivers/sqlite/SQLiteConnection.php	2007-08-15 08:06:49 UTC (rev 452)
@@ -178,18 +178,20 @@
         require_once 'creole/drivers/sqlite/SQLiteResultSet.php';
         return new SQLiteResultSet($this, $result, $fetchmode);    
     }    
-    
+
+   
+
     /**
      * @see Connection::executeUpdate()
      */
-    function executeUpdate($sql)
-    {
-        $this-&gt;lastQuery = $sql;
-        $result = @sqlite_query($this-&gt;dblink, $this-&gt;lastQuery);
-        if (!$result) {            
-            throw new SQLException('Could not execute update', $php_errormsg, $this-&gt;lastQuery); //sqlite_error_string(sqlite_last_error($this-&gt;dblink))
+    function executeUpdate($sql) {
+        $this-&gt;lastQuery= $sql;
+        try {
+          sqlite_query( $this-&gt;dblink, $this-&gt;lastQuery );
+        } catch(Error $err) {
+          throw new SQLException('Could not execute update', $this-&gt;formatErrorMessage(), $this-&gt;lastQuery);
         }
-        return (int) @sqlite_changes($this-&gt;dblink);
+        return $this-&gt;getUpdateCount();
     }
     
     /**
@@ -232,14 +234,16 @@
     }
 
     /**
-     * Gets the number of rows affected by the data manipulation
-     * query.
+     * Gets the number of rows affected by the data manipulation query.
      *
      * @return int Number of rows affected by the last query.
      */
-    function getUpdateCount()
-    {
+    function getUpdateCount() {
         return (int) @sqlite_changes($this-&gt;dblink);
     }
-    
+
+    protected function formatErrorMessage() {
+      return sqlite_error_string( sqlite_last_error($this-&gt;dblink) );
+    }
+
 }

Modified: trunk/libs/medick/ErrorHandler.php
===================================================================
--- trunk/libs/medick/ErrorHandler.php	2007-08-01 14:57:17 UTC (rev 451)
+++ trunk/libs/medick/ErrorHandler.php	2007-08-15 08:06:49 UTC (rev 452)
@@ -2,7 +2,7 @@
 // {{{ License
 // ///////////////////////////////////////////////////////////////////////////////
 //
-// Copyright (c) 2005 - 2007 Oancea Aurelian &lt; aurelian [ at ] locknet [ dot ] ro &gt;
+// Copyright (c) 2005 - 2007 Aurelian Oancea &lt; aurelian [ at ] locknet [ dot ] ro &gt;
 //
 // Redistribution and use in source and binary forms, with or without
 // modification, are permitted provided that the following conditions are met:
@@ -12,7 +12,7 @@
 //   * Redistributions in binary form must reproduce the above copyright notice,
 //   this list of conditions and the following disclaimer in the documentation
 //   and/or other materials provided with the distribution.
-//   * Neither the name of Oancea Aurelian nor the names of his contributors may
+//   * Neither the name of Aurelian Oancea nor the names of his contributors may
 //   be used to endorse or promote products derived from this software without
 //   specific prior written permission.
 //

Modified: trunk/libs/medick/Medick.php
===================================================================
--- trunk/libs/medick/Medick.php	2007-08-01 14:57:17 UTC (rev 451)
+++ trunk/libs/medick/Medick.php	2007-08-15 08:06:49 UTC (rev 452)
@@ -2,7 +2,7 @@
 // {{{ License
 // ///////////////////////////////////////////////////////////////////////////////
 //
-// Copyright (c) 2005 - 2007 Oancea Aurelian &lt; aurelian [ at ] locknet [ dot ] ro &gt;
+// Copyright (c) 2005 - 2007 Aurelian Oancea &lt; aurelian [ at ] locknet [ dot ] ro &gt;
 //
 // Redistribution and use in source and binary forms, with or without
 // modification, are permitted provided that the following conditions are met:
@@ -12,7 +12,7 @@
 //   * Redistributions in binary form must reproduce the above copyright notice,
 //   this list of conditions and the following disclaimer in the documentation
 //   and/or other materials provided with the distribution.
-//   * Neither the name of Oancea Aurelian nor the names of his contributors may
+//   * Neither the name of Aurelian Oancea nor the names of his contributors may
 //   be used to endorse or promote products derived from this software without
 //   specific prior written permission.
 //
@@ -52,7 +52,7 @@
      * @return string the medick version
      */
     public static function getVersion() {
-        return '0.4.1-svn';
+        return '0.4.1';
     }
 
 }

Modified: trunk/libs/medick/Object.php
===================================================================
--- trunk/libs/medick/Object.php	2007-08-01 14:57:17 UTC (rev 451)
+++ trunk/libs/medick/Object.php	2007-08-15 08:06:49 UTC (rev 452)
@@ -2,7 +2,7 @@
 // {{{ License
 // ///////////////////////////////////////////////////////////////////////////////
 //
-// Copyright (c) 2005 - 2007 Oancea Aurelian &lt; aurelian [ at ] locknet [ dot ] ro &gt;
+// Copyright (c) 2005 - 2007 Aurelian Oancea &lt; aurelian [ at ] locknet [ dot ] ro &gt;
 //
 // Redistribution and use in source and binary forms, with or without
 // modification, are permitted provided that the following conditions are met:
@@ -12,7 +12,7 @@
 //   * Redistributions in binary form must reproduce the above copyright notice,
 //   this list of conditions and the following disclaimer in the documentation
 //   and/or other materials provided with the distribution.
-//   * Neither the name of Oancea Aurelian nor the names of his contributors may
+//   * Neither the name of Aurelian Oancea nor the names of his contributors may
 //   be used to endorse or promote products derived from this software without
 //   specific prior written permission.
 //
@@ -102,3 +102,27 @@
 class MedickMethod extends ReflectionMethod {}
 
 class MedickProperty extends ReflectionProperty {}
+
+/**
+ * &quot;Benchmark&quot; tool
+ *
+ * &lt;code&gt;
+ *  $t= new MTimer();
+ *  $t-&gt;stop();
+ * &lt;/code&gt;
+ *
+ * @since 0.4.1
+ * @package medick.core
+ *
+ */ 
+class MTimer extends Object {
+  private $start;
+  public function MTimer() {
+    $this-&gt;start= microtime(true);
+  }
+  public function stop() {
+    return microtime(true) - $this-&gt;start;
+  }
+}
+
+

Modified: trunk/libs/medick/util.php
===================================================================
--- trunk/libs/medick/util.php	2007-08-01 14:57:17 UTC (rev 451)
+++ trunk/libs/medick/util.php	2007-08-15 08:06:49 UTC (rev 452)
@@ -2,7 +2,7 @@
 // {{{ License
 // ///////////////////////////////////////////////////////////////////////////////
 //
-// Copyright (c) 2005 - 2007 Oancea Aurelian &lt; aurelian [ at ] locknet [ dot] ro &gt;
+// Copyright (c) 2005 - 2007 Aurelian Oancea &lt; aurelian [ at ] locknet [ dot] ro &gt;
 //
 // Redistribution and use in source and binary forms, with or without
 // modification, are permitted provided that the following conditions are met:
@@ -12,7 +12,7 @@
 //   * Redistributions in binary form must reproduce the above copyright notice,
 //   this list of conditions and the following disclaimer in the documentation
 //   and/or other materials provided with the distribution.
-//   * Neither the name of Oancea Aurelian nor the names of his contributors may
+//   * Neither the name of Aurelian Oancea nor the names of his contributors may
 //   be used to endorse or promote products derived from this software without
 //   specific prior written permission.
 //


</PRE>

<!--endarticle-->
    <HR>
    <P><UL>
        <!--threads-->
	<LI>Previous message: <A HREF="000231.html">[Medick-svn] r451 - in trunk: . libs/action/controller	libs/action/controller/http
</A></li>
	<LI>Next message: <A HREF="000233.html">[Medick-svn] r453 - in exp: . ar5
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#232">[ date ]</a>
              <a href="thread.html#232">[ thread ]</a>
              <a href="subject.html#232">[ subject ]</a>
              <a href="author.html#232">[ author ]</a>
         </LI>
       </UL>

<hr>
<a href="https://lists.berlios.de/mailman/listinfo/medick-svn">More information about the Medick-svn
mailing list</a><br>
</body></html>
