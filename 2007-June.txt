From aurelian at mail.berlios.de  Tue Jun 12 16:45:23 2007
From: aurelian at mail.berlios.de (aurelian at BerliOS)
Date: Tue, 12 Jun 2007 16:45:23 +0200
Subject: [Medick-svn] r432 - in trunk: . libs/medick
Message-ID: <200706121445.l5CEjNNh015788@sheep.berlios.de>

Author: aurelian
Date: 2007-06-12 16:45:22 +0200 (Tue, 12 Jun 2007)
New Revision: 432

Modified:
   trunk/CHANGELOG
   trunk/TODO
   trunk/VERSION
   trunk/libs/medick/Medick.php
Log:
 -- bumped version to 0.4, updated todo list and changelog

Modified: trunk/CHANGELOG
===================================================================
--- trunk/CHANGELOG	2007-06-12 14:37:19 UTC (rev 431)
+++ trunk/CHANGELOG	2007-06-12 14:45:22 UTC (rev 432)
@@ -1,7 +1,14 @@
 $Id$
 (*) SVN version
 
-0.3.0pre2-svn (23.Jul.2006)
+0.4 (*)
+    - added HTTPRequest::is_xhr() method
+    - added JSON decode / encode
+    - added after filters for ActionController
+    - changed before_filter to before_filters for ActionController
+    - skeleton for docs in ActionController
+
+0.3.0pre2 (23.Jul.2006)
     - moved database configuration settings from xml configuration file to database.ini  
     - refactored bin/medick.php, now it also includes a overwrite feature
 

Modified: trunk/TODO
===================================================================
--- trunk/TODO	2007-06-12 14:37:19 UTC (rev 431)
+++ trunk/TODO	2007-06-12 14:45:22 UTC (rev 432)
@@ -3,16 +3,15 @@
 Medick TODO list.
 ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
 
-*Plan for 0.3 series*
+refactor && unit-test && documentation
 
     #  ~~ 1. obsolete DatabaseRow (0.3.0) ~~
     #  ~~ 2. expandable validators (0.3.0) ~~
     #  ~~ 3. customizable error messages on validation (0.3.0) ~~
-    #  4. context like (0.3.0)
-    #  5. cheap cache in ActiveRecord
-    #  6. creole moveup: RowsAggregate implements IteratorAggregate vs. ResultSet implement IteratorAggregate
-    #  7. write in associations
-    #  8. scaffolding generator
-    #  9. nice to have: RDBAC, i18n, l10n, caching
-    # 10. refactor && unit-test
-
+    #  4. configurations refactorings (0.4)
+    #  5. cheap cache in ActiveRecord (0.4.1)
+    #  6. PDO common interface to replace Creole later on (0.5)
+    #  7. refactorings: RowsAggregate implements IteratorAggregate vs. ResultSet implement IteratorAggregate (0.5)
+    #  8. write in active record associations (0.6)
+    #  9. nice to have: scaffolding generator (0.5)
+    # 10. nice to have: RDBAC, i18n, l10n, caching (0.7)

Modified: trunk/VERSION
===================================================================
--- trunk/VERSION	2007-06-12 14:37:19 UTC (rev 431)
+++ trunk/VERSION	2007-06-12 14:45:22 UTC (rev 432)
@@ -1 +1 @@
-0.3.0pre3-svn
+0.4-svn

Modified: trunk/libs/medick/Medick.php
===================================================================
--- trunk/libs/medick/Medick.php	2007-06-12 14:37:19 UTC (rev 431)
+++ trunk/libs/medick/Medick.php	2007-06-12 14:45:22 UTC (rev 432)
@@ -52,7 +52,7 @@
      * @return string the medick version
      */
     public static function getVersion() {
-        return '0.3.0pre2-svn';
+        return '0.4-svn';
     }
 
 }



From aurelian at mail.berlios.de  Tue Jun 12 16:37:20 2007
From: aurelian at mail.berlios.de (aurelian at BerliOS)
Date: Tue, 12 Jun 2007 16:37:20 +0200
Subject: [Medick-svn] r431 - in trunk/libs: action/controller
	action/controller/http action/controller/session action/view
	active/record active/support configurator context logger
	logger/formatter medick medick/io
Message-ID: <200706121437.l5CEbKgW015202@sheep.berlios.de>

Author: aurelian
Date: 2007-06-12 16:37:19 +0200 (Tue, 12 Jun 2007)
New Revision: 431

Modified:
   trunk/libs/action/controller/Base.php
   trunk/libs/action/controller/Dispatcher.php
   trunk/libs/action/controller/Injector.php
   trunk/libs/action/controller/Map.php
   trunk/libs/action/controller/Request.php
   trunk/libs/action/controller/Response.php
   trunk/libs/action/controller/Route.php
   trunk/libs/action/controller/Routing.php
   trunk/libs/action/controller/http/Cookie.php
   trunk/libs/action/controller/http/HTTPRequest.php
   trunk/libs/action/controller/http/HTTPResponse.php
   trunk/libs/action/controller/session/CreoleSessionContainer.php
   trunk/libs/action/controller/session/ISessionContainer.php
   trunk/libs/action/controller/session/Session.php
   trunk/libs/action/view/Base.php
   trunk/libs/action/view/HTML.php
   trunk/libs/action/view/JSON.php
   trunk/libs/active/record/Association.php
   trunk/libs/active/record/Base.php
   trunk/libs/active/record/Field.php
   trunk/libs/active/record/QueryBuilder.php
   trunk/libs/active/record/RowsAggregate.php
   trunk/libs/active/record/SQLCommand.php
   trunk/libs/active/record/Validator.php
   trunk/libs/active/support/Inflector.php
   trunk/libs/configurator/IConfigurator.php
   trunk/libs/configurator/INIConfigurator.php
   trunk/libs/configurator/LoggerConfigurator.php
   trunk/libs/configurator/XMLConfigurator.php
   trunk/libs/context/ContextManager.php
   trunk/libs/logger/ILogger.php
   trunk/libs/logger/Logger.php
   trunk/libs/logger/LoggingEvent.php
   trunk/libs/logger/formatter/DefaultFormatter.php
   trunk/libs/logger/formatter/Formatter.php
   trunk/libs/logger/formatter/SimpleFormatter.php
   trunk/libs/medick/ConsoleOptions.php
   trunk/libs/medick/ErrorHandler.php
   trunk/libs/medick/Medick.php
   trunk/libs/medick/Object.php
   trunk/libs/medick/Registry.php
   trunk/libs/medick/io/Folder.php
   trunk/libs/medick/util.php
Log:
 -- more docs for ActionController, more features added

Modified: trunk/libs/action/controller/Base.php
===================================================================
--- trunk/libs/action/controller/Base.php	2007-01-22 07:58:24 UTC (rev 430)
+++ trunk/libs/action/controller/Base.php	2007-06-12 14:37:19 UTC (rev 431)
@@ -35,48 +35,195 @@
 include_once('action/view/Base.php');
 
 /**
- * Base Class For Our Application Controllers
+ * Base Class For User Application Controllers
  *
- * Controller Sample
+ * <h3>Controllers Basics</h3>
+ *
+ * Sample1:
+ *
  * <code>
  *  class ProjectController extends ApplicationController {
+ *     
  *    public function index() {
  *      $this->render_text("Hello Index!");
  *    }
+ *
+ *    public function hello() {
+ *      $this->date= date('%Y-%m-%d');
+ *      // similar with this:
+ *      // $this->template->assign('date', date('%Y-%m-%d'));
+ *    }
+ *
  *  }
  * </code>
- * Valid Controllers will be keept inside the folder app/controllers and will extend
- * ApplicationController or ActionController.
+ * 
+ * The class <em>ProjectController</em> is a Controller for your application.
  *
- * Incoming actions should be declared as public methods inside the ActionController.
- * Keep your helper methods as protected or private since one could somehow find 
- * the URL to invoke them.
+ * To hava a valid Controller you need to:
  *
- * Inside ApplicationController (usualy is the base class for your application controllers)
- * a method named <i>__common</i> is always invoked before the action itself. You can use this
- * method for assing template variables common to all your templates (like a menu with items from database).
+ * 1. name your Controller class with <em>${Name}Controller</em>, eg: ProjectController, UserController, MainController
  *
+ * 2. extend ApplicationController or ActionController
+ *
+ * 3. save the Controller class file as <em>${name}_controller.php</em> 
+ * inside <em>app/controllers</em> folder, eg: app/controllers/project_controller.php
+ *
+ * Each application can have a base ApplicationController defined in <em>app/controllers/application.php</em>.
+ * Using inheritance other Controllers can use methods defined in ApplicationController.
+ *
+ * In the above sample, <em>index</em> and <em>hello</em> methods represents an Action.
+ * Using the medick Routing system, incoming requests are mapped to an action. 
+ * In fact, every public method inside your Controllers are Actions that can be executed 
+ * invoking the proper URL in the browser.
+ *
+ * To protect your data and to avoid strange behaviors in your application, keep any other method
+ * that do not represents an Action as protected or private.
+ *
+ * Back to Sample1, the method <em>index</em> inside <em>ProjectController</em> class 
+ * is mapped to a Request with this form:
+ *
+ * <pre>
+ *  /project/index
+ *  /project/index.html
+ *  /project.html
+ * </pre>
+ *
+ * while the <em>hello</em> action will be invoked when the Request URL is:
+ *
+ * <pre>
+ *   /project/hello.html
+ *   /project/hello
+ * </pre>
+ *
+ * <h3>Building a Response, the View</h3>
+ *
+ * After the Action is executed, medick will build a Response object that later on will be 
+ * passed to the user agent. This object is build using the rendering system.
+ * 
+ * By default, medick will try to load and parse - using a template engine system - 
+ * a View located inside the folder app/views/CONTROLLER/ACTION.phtml.
+ *
+ * A View is the place where you should write client-side code or the place 
+ * where you should use variables defined in the Controller.
+ *
+ * The default template engine system is a pure PHP implementation, this way you can use PHP syntax
+ * for whatever operations you need without learning or debuging code that you are not familiar with it.
+ * On medick users request, other systems could be integrated into the framework. 
+ * And I'm thinking about Smarty or PHPTAL.
+ *
+ * Inside of an Action, the user can define <em>template variables</em>. A template variable is a
+ * PHP variable that will be available in the Views.
+ * To define such a variable, you can access <em>assign</em> method on the template object 
+ * - witch is the recommended way to do it - or, you can use the PHP magick (already implemented):
+ *
+ * <code>
+ *  $this->template->assing('variable_name', 'variable_value');
+ * </code>
+ * or:
+ * <code>
+ *  $this->variable_name = variable_value;
+ * </code>
+ * 
+ * Later on, in the View, you can access the <em>variable_name</em> using <em>$variable_name</em> syntax.
+ *
+ * <h3>Anatomy of a medick Request</h3>
+ *
+ * Order of the invoked methods:
+ * [Medick Framework]: instantiate --> load_models --> 
+ * [User Controller]: __common --> before_filters --> action --> after_filters
+ * 
+ * <h4>Loading Models</h4>
+ *
+ * A Controller is the place where we indicate what Models we need. 
+ * We do this by defining a <em>models</em> instance variable.
+ *
+ * Sample2:
+ * <code>
+ * class ProjectController extends ApplicationController {
+ *      protected $models= array('project', 'user');
+ *     // same as:
+ *     // protected $models = 'project, user';
+ *
+ *     // lists available projects
+ *     public function show() {
+ *          $this->template->assign('projects', Project::find());
+ *     }
+ *
+ * }
+ * </code>
+ *
+ * The framework will know how to include the requested models and how to perform basic checks on them.
+ *
+ * <h4>Need a constructor?</h4>
+ *
+ * Since you might need some sort of contructor for your Controller, but defining one might lead to
+ * confusions on the system, medick introduced a magick method: <em>__common</em> 
+ * that it's invoked after the Controller is ready.
+ * Not a real constructor, but the <em>__common</em> method can be used to perform all kind of initializations that
+ * one needs.
+ *
+ * Sample3:
+ * <code>
+ * class ProjectController extends ApplicationController {
+ *     private $base_project;
+ *     protected $models = 'project, user';
+ *
+ *     protected function __common() {
+ *          $this->base_project= Project::find('first');
+ *     }
+ *
+ *     public function sub_projects() {
+ *          $p= Project::find('all', array('conditions'=>"parent_id=" . $this->base_project->id));
+ *          $this->template->assign('projects', $p);
+ *     }
+ * }
+ * </code>
+ *
+ * <h4>ActionController filters</h4>
+ * 
+ * <h3>Available Objects</h3>
+ * 
+ * <h4>Accessing the Request parameters</h4>
+ *
+ * <h4>Session</h4>
+ *
+ * <h4>Respose tunning</h4>
+ *
+ * <h4>Using Logger</h4>
+ *
+ * <h4>Accessing custom confguration</h4>
+ *
+ * <h3>Pre-defined template variables</h3>
+ *
  * ActionController also defines some magic medick template variables. We will use <b>__</b> to mark them.
  * Predefined medick variables available in templates:
  * <ul>
  *  <li>__base: the document root</li>
  *  <li>__server_name: this server name</li>
  *  <li>__controller: incoming controller</li>
- *  <li>__action: curent action</li>
+ *  <li>__action: current action</li>
  *  <li>__version: medick version</li>
  * </ul>
  * 
- * Other features:
- * <ul>
- *  <li>flash() method can keep anything in session for the next controller, after that the flash container is discarded</li>
- *  <li>unified look and feel for your application by using layouts</li>
- *  <li>straight access to ActionView</li>
- *  <li>filters (this is still a work in progress)</li>
- *  <li>logging capabilities</li>
- * </ul>
+ * <h3>Other features</h3>
+ *
+ * <h4>flash!</h4> 
+ *  
+ * method can keep anything in session for the next controller, after that the flash container is discarded
  * 
+ * <h4>layouts</h4>
+ * 
+ * unified look and feel for your application using layouts
+ *
+ * <h4>redirects</h4>
+ *
+ * <h3>Missing features</h3>
+ *
+ * 
+ *
+ * 
  * @package medick.action.controller
- * @author Oancea Aurelian
+ * @author Aurelian Oancea
  */
 class ActionController extends Object {
 
@@ -126,9 +273,13 @@
 
     /** @var array
         before_filters array */
-    protected $before_filter= array();
+    protected $before_filters= array();
 
     /** @var array
+        after_filters array */
+    protected $after_filters= array();    
+
+    /** @var array
         list of models */
     protected $models= array();
 
@@ -178,14 +329,20 @@
      * @param Response response, the response
      * @return Response
      */
-    public function process(Request $request, Response $response) {
+    public final function process(Request $request, Response $response) {
         $this->instantiate($request, $response);
-        $this->add_models();
-        $this->add_before_filters();
-        $this->perform_action($request->getParameter('action'));
+        $this->load_models();
+        $this->__common();
+        $this->execute_before_filters();
+        $this->perform_action( $request->getParameter('action') );
+        $this->execute_after_filters();
         return $response;
     }
 
+    // {{{ callbacks
+    protected function __common() {  }
+    // }}}
+
     // {{{ renders.
 
     /**
@@ -483,12 +640,11 @@
         $this->template->assign('__action', $this->params['action']);
         // $this->logger->debug('Action:: ' . strtolower($action_name));
         // quickly load the common magick method.
-        if ($_common= $this->createMethod('__common')) {
-            $_common->invoke($this);
-        }
+        // if ($_common= $this->createMethod('__common')) {
+        //     $_common->invoke($this);
+        // }
         // invoke the action.
         $action->invoke($this);
-
         if ($this->action_performed) return;
         $this->render();
     }
@@ -503,7 +659,7 @@
      *    protected before_filter = array('authenticate');
      *    // an action
      *    public function index() {
-     *      return News::find_all();
+     *      $this->news= News::find_all();
      *    }
      *    // Notes: 1) use protected for internal filters
      *    // 2) a filter must return void, in case of a failure,
@@ -515,32 +671,40 @@
      * </code>
      * @throws MedickException if the definition of the before filter is wrong
      */
-    private function add_before_filters() {
-        if (!is_array($this->before_filter)) {
-            throw new MedickException(
-                $this->getClassName() . '->$before_filter should be an array
-                    of strings, each string representing a protected method name');
-        }
-        foreach($this->before_filter as $filter_name) {
-            if (!$filter= $this->createMethod($filter_name)) {
-                throw new MedickException('Cannot load filter: ' . $this->getClassName() . '::' . $filter_name . 
-                                    ' Call to undefined method: ' .$this->getClassName() . '::' . $filter_name);
+    private function execute_before_filters() {
+        $this->execute_filters( $this->before_filters );
+    }
+    
+    private function execute_after_filters() {
+        $this->execute_filters( $this->after_filters );
+    }
+
+    private function execute_filters( $filters ) {
+        if(!is_array($filters)) $filters = explode(',', $filters);
+        foreach($filters as $name) {
+            $name= trim($name);
+            // try to create the method
+            if(!$filter= $this->createMethod( $name )) {
+                $this->logger->warn(sprintf('[Medick] >> Cannot laod filter %s::%s, call to undefined method.',
+                    $this->getClassName(),$name));
+                continue;                
             }
             // a filter should be declared as protected.
             if (!$filter->isProtected()) {
-                throw new MedickException(
-                    'Your filter,``'. $filter_name . '" is declared as a
-                        public method of class ``' . $this->getClassName() .'" !');
+                $this->logger->warn('[Medick] >> Your filter, '. $name . ' is not declared as a
+                    protected method for class ' . $this->getClassName() .', so it cannot be executed.');
+                continue;
             }
-            // we cannot use invoke since the filter is not public
-            $this->$filter_name();
+            $this->logger->debug('[Medick] >> Executing filter ' . $name. '.');
+            $this->$name();
+            // $this->logger->debug('[Medick] >> Filter ' . $name . ' executed.');
         }
     }
 
     /**
      * Injects model names into ActiveRecordBase by using the ModelInjector.
      */
-    private function add_models() {
+    private function load_models() {
         if (!is_array($this->models)) {
             $this->models= explode(',',$this->models);
         }
@@ -566,7 +730,7 @@
         try {
             return new ReflectionMethod($this, strtolower($method_name));
         } catch (ReflectionException $rEx) {
-            $this->logger->info($rEx->getMessage());
+            // $this->logger->info($rEx->getMessage());
             return FALSE;
         }
     }

Modified: trunk/libs/action/controller/Dispatcher.php
===================================================================
--- trunk/libs/action/controller/Dispatcher.php	2007-01-22 07:58:24 UTC (rev 430)
+++ trunk/libs/action/controller/Dispatcher.php	2007-06-12 14:37:19 UTC (rev 431)
@@ -44,10 +44,10 @@
 /**
  * It knows how to dispatch a request
  * 
- * The role of this class will increase in the next versions.
+ * It reads the configuration file and loads the application routes
  *
  * @package medick.action.controller
- * @author Oancea Aurelian
+ * @author Aurelian Oancea
  */
 class Dispatcher extends Object {
 
@@ -69,14 +69,14 @@
             $configurator= $this->manager->getConfigurator();
             Registry::put($configurator, '__configurator');
             Registry::put($logger= new Logger($configurator), '__logger');
-            $logger->debug('Config File: ' . $configurator->getConfigFile());
-            $ap= $configurator->getApplicationPath();
-            $an= $configurator->getApplicationName();
-            $logger->debug("{app.name} -> $an");
+            $ap= $configurator->getApplicationPath(); // application path
+            $an= $configurator->getApplicationName(); // application name
+            $logger->debug('[Medick] >> version: ' . Medick::getVersion() . ' ready for ' . $an);
+            $logger->debug('[Medick] >> Application path ' . $ap);
             $routes_path= $ap . DIRECTORY_SEPARATOR . 'conf' . DIRECTORY_SEPARATOR . $an . '.routes.php';
-            include_once($routes_path);
-            $logger->debug("routes loaded from: $routes_path");
-            $logger->debug("Medick {" . Medick::getVersion() . "} ready to dispatch.");
+            include_once($routes_path); // load routes
+            $logger->debug('[Medick] >> Config File: ' . str_replace($ap, '${'.$an.'}', $configurator->getConfigFile()) );
+            $logger->debug('[Medick] >> Routes loaded from: '. str_replace($ap, '${'.$an.'}', $routes_path));
             ActionControllerRouting::recognize($request)->process($request, $response)->dump();
         } catch (Exception $ex) {
             ActionController::process_with_exception($request, $response, $ex)->dump();

Modified: trunk/libs/action/controller/Injector.php
===================================================================
--- trunk/libs/action/controller/Injector.php	2007-01-22 07:58:24 UTC (rev 430)
+++ trunk/libs/action/controller/Injector.php	2007-06-12 14:37:19 UTC (rev 431)
@@ -40,6 +40,7 @@
  * Aditional using php reflection api, it validates the user classes
  *
  * @package medick.action.controller
+ * @author Aurelian Oancea
  */
 class Injector extends Object {
 
@@ -126,14 +127,17 @@
      * @return void
      * @access protected
      */
-    protected function injectModel($name) {
+    protected function injectModel( $name ) {
         $location= $this->path['models'] . $name . '.php';
-        $this->logger->debug('Model: ' . $location);
+        
+        $this->logger->debug( '[Medick] >> Loading Model ' . ucfirst( $name ) . ' from ' . 
+            str_replace( $this->config->getApplicationPath(), '${'. $this->config->getApplicationName() .'}', $location) );
+
         $this->includeFile($location, ucfirst($name));
         $model_class_name= Inflector::camelize($name);
         try {
             $model_object = new ReflectionClass($model_class_name);
-
+            // XXX @USE
             if (@$model_object->getParentClass()->name != 'ActiveRecord') {
                 throw new InjectorException (
                     'Wrong Definition of user Model, `' . $model_class_name . '`, it must extend ActiveRecord object!');
@@ -144,7 +148,8 @@
             $method= $model_object->getMethod('find');
             if (!$method->isStatic() && !$method->isPublic()) {
                 throw new InjectorException (
-                    'Class method: ' . $model_class_name . '::find([mixed arguments]) should be declared as static and public!');
+                    'Class method: ' . $model_class_name . '::find([mixed arguments]) 
+                        should be declared as static and public!');
             }
         } catch (ReflectionException $rEx) {
             throw new InjectorException (
@@ -176,6 +181,7 @@
 
         try {
             $controller_class = new ReflectionClass($clazz);
+            // XXX @USE
             if (
                 ($controller_class->isInstantiable())
                 &&
@@ -206,10 +212,11 @@
      * @return void
      * @access private
      */
-    protected function injectHelper($location) {
-        $helper_file= $this->path['helpers'] . $location . '_helper.php';
-        $this->logger->debug('Helper: ' . $helper_file);
-        return $this->includeFile($helper_file, $location . '_helper.php');
+    protected function injectHelper($name) {
+        $helper_file= $this->path['helpers'] . $name . '_helper.php';
+        $this->logger->debug('[Medick] >> Lading Helper ' . $name . ' from ' .
+            str_replace( $this->config->getApplicationPath(), '${'. $this->config->getApplicationName() .'}', $helper_file) );
+        return $this->includeFile($helper_file, $name . '_helper.php');
     }
 
     /**
@@ -221,6 +228,7 @@
      * @access private
      */
     private function includeFile($location, $failure_message) {
+        // XXX @USE
         if(!@file_exists($location) ) {
             throw new FileNotFoundException('Cannot load : `' . $failure_message .'`. Searched in: `' . $location . '`');
         } else {

Modified: trunk/libs/action/controller/Map.php
===================================================================
--- trunk/libs/action/controller/Map.php	2007-01-22 07:58:24 UTC (rev 430)
+++ trunk/libs/action/controller/Map.php	2007-06-12 14:37:19 UTC (rev 431)
@@ -37,7 +37,7 @@
  * 
  * @package medick.action.controller
  * @subpackage routing
- * @author Oancea Aurelian
+ * @author Aurelian Oancea
  */
 class Map extends Collection {
 

Modified: trunk/libs/action/controller/Request.php
===================================================================
--- trunk/libs/action/controller/Request.php	2007-01-22 07:58:24 UTC (rev 430)
+++ trunk/libs/action/controller/Request.php	2007-06-12 14:37:19 UTC (rev 431)
@@ -40,7 +40,7 @@
  * Contains various informations about the Request Parameters
  * @see HTTPRequest, Dispatcher, Route
  * @package medick.action.controller
- * @author Oancea Aurelian
+ * @author Aurelian Oancea
  */
 class Request extends Object {
 

Modified: trunk/libs/action/controller/Response.php
===================================================================
--- trunk/libs/action/controller/Response.php	2007-01-22 07:58:24 UTC (rev 430)
+++ trunk/libs/action/controller/Response.php	2007-06-12 14:37:19 UTC (rev 431)
@@ -40,7 +40,7 @@
  * A Dispatcher will know how to dump the buffer of this response back to the user.
  * 
  * @package medick.action.controller
- * @author Oancea Aurelian
+ * @author Aurelian Oancea
  */
 class Response extends Object {
     

Modified: trunk/libs/action/controller/Route.php
===================================================================
--- trunk/libs/action/controller/Route.php	2007-01-22 07:58:24 UTC (rev 430)
+++ trunk/libs/action/controller/Route.php	2007-06-12 14:37:19 UTC (rev 431)
@@ -38,7 +38,7 @@
  * @see Route
  * @package medick.action.controller
  * @subpackage routing
- * @author Oancea Aurelian
+ * @author Aurelian Oancea
  */
 class Component extends Object {
 
@@ -115,6 +115,7 @@
  *  $request->getParameter('action'); // => view
  *  $request->getParameter('id'); // => 12
  * </code>
+ *
  * @see Map, ActionControllerRouting, Component
  * @todo more docs
  * @package medick.action.controller
@@ -333,7 +334,7 @@
     public function createControllerInstance(Request $request) {
         if (!$this->isLoaded) $this->load($request);
         try {
-            // Registry::get('__logger')->debug($this->toString());
+            // Registry::get('__logger')->debug('[Medick] >> found ' . $this->toString());
             return Registry::put(new Injector(), '__injector')->inject('controller', $request->getParameter('controller'));
         } catch (FileNotFoundException $fnfEx) {
             throw new RoutingException('Cannot create a controller instance, ' . $fnfEx->getMessage());

Modified: trunk/libs/action/controller/Routing.php
===================================================================
--- trunk/libs/action/controller/Routing.php	2007-01-22 07:58:24 UTC (rev 430)
+++ trunk/libs/action/controller/Routing.php	2007-06-12 14:37:19 UTC (rev 431)
@@ -39,7 +39,7 @@
  * 
  * @package medick.action.controller
  * @subpackage routing
- * @author Oancea Aurelian
+ * @author Aurelian Oancea
  */
 class ActionControllerRouting extends Object {
 

Modified: trunk/libs/action/controller/http/Cookie.php
===================================================================
--- trunk/libs/action/controller/http/Cookie.php	2007-01-22 07:58:24 UTC (rev 430)
+++ trunk/libs/action/controller/http/Cookie.php	2007-06-12 14:37:19 UTC (rev 431)
@@ -33,9 +33,11 @@
 // }}}
 
 /**
- * 
+ * It's a HTTPCookie 
+ *
  * @package medick.action.controller
  * @subpackage http
+ * @author Aurelian Oancea
  */
 
 class Cookie extends Object {

Modified: trunk/libs/action/controller/http/HTTPRequest.php
===================================================================
--- trunk/libs/action/controller/http/HTTPRequest.php	2007-01-22 07:58:24 UTC (rev 430)
+++ trunk/libs/action/controller/http/HTTPRequest.php	2007-06-12 14:37:19 UTC (rev 431)
@@ -40,7 +40,7 @@
  *
  * @package medick.action.controller
  * @subpackage http
- * @author Oancea Aurelian
+ * @author Aurelian Oancea
  */
 class HTTPRequest extends Request {
 
@@ -123,6 +123,15 @@
     }
     
     /**
+     * Check if this Request was made with an AJAX call (Xhr)
+     *
+     * @return bool true if it was Xhr
+     */ 
+    public function isXhr() {
+      return isset($_SERVER['HTTP_X_REQUESTED_WITH']) && ($_SERVER['HTTP_X_REQUESTED_WITH'] == 'XMLHttpRequest');
+    }    
+    
+    /**
      * Gets an array of Cookies
      *
      * @return array

Modified: trunk/libs/action/controller/http/HTTPResponse.php
===================================================================
--- trunk/libs/action/controller/http/HTTPResponse.php	2007-01-22 07:58:24 UTC (rev 430)
+++ trunk/libs/action/controller/http/HTTPResponse.php	2007-06-12 14:37:19 UTC (rev 431)
@@ -37,7 +37,7 @@
  *
  * @package medick.action.controller
  * @subpackage http
- * @author Oancea Aurelian
+ * @author Aurelian Oancea
  */
 class HTTPResponse extends Response {
 

Modified: trunk/libs/action/controller/session/CreoleSessionContainer.php
===================================================================
--- trunk/libs/action/controller/session/CreoleSessionContainer.php	2007-01-22 07:58:24 UTC (rev 430)
+++ trunk/libs/action/controller/session/CreoleSessionContainer.php	2007-06-12 14:37:19 UTC (rev 431)
@@ -50,7 +50,7 @@
  *  
  * @package medick.action.controller
  * @subpackage session
- * @author Oancea Aurelian 
+ * @author Aurelian Oancea
  */
 class CreoleSessionContainer extends Object implements ISessionContainer {
  

Modified: trunk/libs/action/controller/session/ISessionContainer.php
===================================================================
--- trunk/libs/action/controller/session/ISessionContainer.php	2007-01-22 07:58:24 UTC (rev 430)
+++ trunk/libs/action/controller/session/ISessionContainer.php	2007-06-12 14:37:19 UTC (rev 431)
@@ -50,12 +50,13 @@
  *  session.MyFileSessionContainer
  * </code>
  * since the <em>_your_application_/libs</em> folder is under <em>include path</em>
+ *
  * @see http://php.net/manual/en/function.session-set-save-handler.php
  * @see Session
  * @see ActionController
  * @package medick.action.controller
  * @subpackage session
- * @author Oancea Aurelian
+ * @author Aurelian Oancea
  */
 interface ISessionContainer {
 

Modified: trunk/libs/action/controller/session/Session.php
===================================================================
--- trunk/libs/action/controller/session/Session.php	2007-01-22 07:58:24 UTC (rev 430)
+++ trunk/libs/action/controller/session/Session.php	2007-06-12 14:37:19 UTC (rev 431)
@@ -37,7 +37,7 @@
  *
  * @package medick.action.controller
  * @subpackage session
- * @author Oancea Aurelian
+ * @author Aurelian Oancea
  */
 class Session extends Object {
 

Modified: trunk/libs/action/view/Base.php
===================================================================
--- trunk/libs/action/view/Base.php	2007-01-22 07:58:24 UTC (rev 430)
+++ trunk/libs/action/view/Base.php	2007-06-12 14:37:19 UTC (rev 431)
@@ -37,7 +37,7 @@
 /**
  *
  * @package medick.action.view
- * @author Oancea Aurelian
+ * @author Aurelian Oancea
  */
 interface ITemplateEngine {
     public function render_partial($controller, $partial);
@@ -48,34 +48,15 @@
 /**
  *
  * @package medick.action.view
- * @author Oancea Aurelian
+ * @author Aurelian Oancea
  */
 class ActionView extends Object {
 
-    public static function factory($engine) {
+    public static function factory( $engine ) {
         $clazz= strtoupper($engine) . 'TemplateEngine';
         return new $clazz;
     }
-
-    /**
-     * Strips slashes, method called recursive
-     *
-     * @todo Move this OUT of this class, or, in __set.
-     * @todo What if $value is Object?
-     * @param mixed value, the value on witch we strip slashes.
-     *                  It can be array/string or object.
-     */
-     
-    /* public static function stripslashes_deep($value) {
-        if (is_array($value)) {
-            array_map(array('ActionView','stripslashes_deep'), $value);
-        } elseif (is_object($value)) {
-
-        } else {
-            stripslashes($value);
-        }
-        return $value;
-     } */ 
+    
 }
 
 /**
@@ -85,7 +66,7 @@
  * may share the same name and behavior
  *
  * @package medick.action.view
- * @author Oancea Aurelian
+ * @author Aurelian Oancea
  */
 class PHPTemplateEngine extends Object implements ITemplateEngine {
 

Modified: trunk/libs/action/view/HTML.php
===================================================================
--- trunk/libs/action/view/HTML.php	2007-01-22 07:58:24 UTC (rev 430)
+++ trunk/libs/action/view/HTML.php	2007-06-12 14:37:19 UTC (rev 431)
@@ -33,9 +33,10 @@
 // }}}
 
 /**
+ *
  * @package medick.action.view
  * @subpackage helpers
- * @author Oancea Aurelian
+ * @author Aurelian Oancea
  */
 class ActiveRecordHelper extends Object {
 
@@ -104,7 +105,7 @@
  * @package medick.action.view
  * @subpackage helpers
  * @see http://api.rubyonrails.com/classes/ActionView/Helpers/FormHelper.html
- * @author Oancea Aurelian
+ * @author Aurelian Oancea
  */
 class FormHelper extends Object {
 
@@ -218,7 +219,7 @@
  *
  * @package medick.action.view
  * @subpackage helpers
- * @author Oancea Aurelian
+ * @author Aurelian Oancea
  */
 class URL extends Object {
 
@@ -247,7 +248,7 @@
  * @package medick.action.view
  * @subpackage helpers
  * @deprecated use FormHelper since it provides more features
- * @author Oancea Aurelian
+ * @author Aurelian Oancea
  */
 class Form extends Object {
 

Modified: trunk/libs/action/view/JSON.php
===================================================================
--- trunk/libs/action/view/JSON.php	2007-01-22 07:58:24 UTC (rev 430)
+++ trunk/libs/action/view/JSON.php	2007-06-12 14:37:19 UTC (rev 431)
@@ -36,44 +36,51 @@
  *
  * @package medick.action.view
  * @subpackage Json
+ * @author Aurelian Oancea
  */
 class JSON extends Object {
 
   public static function encode($value) {
-    if (is_array($value)) return JSON::array_encode($value);
-    else return JSON::scalar_encode($value);
+      if(function_exists('json_encode')) return json_encode($value);
+      if (is_array($value)) return JSON::array_encode($value);
+      else return JSON::scalar_encode($value);
   }
+  
+  public static function decode($value) {
+      if(function_exists('json_decode')) return json_decode($value);
+      throw new MedickException('JSON::decode(string $value) method is not implemented.')
+  }
 
   public static function array_encode(Array $value) {
-    $tmp= array();
+      $tmp= array();
 
-    if ( array_keys($value) !== range(0, sizeof($value) - 1) ) {
-      foreach ($value as $k=>$v) {
-        $tmp[]= JSON::string_encode((string)$k) . ' : ' . JSON::encode($v);
+      if ( array_keys($value) !== range(0, sizeof($value) - 1) ) {
+          foreach ($value as $k=>$v) {
+              $tmp[]= JSON::string_encode((string)$k) . ' : ' . JSON::encode($v);
+          }
+          return '{' . join(', ', $tmp) . '}';
       }
-      return '{' . join(', ', $tmp) . '}';
-    }
 
-    for ($i= 0; $i < sizeof($value); $i++) {
-      $tmp[]= JSON::encode($value[$i]);
-    }
-    return '['. join(', ', $tmp) . ']';
+      for ($i= 0; $i < sizeof($value); $i++) {
+          $tmp[]= JSON::encode($value[$i]);
+      }
+      return '['. join(', ', $tmp) . ']';
   }
 
   public static function scalar_encode($value) {
-    if     (is_numeric($value)) return (string)$value;
-    elseif (is_string($value))  return JSON::string_encode($value);
-    elseif (is_bool($value))    return $value ? 'true' : 'false';
-    elseif (is_null($value))    return 'null';
-    else throw new MedickException($value . ' is not a scalar!');
+      if     (is_numeric($value)) return (string)$value;
+      elseif (is_string($value))  return JSON::string_encode($value);
+      elseif (is_bool($value))    return $value ? 'true' : 'false';
+      elseif (is_null($value))    return 'null';
+      else throw new MedickException($value . ' is not a scalar!');
   }
 
   public static function string_encode($string) {
-    $search  = array('\\', "\n", "\t", "\r", "\b", "\f", '"');
-    $replace = array('\\\\', '\\n', '\\t', '\\r', '\\b', '\\f', '\"');
-    $string  = str_replace($search, $replace, $string);
-    $string = str_replace(array(chr(0x08), chr(0x0C)), array('\b', '\f'), $string);
-    return '"' . $string . '"';
+      $search  = array('\\', "\n", "\t", "\r", "\b", "\f", '"');
+      $replace = array('\\\\', '\\n', '\\t', '\\r', '\\b', '\\f', '\"');
+      $string  = str_replace($search, $replace, $string);
+      $string = str_replace(array(chr(0x08), chr(0x0C)), array('\b', '\f'), $string);
+      return '"' . $string . '"';
   }
 
 }

Modified: trunk/libs/active/record/Association.php
===================================================================
--- trunk/libs/active/record/Association.php	2007-01-22 07:58:24 UTC (rev 430)
+++ trunk/libs/active/record/Association.php	2007-06-12 14:37:19 UTC (rev 431)
@@ -41,7 +41,7 @@
  * 
  * @package medick.active.record
  * @subpackage association
- * @author Oancea Aurelian
+ * @author Aurelian Oancea
  */
 abstract class Association extends Object {
 
@@ -163,7 +163,7 @@
  *
  * @package medick.active.record
  * @subpackage association
- * @author Oancea Aurelian
+ * @author Aurelian Oancea
  * @since Rev. 272
  */
 class HasManyAssociation extends Association {
@@ -191,7 +191,7 @@
  *
  * @package medick.active.record
  * @subpackage association
- * @author Oancea Aurelian
+ * @author Aurelian Oancea
  * @since Rev. 272
  */
 class HasOneAssociation extends Association {
@@ -227,7 +227,7 @@
  *
  * @package medick.active.record
  * @subpackage association
- * @author Oancea Aurelian
+ * @author Aurelian Oancea
  * @since Rev. 272
  */
 class BelongsToAssociation extends HasOneAssociation {    }
@@ -237,7 +237,7 @@
  * 
  * @package medick.active.record
  * @subpackage association
- * @author Oancea Aurelian
+ * @author Aurelian Oancea
  */
 class HasAndBelongsToManyAssociation extends Association {
 

Modified: trunk/libs/active/record/Base.php
===================================================================
--- trunk/libs/active/record/Base.php	2007-01-22 07:58:24 UTC (rev 430)
+++ trunk/libs/active/record/Base.php	2007-06-12 14:37:19 UTC (rev 431)
@@ -49,7 +49,7 @@
  * Cached Database table information
  * 
  * @package medick.active.record
- * @author Oancea Aurelian
+ * @author Aurelian Oancea
  */ 
 class ActiveRecordTableInfo extends Object {
     static $instance= NULL;
@@ -65,7 +65,7 @@
  * Main ActiveRecord Class
  *
  * @package medick.active.record
- * @author Oancea Aurelian
+ * @author Aurelian Oancea
  */
 abstract class ActiveRecord extends Object {
 
@@ -166,7 +166,8 @@
         try {
             return Association::resolve($this, $name)->execute();
         } catch (AssociationNotFoundException $anfEx) {
-            throw new ActiveRecordException ('Cannot Get the value of filed: `' . $name . '`. No such filed!', $anfEx->getMessage());
+            throw new ActiveRecordException(
+                'Cannot Get the value of filed: `' . $name . '`. No such filed!', $anfEx->getMessage() );
         }
     }
     

Modified: trunk/libs/active/record/Field.php
===================================================================
--- trunk/libs/active/record/Field.php	2007-01-22 07:58:24 UTC (rev 430)
+++ trunk/libs/active/record/Field.php	2007-06-12 14:37:19 UTC (rev 431)
@@ -36,7 +36,7 @@
  * It represents a field from DB
  *
  * @package medick.active.record
- * @author Oancea Aurelian
+ * @author Aurelian Oancea
  */
 class Field extends Object {
 

Modified: trunk/libs/active/record/QueryBuilder.php
===================================================================
--- trunk/libs/active/record/QueryBuilder.php	2007-01-22 07:58:24 UTC (rev 430)
+++ trunk/libs/active/record/QueryBuilder.php	2007-06-12 14:37:19 UTC (rev 431)
@@ -36,7 +36,7 @@
  * It knows how to create a SQLCommand from an array
  *
  * @package medick.active.record
- * @author Oancea Aurelian
+ * @author Aurelian Oancea
  */
 class QueryBuilder extends Object {
 

Modified: trunk/libs/active/record/RowsAggregate.php
===================================================================
--- trunk/libs/active/record/RowsAggregate.php	2007-01-22 07:58:24 UTC (rev 430)
+++ trunk/libs/active/record/RowsAggregate.php	2007-06-12 14:37:19 UTC (rev 431)
@@ -36,7 +36,7 @@
  * Container for DatabaseRow Objects
  * 
  * @package medick.active.record
- * @author Oancea Aurelian
+ * @author Aurelian Oancea
  */
 class RowsAggregate extends Object implements IteratorAggregate {
 

Modified: trunk/libs/active/record/SQLCommand.php
===================================================================
--- trunk/libs/active/record/SQLCommand.php	2007-01-22 07:58:24 UTC (rev 430)
+++ trunk/libs/active/record/SQLCommand.php	2007-06-12 14:37:19 UTC (rev 431)
@@ -46,7 +46,7 @@
  * More methods will be added later-on, API will be provided on request.
  * 
  * @package medick.active.record
- * @author Oancea Aurelian
+ * @author Aurelian Oancea
  * @since Rev. 343
  */
 class SQLCommand extends Object {

Modified: trunk/libs/active/record/Validator.php
===================================================================
--- trunk/libs/active/record/Validator.php	2007-01-22 07:58:24 UTC (rev 430)
+++ trunk/libs/active/record/Validator.php	2007-06-12 14:37:19 UTC (rev 431)
@@ -84,7 +84,7 @@
  * @see ActiveRecord, Field, UniquenessOfValidator, FormatOfValidator, LengthOfValidator, PresenceOfValidator
  * @package medick.active.record
  * @subpackage validator
- * @author Oancea Aurelian
+ * @author Aurelian Oancea
  */ 
 abstract class Validator extends Object {
     
@@ -167,7 +167,7 @@
  * @see Validator, ActiveRecord, Field, preg_match
  * @package medick.active.record
  * @subpackage validator
- * @author Oancea Aurelian
+ * @author Aurelian Oancea
  */
 class FormatOfValidator extends Validator {
     
@@ -221,7 +221,7 @@
  * @see Validator, ActiveRecord, Field
  * @package medick.active.record
  * @subpackage validator
- * @author Oancea Aurelian
+ * @author Aurelian Oancea
  */ 
 class PresenceOfValidator extends Validator {
     
@@ -260,7 +260,7 @@
  * @see Validator, ActiveRecord, Field, is_numeric, intvalue
  * @package medick.active.record
  * @subpackage validator
- * @author Oancea Aurelian
+ * @author Aurelian Oancea
  */ 
 class NumericalityOfValidator extends Validator {
     
@@ -297,7 +297,7 @@
  * @see Validator, ActiveRecord, Field
  * @package medick.active.record
  * @subpackage validator
- * @author Oancea Aurelian
+ * @author Aurelian Oancea
  */ 
 class UniquenessOfValidator extends Validator {
     
@@ -352,7 +352,7 @@
  * @see Validator, ActiveRecord, Field
  * @package medick.active.record
  * @subpackage validator
- * @author Oancea Aurelian
+ * @author Aurelian Oancea
  */ 
 
 class LengthOfValidator extends Validator {
@@ -450,4 +450,3 @@
     }
 
 }
-

Modified: trunk/libs/active/support/Inflector.php
===================================================================
--- trunk/libs/active/support/Inflector.php	2007-01-22 07:58:24 UTC (rev 430)
+++ trunk/libs/active/support/Inflector.php	2007-06-12 14:37:19 UTC (rev 431)
@@ -36,6 +36,7 @@
  * Convenient methods to work on english words 
  * Based on: http://dev.rubyonrails.com/file/trunk/activesupport/lib/active_support/inflections.rb
  * @package medick.active.support
+ * @author Aurelian Oancea
  */
 
 class Inflector extends Object {

Modified: trunk/libs/configurator/IConfigurator.php
===================================================================
--- trunk/libs/configurator/IConfigurator.php	2007-01-22 07:58:24 UTC (rev 430)
+++ trunk/libs/configurator/IConfigurator.php	2007-06-12 14:37:19 UTC (rev 431)
@@ -53,7 +53,7 @@
  * @package medick.configurator
  * @see XMLConfigurator
  * @see LoggerConfigurator
- * @author Oancea Aurelian
+ * @author Aurelian Oancea
  */
 interface IConfigurator {
 

Modified: trunk/libs/configurator/INIConfigurator.php
===================================================================
--- trunk/libs/configurator/INIConfigurator.php	2007-01-22 07:58:24 UTC (rev 430)
+++ trunk/libs/configurator/INIConfigurator.php	2007-06-12 14:37:19 UTC (rev 431)
@@ -39,7 +39,7 @@
  * 
  * @deprecated this class is deprecated, use medick.configurator.XMLConfigurator
  * @package medick.configurator
- * @author Oancea Aurelian
+ * @author Aurelian Oancea
  */
 class INIConfigurator extends Object implements IConfigurator {
 

Modified: trunk/libs/configurator/LoggerConfigurator.php
===================================================================
--- trunk/libs/configurator/LoggerConfigurator.php	2007-01-22 07:58:24 UTC (rev 430)
+++ trunk/libs/configurator/LoggerConfigurator.php	2007-06-12 14:37:19 UTC (rev 431)
@@ -38,7 +38,7 @@
  * A plain Application Configurator
  * 
  * @package medick.configurator
- * @author Oancea Aurelian
+ * @author Aurelian Oancea
  */ 
 class LoggerConfigurator extends Object implements IConfigurator {
     /** @see medick.configurator.IConfigurator::getLoggerOutputters() */

Modified: trunk/libs/configurator/XMLConfigurator.php
===================================================================
--- trunk/libs/configurator/XMLConfigurator.php	2007-01-22 07:58:24 UTC (rev 430)
+++ trunk/libs/configurator/XMLConfigurator.php	2007-06-12 14:37:19 UTC (rev 431)
@@ -40,7 +40,7 @@
  * From medick 0.3.0 this class will be removed due to the new way of configurating a medick application!
  *
  * @package medick.configurator
- * @author Oancea Aurelian
+ * @author Aurelian Oancea
  */
 
 class XMLConfigurator extends Object implements IConfigurator {

Modified: trunk/libs/context/ContextManager.php
===================================================================
--- trunk/libs/context/ContextManager.php	2007-01-22 07:58:24 UTC (rev 430)
+++ trunk/libs/context/ContextManager.php	2007-06-12 14:37:19 UTC (rev 431)
@@ -32,9 +32,12 @@
 //////////////////////////////////////////////////////////////////////////////////
 // }}}
 
+include_once('configurator/XMLConfigurator.php');
+
 /**
  * 
  * @package medick.context
+ * @author Aurelian Oancea
  */
 class ContextManager extends Object {
 
@@ -49,7 +52,6 @@
     }
 
     private function ContextManager($stream, $environment) {
-        include_once('configurator/XMLConfigurator.php');
         $this->configurator= new XMLConfigurator($stream, $environment);
     }
 

Modified: trunk/libs/logger/ILogger.php
===================================================================
--- trunk/libs/logger/ILogger.php	2007-01-22 07:58:24 UTC (rev 430)
+++ trunk/libs/logger/ILogger.php	2007-06-12 14:37:19 UTC (rev 431)
@@ -36,7 +36,7 @@
  * Outputters interface
  * 
  * @package medick.logger
- * @author Oancea Aurelian
+ * @author Aurelian Oancea
  */
 interface ILogger {
 

Modified: trunk/libs/logger/Logger.php
===================================================================
--- trunk/libs/logger/Logger.php	2007-01-22 07:58:24 UTC (rev 430)
+++ trunk/libs/logger/Logger.php	2007-06-12 14:37:19 UTC (rev 431)
@@ -41,7 +41,7 @@
 /**
  * 
  * @package medick.logger
- * @author Oancea Aurelian
+ * @author Aurelian Oancea
  */
 class Logger extends Object implements ILogger {
 

Modified: trunk/libs/logger/LoggingEvent.php
===================================================================
--- trunk/libs/logger/LoggingEvent.php	2007-01-22 07:58:24 UTC (rev 430)
+++ trunk/libs/logger/LoggingEvent.php	2007-06-12 14:37:19 UTC (rev 431)
@@ -36,7 +36,7 @@
  * A logged event object
  * 
  * @package medick.logger
- * @author Oancea Aurelian
+ * @author Aurelian Oancea
  */
 class LoggingEvent extends Object {
 

Modified: trunk/libs/logger/formatter/DefaultFormatter.php
===================================================================
--- trunk/libs/logger/formatter/DefaultFormatter.php	2007-01-22 07:58:24 UTC (rev 430)
+++ trunk/libs/logger/formatter/DefaultFormatter.php	2007-06-12 14:37:19 UTC (rev 431)
@@ -37,7 +37,7 @@
  * 
  * @package medick.logger
  * @subpackage formatter
- * @author Oancea Aurelian
+ * @author Aurelian Oancea
  */
 class DefaultFormatter extends Formatter {
     /** @see medick.logger.formatter.Formatter::format(medick.logger.LoggingEvent event) */

Modified: trunk/libs/logger/formatter/Formatter.php
===================================================================
--- trunk/libs/logger/formatter/Formatter.php	2007-01-22 07:58:24 UTC (rev 430)
+++ trunk/libs/logger/formatter/Formatter.php	2007-06-12 14:37:19 UTC (rev 431)
@@ -37,7 +37,7 @@
  * 
  * @package medick.logger
  * @subpackage formatter
- * @author Oancea Aurelian
+ * @author Aurelian Oancea
  */
 abstract class Formatter extends Object {
     /**
@@ -56,9 +56,9 @@
      */
     protected function extractMessage($message) {
         if(!is_string($message)) $message = print_r($message, TRUE);
-        if (array_key_exists('MEDICK_APPLICATION_PATH', $_SERVER)) {
-            $message= str_replace($_SERVER['MEDICK_APPLICATION_PATH'], "{" . strtoupper($_SERVER['MEDICK_APPLICATION_NAME']) . "}", $message);
-        }
+        // if (array_key_exists('MEDICK_APPLICATION_PATH', $_SERVER)) {
+        //     $message= str_replace($_SERVER['MEDICK_APPLICATION_PATH'], "{" . strtoupper($_SERVER['MEDICK_APPLICATION_NAME']) . "}", $message);
+        // }
         return $message;
     }
 }

Modified: trunk/libs/logger/formatter/SimpleFormatter.php
===================================================================
--- trunk/libs/logger/formatter/SimpleFormatter.php	2007-01-22 07:58:24 UTC (rev 430)
+++ trunk/libs/logger/formatter/SimpleFormatter.php	2007-06-12 14:37:19 UTC (rev 431)
@@ -37,7 +37,7 @@
  * 
  * @package medick.logger
  * @subpackage formatter
- * @author Oancea Aurelian
+ * @author Aurelian Oancea
  */
 class SimpleFormatter extends Formatter {
     /** @see medick.logger.formatter.Formatter::format(medick.logger.LoggingEvent event) */
@@ -46,4 +46,3 @@
             " [ {$event->level} ] >>> {$this->extractMessage($event->message)}";
     }
 }
-

Modified: trunk/libs/medick/ConsoleOptions.php
===================================================================
--- trunk/libs/medick/ConsoleOptions.php	2007-01-22 07:58:24 UTC (rev 430)
+++ trunk/libs/medick/ConsoleOptions.php	2007-06-12 14:37:19 UTC (rev 431)
@@ -52,7 +52,7 @@
  * @see http://www.php.net/manual/en/features.commandline.php
  * @package medick.core
  * @subpackage console
- * @author Oancea Aurelian
+ * @author Aurelian Oancea
  */
 class ConsoleOptions extends Object {
     /** @var array

Modified: trunk/libs/medick/ErrorHandler.php
===================================================================
--- trunk/libs/medick/ErrorHandler.php	2007-01-22 07:58:24 UTC (rev 430)
+++ trunk/libs/medick/ErrorHandler.php	2007-06-12 14:37:19 UTC (rev 431)
@@ -36,7 +36,7 @@
  * The Medick Error Handler.
  *
  * @package medick.core
- * @author Oancea Aurelian
+ * @author Aurelian Oancea
  */
 class ErrorHandler extends Object {
 

Modified: trunk/libs/medick/Medick.php
===================================================================
--- trunk/libs/medick/Medick.php	2007-01-22 07:58:24 UTC (rev 430)
+++ trunk/libs/medick/Medick.php	2007-06-12 14:37:19 UTC (rev 431)
@@ -42,7 +42,7 @@
 /**
  * 
  * @package medick.core
- * @author Oancea Aurelian
+ * @author Aurelian Oancea
  */
 class Medick extends Object {
 

Modified: trunk/libs/medick/Object.php
===================================================================
--- trunk/libs/medick/Object.php	2007-01-22 07:58:24 UTC (rev 430)
+++ trunk/libs/medick/Object.php	2007-06-12 14:37:19 UTC (rev 431)
@@ -36,7 +36,7 @@
  * Base Framework Object
  * 
  * @package medick.core
- * @author Oancea Aurelian
+ * @author Aurelian Oancea
  */
 class Object {
 
@@ -99,10 +99,6 @@
     
 }
 
-class MedickMethod extends ReflectionMethod {
+class MedickMethod extends ReflectionMethod {}
 
-}
-
-class MedickProperty extends ReflectionProperty {
-
-}
+class MedickProperty extends ReflectionProperty {}

Modified: trunk/libs/medick/Registry.php
===================================================================
--- trunk/libs/medick/Registry.php	2007-01-22 07:58:24 UTC (rev 430)
+++ trunk/libs/medick/Registry.php	2007-06-12 14:37:19 UTC (rev 431)
@@ -38,7 +38,7 @@
  * Registry is an object witch holds instances of other objects
  * 
  * @package medick.core
- * @author Oancea Aurelian
+ * @author Aurelian Oancea
  */
 class Registry extends Object {
 

Modified: trunk/libs/medick/io/Folder.php
===================================================================
--- trunk/libs/medick/io/Folder.php	2007-01-22 07:58:24 UTC (rev 430)
+++ trunk/libs/medick/io/Folder.php	2007-06-12 14:37:19 UTC (rev 431)
@@ -38,10 +38,13 @@
  * This is used only when collecting test cases.
  * @package medick.core
  * @subpackage io
- * @author Oancea Aurelian
+ * @author Aurelian Oancea
  */
 class Folder extends Object {
-
+    
+    /**
+     * based on a method from ez-components
+     */
     public static function recursiveFindRelative( $baseDir, $subDir, $suffix ) {
         $returnFiles = array();
         $dir = $baseDir;

Modified: trunk/libs/medick/util.php
===================================================================
--- trunk/libs/medick/util.php	2007-01-22 07:58:24 UTC (rev 430)
+++ trunk/libs/medick/util.php	2007-06-12 14:37:19 UTC (rev 431)
@@ -41,7 +41,7 @@
  *
  * @package medick.core
  * @subpackage util
- * @author Oancea Aurelian
+ * @author Aurelian Oancea
  */
 interface ICollection extends ArrayAccess {
 
@@ -95,7 +95,7 @@
  * An Iterator over a Collection
  * @package medick.core
  * @subpackage util
- * @author Oancea Aurelian
+ * @author Aurelian Oancea
  */
 interface IIterator {
 
@@ -157,7 +157,7 @@
  *
  * @package medick.core
  * @subpackage util
- * @author Oancea Aurelian
+ * @author Aurelian Oancea
  */
 class Collection extends Object implements ICollection {
 
@@ -368,7 +368,7 @@
  *
  * @package medick.core
  * @subpackage util
- * @author Oancea Aurelian
+ * @author Aurelian Oancea
  */
 class CollectionIterator extends Object implements IIterator {
 



From aurelian at mail.berlios.de  Fri Jun 15 10:51:47 2007
From: aurelian at mail.berlios.de (aurelian at BerliOS)
Date: Fri, 15 Jun 2007 10:51:47 +0200
Subject: [Medick-svn] r434 - applications/cookbook/conf
	applications/eltodo/conf applications/testor/conf
	trunk/libs/active/record trunk/libs/configurator trunk/skel/config
Message-ID: <200706150851.l5F8plae014181@sheep.berlios.de>

Author: aurelian
Date: 2007-06-15 10:51:46 +0200 (Fri, 15 Jun 2007)
New Revision: 434

Removed:
   applications/cookbook/conf/database.ini
   applications/eltodo/conf/database.ini
   applications/testor/conf/database.ini
   trunk/skel/config/database.ini
Modified:
   applications/cookbook/conf/cookbook.xml
   applications/eltodo/conf/eltodo.xml
   applications/testor/conf/testor.xml
   trunk/libs/active/record/Base.php
   trunk/libs/configurator/XMLConfigurator.php
   trunk/skel/config/application.xml
Log:
 -- reverting to xml based config file...

Modified: applications/cookbook/conf/cookbook.xml
===================================================================
--- applications/cookbook/conf/cookbook.xml	2007-06-15 07:57:36 UTC (rev 433)
+++ applications/cookbook/conf/cookbook.xml	2007-06-15 08:51:46 UTC (rev 434)
@@ -47,6 +47,14 @@
             </outputters>
         </logger>
         <!-- database(s) settings -->
+        <database default="one">
+            <dsn id = "one"
+                 phptype  = "mysql"
+                 hostspec = "localhost"
+                 database = "cookbook"
+                 username = "root"
+                 password = "" />
+        </database>        
     </environment>
 
     <!-- a sample test environment -->
@@ -57,7 +65,7 @@
         </properties>
         <!-- web context -->
         <web>
-            <server_name>http://exemplu.com</server_name>
+            <server_name>http://exemple.com</server_name>
             <document_root>/cookbook</document_root>
             <rewrite>on</rewrite>
         </web>
@@ -75,6 +83,14 @@
                 </outputter>
             </outputters>
         </logger>
+        <database default="one">
+            <dsn id = "one"
+                 phptype  = "mysql"
+                 hostspec = "localhost"
+                 database = "cookbook"
+                 username = "root"
+                 password = "" />
+        </database>        
     </environment>
   
 </application>

Deleted: applications/cookbook/conf/database.ini
===================================================================
--- applications/cookbook/conf/database.ini	2007-06-15 07:57:36 UTC (rev 433)
+++ applications/cookbook/conf/database.ini	2007-06-15 08:51:46 UTC (rev 434)
@@ -1,34 +0,0 @@
-;
-; $Id$
-;
-
-; 
-; database.ini format:
-; [section] -> environment name
-; phptype -> database connection driver 
-; database -> database name
-; username -> username
-; password -> password
-; Connection flags:
-; persistent=PERSISTENT to mark the connection as beeing persistent
-;
-
-[localhost]
-phptype=mysql
-hostspec=localhost
-database=cookbook
-username=root
-password=virus
-persistent=PERSISTENT
-
-[live]
-phptype=mysql
-hostspec=localhost
-database=cookbook
-username=cookbook
-password=sarl7jKa
-
-[test]
-phptype=sqlite
-database=db/cookbook.sqilte.db
-

Deleted: applications/eltodo/conf/database.ini
===================================================================
--- applications/eltodo/conf/database.ini	2007-06-15 07:57:36 UTC (rev 433)
+++ applications/eltodo/conf/database.ini	2007-06-15 08:51:46 UTC (rev 434)
@@ -1,34 +0,0 @@
-;
-; $Id$
-;
-
-; 
-; database.ini format:
-; [section] -> environment name
-; phptype -> database connection driver 
-; database -> database name
-; username -> username
-; password -> password
-; Connection flags:
-; persistent=PERSISTENT to mark the connection as beeing persistent
-;
-
-[localhost]
-phptype=mysql
-hostspec=localhost
-database=eltodo
-username=root
-password=virus
-
-[live]
-phptype=mysql
-hostspec=localhost
-database=eltodo
-username=root
-password=sol89aNi
-
-[test]
-phptype=sqlite
-hostspec=localhost
-database=db/eltodo.sqilte.db
-

Modified: applications/eltodo/conf/eltodo.xml
===================================================================
--- applications/eltodo/conf/eltodo.xml	2007-06-15 07:57:36 UTC (rev 433)
+++ applications/eltodo/conf/eltodo.xml	2007-06-15 08:51:46 UTC (rev 434)
@@ -29,6 +29,14 @@
                 </outputter>
             </outputters>
         </logger>
+        <database default="one">
+            <dsn id = "one"
+                 phptype  = "mysql"
+                 hostspec = "localhost"
+                 database = "eltodo"
+                 username = "root"
+                 password = "" />
+        </database>        
     </environment>
 
     <!-- a sample test environment -->
@@ -57,6 +65,14 @@
                 </outputter>
             </outputters>
         </logger>
+        <database default="one">
+            <dsn id = "one"
+                 phptype  = "mysql"
+                 hostspec = "localhost"
+                 database = "eltodo"
+                 username = "root"
+                 password = "" />
+        </database>        
     </environment>
   
 </application>

Deleted: applications/testor/conf/database.ini
===================================================================
--- applications/testor/conf/database.ini	2007-06-15 07:57:36 UTC (rev 433)
+++ applications/testor/conf/database.ini	2007-06-15 08:51:46 UTC (rev 434)
@@ -1,34 +0,0 @@
-;
-; $Id$
-;
-
-; 
-; database.ini format:
-; [section] -> environment name
-; phptype -> database connection driver 
-; database -> database name
-; username -> username
-; password -> password
-; Connection flags:
-; persistent=PERSISTENT to mark the connection as beeing persistent
-;
-
-[gremlin]
-phptype=mysql
-hostspec=localhost
-database=testor
-username=root
-password=virus
-
-[testor]
-phptype=mysql
-hostspec=localhost
-database=testor
-username=root
-password=sol89aNi
-
-[test]
-phptype=sqlite
-hostspec=localhost
-database=db/testor.sqilte.db
-

Modified: applications/testor/conf/testor.xml
===================================================================
--- applications/testor/conf/testor.xml	2007-06-15 07:57:36 UTC (rev 433)
+++ applications/testor/conf/testor.xml	2007-06-15 08:51:46 UTC (rev 434)
@@ -32,6 +32,14 @@
                 </outputter>
             </outputters>
         </logger>
+        <database default="one">
+            <dsn id = "one"
+                 phptype  = "mysql"
+                 hostspec = "localhost"
+                 database = "testor"
+                 username = "root"
+                 password = "" />
+        </database>        
     </environment>
 
     <!-- a sample test environment -->
@@ -60,6 +68,14 @@
                 </outputter>
             </outputters>
         </logger>
+        <database default="one">
+            <dsn id = "one"
+                 phptype  = "mysql"
+                 hostspec = "localhost"
+                 database = "testor"
+                 username = "root"
+                 password = "" />
+        </database>        
     </environment>
   
 </application>

Modified: trunk/libs/active/record/Base.php
===================================================================
--- trunk/libs/active/record/Base.php	2007-06-15 07:57:36 UTC (rev 433)
+++ trunk/libs/active/record/Base.php	2007-06-15 08:51:46 UTC (rev 434)
@@ -715,12 +715,15 @@
      * @return array
      */ 
     private static function parse_dsn() {
+        return Registry::get('__configurator')->getDatabaseDsn();
+        /*
         $ini_file= Registry::get('__configurator')->getApplicationPath() . DIRECTORY_SEPARATOR . 'conf' . DIRECTORY_SEPARATOR . 'database.ini';
         if (!is_file($ini_file)) {
             throw new ActiveRecordException('Cannot load database settings from: ' . $ini_file . ' No such file or directory!');
         }
         $settings= parse_ini_file($ini_file, true);
         return $settings[Registry::get('__configurator')->getEnvName()];
+        */
     }
     // }}}
 }

Modified: trunk/libs/configurator/XMLConfigurator.php
===================================================================
--- trunk/libs/configurator/XMLConfigurator.php	2007-06-15 07:57:36 UTC (rev 433)
+++ trunk/libs/configurator/XMLConfigurator.php	2007-06-15 08:51:46 UTC (rev 434)
@@ -37,8 +37,6 @@
 /**
  * XML file-based Configurator
  * 
- * From medick 0.3.0 this class will be removed due to the new way of configurating a medick application!
- *
  * @package medick.configurator
  * @author Aurelian Oancea
  */
@@ -102,6 +100,42 @@
     }
     
     /**
+     * Configuration Example:
+     * <code>
+     *   <database default="foo">
+     *     <dsn id="one"
+     *          phptype  = "mysql"
+     *          hostspec = "localhost"
+     *          database = "baz"
+     *          username = "root"
+     *          password = "zzz" />
+     *     <dsn id = "foo"
+     *          phptype  = "pgsql"
+     *          hostspec = "192.18.1.1"
+     *          database ="test"
+     *          username ="antonescu"
+     *          password ="x-creeme" />
+     *   </database>
+     * </code>
+     * @see IConfigurator::getDatabaseDsn()
+     */
+    public function getDatabaseDsn($id = FALSE) {
+        if (!$id) $id = $this->sxe->database['default'];
+        foreach( $this->sxe->database->dsn as  $dsn ) {
+            if($dsn['id']==$id){
+                return array (
+                    'phptype'  => (string)trim($dsn['phptype']),
+                    'hostspec' => (string)trim($dsn['hostspec']),
+                    'username' => (string)trim($dsn['username']),
+                    'password' => (string)trim($dsn['password']),
+                    'database' => (string)trim($dsn['database'])
+                );
+            }
+        }
+        throw new ConfiguratorException('Database Id ' . $id . 'not found!');
+    }    
+    
+    /**
      * Configuration example:
      * <code>
      *   <logger>

Modified: trunk/skel/config/application.xml
===================================================================
--- trunk/skel/config/application.xml	2007-06-15 07:57:36 UTC (rev 433)
+++ trunk/skel/config/application.xml	2007-06-15 08:51:46 UTC (rev 434)
@@ -46,6 +46,15 @@
                 </outputter>
             </outputters>
         </logger>
+        <!-- database(s) settings -->
+        <database default="one">
+            <dsn id = "one"
+                 phptype  = "mysql"
+                 hostspec = "localhost"
+                 database = "${app.name}"
+                 username = "root"
+                 password = "" />
+        </database>
     </environment>
 
     <!-- a sample test environment -->
@@ -74,6 +83,12 @@
                 </outputter>
             </outputters>
         </logger>
+        <!-- database(s) settings -->
+        <database default="one">
+            <dsn id = "one"
+                 phptype  = "sqlite"
+                 database = "${app.path}${ds}db${ds}${app.name}-sqlite.db" />
+        </database>
     </environment>
   
 </application>

Deleted: trunk/skel/config/database.ini
===================================================================
--- trunk/skel/config/database.ini	2007-06-15 07:57:36 UTC (rev 433)
+++ trunk/skel/config/database.ini	2007-06-15 08:51:46 UTC (rev 434)
@@ -1,26 +0,0 @@
-;
-; $Id$
-;
-
-; 
-; database.ini format:
-; [section] -> environment name
-; phptype -> database connection driver 
-; database -> database name
-; username -> username
-; password -> password
-; Connection flags:
-; persistent=PERSISTENT to mark the connection as beeing persistent
-;
-
-[localhost]
-phptype=mysql
-hostspec=localhost
-database=${app.name}
-username=root
-password=virus
-
-[test]
-phptype=sqlite
-database=db/${app.name}.sqilte.db
-



From aurelian at mail.berlios.de  Fri Jun 15 11:03:45 2007
From: aurelian at mail.berlios.de (aurelian at BerliOS)
Date: Fri, 15 Jun 2007 11:03:45 +0200
Subject: [Medick-svn] r435 - in trunk/libs: configurator creole/drivers/mysql
Message-ID: <200706150903.l5F93jMB015384@sheep.berlios.de>

Author: aurelian
Date: 2007-06-15 11:03:43 +0200 (Fri, 15 Jun 2007)
New Revision: 435

Modified:
   trunk/libs/configurator/XMLConfigurator.php
   trunk/libs/creole/drivers/mysql/MySQLConnection.php
Log:
 -- fixed XMLConfigurator

Modified: trunk/libs/configurator/XMLConfigurator.php
===================================================================
--- trunk/libs/configurator/XMLConfigurator.php	2007-06-15 08:51:46 UTC (rev 434)
+++ trunk/libs/configurator/XMLConfigurator.php	2007-06-15 09:03:43 UTC (rev 435)
@@ -122,17 +122,17 @@
     public function getDatabaseDsn($id = FALSE) {
         if (!$id) $id = $this->sxe->database['default'];
         foreach( $this->sxe->database->dsn as  $dsn ) {
-            if($dsn['id']==$id){
+            if( trim($dsn['id']) == trim($id) ){
                 return array (
-                    'phptype'  => (string)trim($dsn['phptype']),
-                    'hostspec' => (string)trim($dsn['hostspec']),
-                    'username' => (string)trim($dsn['username']),
-                    'password' => (string)trim($dsn['password']),
-                    'database' => (string)trim($dsn['database'])
+                        'phptype'  => (string)trim($dsn['phptype']),
+                        'hostspec' => (string)trim($dsn['hostspec']),
+                        'username' => (string)trim($dsn['username']),
+                        'password' => (string)trim($dsn['password']),
+                        'database' => (string)trim($dsn['database'])
                 );
             }
         }
-        throw new ConfiguratorException('Database Id ' . $id . 'not found!');
+        throw new ConfiguratorException('Database Id ' . $id . ' not found!');
     }    
     
     /**

Modified: trunk/libs/creole/drivers/mysql/MySQLConnection.php
===================================================================
--- trunk/libs/creole/drivers/mysql/MySQLConnection.php	2007-06-15 08:51:46 UTC (rev 434)
+++ trunk/libs/creole/drivers/mysql/MySQLConnection.php	2007-06-15 09:03:43 UTC (rev 435)
@@ -187,7 +187,7 @@
     function executeQuery($sql, $fetchmode = null)
     {
         $this->lastQuery = $sql;
-        if ($this->database) {
+        if (!$this->database) {
             if (!@mysql_select_db($this->database, $this->dblink)) {
                 throw new SQLException('No database selected', mysql_error($this->dblink));
             }
@@ -206,7 +206,7 @@
     {    
         $this->lastQuery = $sql;
 
-        if ($this->database) {
+        if (!$this->database) {
             if (!@mysql_select_db($this->database, $this->dblink)) {
                     throw new SQLException('No database selected', mysql_error($this->dblink));
             }
@@ -240,7 +240,7 @@
      */
     protected function commitTrans()
     {
-        if ($this->database) {
+        if (!$this->database) {
             if (!@mysql_select_db($this->database, $this->dblink)) {
                  throw new SQLException('No database selected', mysql_error($this->dblink));
             }
@@ -259,7 +259,7 @@
      */
     protected function rollbackTrans()
     {
-        if ($this->database) {
+        if (!$this->database) {
             if (!@mysql_select_db($this->database, $this->dblink)) {
                 throw new SQLException('No database selected', mysql_error($this->dblink));
             }
@@ -282,4 +282,4 @@
         return (int) @mysql_affected_rows($this->dblink);
     }
     
-}
\ No newline at end of file
+}



From aurelian at mail.berlios.de  Fri Jun 15 09:57:37 2007
From: aurelian at mail.berlios.de (aurelian at BerliOS)
Date: Fri, 15 Jun 2007 09:57:37 +0200
Subject: [Medick-svn] r433 - trunk/skel/public/javascript
Message-ID: <200706150757.l5F7vbUI008089@sheep.berlios.de>

Author: aurelian
Date: 2007-06-15 09:57:36 +0200 (Fri, 15 Jun 2007)
New Revision: 433

Added:
   trunk/skel/public/javascript/sound.js
Modified:
   trunk/skel/public/javascript/MIT-LICENSE
   trunk/skel/public/javascript/builder.js
   trunk/skel/public/javascript/controls.js
   trunk/skel/public/javascript/dragdrop.js
   trunk/skel/public/javascript/effects.js
   trunk/skel/public/javascript/prototype.js
   trunk/skel/public/javascript/scriptaculous.js
   trunk/skel/public/javascript/slider.js
Log:
 -- upgraded srcipt.aculo.us to 1.7.1beta3 and prototype to 1.5.1

Modified: trunk/skel/public/javascript/MIT-LICENSE
===================================================================
--- trunk/skel/public/javascript/MIT-LICENSE	2007-06-12 14:45:22 UTC (rev 432)
+++ trunk/skel/public/javascript/MIT-LICENSE	2007-06-15 07:57:36 UTC (rev 433)
@@ -1,4 +1,4 @@
-Copyright (c) 2005 Thomas Fuchs (http://script.aculo.us, http://mir.aculo.us)
+Copyright (c) 2005-2007 Thomas Fuchs (http://script.aculo.us, http://mir.aculo.us)
 
 Permission is hereby granted, free of charge, to any person obtaining
 a copy of this software and associated documentation files (the

Modified: trunk/skel/public/javascript/builder.js
===================================================================
--- trunk/skel/public/javascript/builder.js	2007-06-12 14:45:22 UTC (rev 432)
+++ trunk/skel/public/javascript/builder.js	2007-06-15 07:57:36 UTC (rev 433)
@@ -1,6 +1,9 @@
-// Copyright (c) 2005 Thomas Fuchs (http://script.aculo.us, http://mir.aculo.us)
+// script.aculo.us builder.js v1.7.1_beta3, Fri May 25 17:19:41 +0200 2007
+
+// Copyright (c) 2005-2007 Thomas Fuchs (http://script.aculo.us, http://mir.aculo.us)
 //
-// See scriptaculous.js for full license.
+// script.aculo.us is freely distributable under the terms of an MIT-style license.
+// For details, see the script.aculo.us web site: http://script.aculo.us/
 
 var Builder = {
   NODEMAP: {
@@ -33,7 +36,7 @@
     var element = parentElement.firstChild || null;
       
     // see if browser added wrapping tags
-    if(element && (element.tagName != elementName))
+    if(element && (element.tagName.toUpperCase() != elementName))
       element = element.getElementsByTagName(elementName)[0];
     
     // fallback to createElement approach
@@ -45,7 +48,8 @@
     // attributes (or text)
     if(arguments[1])
       if(this._isStringOrNumber(arguments[1]) ||
-        (arguments[1] instanceof Array)) {
+        (arguments[1] instanceof Array) ||
+        arguments[1].tagName) {
           this._children(element, arguments[1]);
         } else {
           var attrs = this._attributes(arguments[1]);
@@ -61,9 +65,9 @@
               for(attr in arguments[1]) 
                 element[attr == 'class' ? 'className' : attr] = arguments[1][attr];
             }
-            if(element.tagName != elementName)
+            if(element.tagName.toUpperCase() != elementName)
               element = parentElement.getElementsByTagName(elementName)[0];
-            }
+          }
         } 
 
     // text, or array of children
@@ -75,14 +79,24 @@
   _text: function(text) {
      return document.createTextNode(text);
   },
+
+  ATTR_MAP: {
+    'className': 'class',
+    'htmlFor': 'for'
+  },
+
   _attributes: function(attributes) {
     var attrs = [];
     for(attribute in attributes)
-      attrs.push((attribute=='className' ? 'class' : attribute) +
-          '="' + attributes[attribute].toString().escapeHTML() + '"');
+      attrs.push((attribute in this.ATTR_MAP ? this.ATTR_MAP[attribute] : attribute) +
+          '="' + attributes[attribute].toString().escapeHTML().gsub(/"/,'&quot;') + '"');
     return attrs.join(" ");
   },
   _children: function(element, children) {
+    if(children.tagName) {
+      element.appendChild(children);
+      return;
+    }
     if(typeof children=='object') { // array can hold nodes and text
       children.flatten().each( function(e) {
         if(typeof e=='object')
@@ -92,10 +106,31 @@
             element.appendChild(Builder._text(e));
       });
     } else
-      if(Builder._isStringOrNumber(children)) 
-         element.appendChild(Builder._text(children));
+      if(Builder._isStringOrNumber(children))
+        element.appendChild(Builder._text(children));
   },
   _isStringOrNumber: function(param) {
     return(typeof param=='string' || typeof param=='number');
+  },
+  build: function(html) {
+    var element = this.node('div');
+    $(element).update(html.strip());
+    return element.down();
+  },
+  dump: function(scope) { 
+    if(typeof scope != 'object' && typeof scope != 'function') scope = window; //global scope 
+  
+    var tags = ("A ABBR ACRONYM ADDRESS APPLET AREA B BASE BASEFONT BDO BIG BLOCKQUOTE BODY " +
+      "BR BUTTON CAPTION CENTER CITE CODE COL COLGROUP DD DEL DFN DIR DIV DL DT EM FIELDSET " +
+      "FONT FORM FRAME FRAMESET H1 H2 H3 H4 H5 H6 HEAD HR HTML I IFRAME IMG INPUT INS ISINDEX "+
+      "KBD LABEL LEGEND LI LINK MAP MENU META NOFRAMES NOSCRIPT OBJECT OL OPTGROUP OPTION P "+
+      "PARAM PRE Q S SAMP SCRIPT SELECT SMALL SPAN STRIKE STRONG STYLE SUB SUP TABLE TBODY TD "+
+      "TEXTAREA TFOOT TH THEAD TITLE TR TT U UL VAR").split(/\s+/);
+  
+    tags.each( function(tag){ 
+      scope[tag] = function() { 
+        return Builder.node.apply(Builder, [tag].concat($A(arguments)));  
+      } 
+    });
   }
-}
\ No newline at end of file
+}

Modified: trunk/skel/public/javascript/controls.js
===================================================================
--- trunk/skel/public/javascript/controls.js	2007-06-12 14:45:22 UTC (rev 432)
+++ trunk/skel/public/javascript/controls.js	2007-06-15 07:57:36 UTC (rev 433)
@@ -1,12 +1,15 @@
-// Copyright (c) 2005 Thomas Fuchs (http://script.aculo.us, http://mir.aculo.us)
-//           (c) 2005 Ivan Krstic (http://blogs.law.harvard.edu/ivan)
-//           (c) 2005 Jon Tirsen (http://www.tirsen.com)
+// script.aculo.us controls.js v1.7.1_beta3, Fri May 25 17:19:41 +0200 2007
+
+// Copyright (c) 2005-2007 Thomas Fuchs (http://script.aculo.us, http://mir.aculo.us)
+//           (c) 2005-2007 Ivan Krstic (http://blogs.law.harvard.edu/ivan)
+//           (c) 2005-2007 Jon Tirsen (http://www.tirsen.com)
 // Contributors:
 //  Richard Livsey
 //  Rahul Bhargava
 //  Rob Wills
 // 
-// See scriptaculous.js for full license.
+// script.aculo.us is freely distributable under the terms of an MIT-style license.
+// For details, see the script.aculo.us web site: http://script.aculo.us/
 
 // Autocompleter.Base handles all the autocompletion functionality 
 // that's independent of the data source for autocompletion. This
@@ -33,11 +36,15 @@
 // useful when one of the tokens is \n (a newline), as it 
 // allows smart autocompletion after linebreaks.
 
+if(typeof Effect == 'undefined')
+  throw("controls.js requires including script.aculo.us' effects.js library");
+
 var Autocompleter = {}
 Autocompleter.Base = function() {};
 Autocompleter.Base.prototype = {
   baseInitialize: function(element, update, options) {
-    this.element     = $(element); 
+    element          = $(element)
+    this.element     = element; 
     this.update      = $(update);  
     this.hasFocus    = false; 
     this.changed     = false; 
@@ -45,7 +52,7 @@
     this.index       = 0;     
     this.entryCount  = 0;
 
-    if (this.setOptions)
+    if(this.setOptions)
       this.setOptions(options);
     else
       this.options = options || {};
@@ -55,17 +62,20 @@
     this.options.frequency    = this.options.frequency || 0.4;
     this.options.minChars     = this.options.minChars || 1;
     this.options.onShow       = this.options.onShow || 
-    function(element, update){ 
-      if(!update.style.position || update.style.position=='absolute') {
-        update.style.position = 'absolute';
-        Position.clone(element, update, {setHeight: false, offsetTop: element.offsetHeight});
-      }
-      Effect.Appear(update,{duration:0.15});
-    };
+      function(element, update){ 
+        if(!update.style.position || update.style.position=='absolute') {
+          update.style.position = 'absolute';
+          Position.clone(element, update, {
+            setHeight: false, 
+            offsetTop: element.offsetHeight
+          });
+        }
+        Effect.Appear(update,{duration:0.15});
+      };
     this.options.onHide = this.options.onHide || 
-    function(element, update){ new Effect.Fade(update,{duration:0.15}) };
+      function(element, update){ new Effect.Fade(update,{duration:0.15}) };
 
-    if (typeof(this.options.tokens) == 'string') 
+    if(typeof(this.options.tokens) == 'string') 
       this.options.tokens = new Array(this.options.tokens);
 
     this.observer = null;
@@ -74,15 +84,20 @@
 
     Element.hide(this.update);
 
-    Event.observe(this.element, "blur", this.onBlur.bindAsEventListener(this));
-    Event.observe(this.element, "keypress", this.onKeyPress.bindAsEventListener(this));
+    Event.observe(this.element, 'blur', this.onBlur.bindAsEventListener(this));
+    Event.observe(this.element, 'keypress', this.onKeyPress.bindAsEventListener(this));
+
+    // Turn autocomplete back on when the user leaves the page, so that the
+    // field's value will be remembered on Mozilla-based browsers.
+    Event.observe(window, 'beforeunload', function(){ 
+      element.setAttribute('autocomplete', 'on'); 
+    });
   },
 
   show: function() {
     if(Element.getStyle(this.update, 'display')=='none') this.options.onShow(this.element, this.update);
     if(!this.iefix && 
-      (navigator.appVersion.indexOf('MSIE')>0) &&
-      (navigator.userAgent.indexOf('Opera')<0) &&
+      (Prototype.Browser.IE) &&
       (Element.getStyle(this.update, 'position')=='absolute')) {
       new Insertion.After(this.update, 
        '<iframe id="' + this.update.id + '_iefix" '+
@@ -94,7 +109,7 @@
   },
   
   fixIEOverlapping: function() {
-    Position.clone(this.update, this.iefix);
+    Position.clone(this.update, this.iefix, {setTop:(!this.update.style.height)});
     this.iefix.style.zIndex = 1;
     this.update.style.zIndex = 2;
     Element.show(this.iefix);
@@ -132,17 +147,17 @@
        case Event.KEY_UP:
          this.markPrevious();
          this.render();
-         if(navigator.appVersion.indexOf('AppleWebKit')>0) Event.stop(event);
+         if(Prototype.Browser.WebKit) Event.stop(event);
          return;
        case Event.KEY_DOWN:
          this.markNext();
          this.render();
-         if(navigator.appVersion.indexOf('AppleWebKit')>0) Event.stop(event);
+         if(Prototype.Browser.WebKit) Event.stop(event);
          return;
       }
      else 
        if(event.keyCode==Event.KEY_TAB || event.keyCode==Event.KEY_RETURN || 
-         (navigator.appVersion.indexOf('AppleWebKit') > 0 && event.keyCode == 0)) return;
+         (Prototype.Browser.WebKit > 0 && event.keyCode == 0)) return;
 
     this.changed = true;
     this.hasFocus = true;
@@ -188,7 +203,6 @@
         this.index==i ? 
           Element.addClassName(this.getEntry(i),"selected") : 
           Element.removeClassName(this.getEntry(i),"selected");
-        
       if(this.hasFocus) { 
         this.show();
         this.active = true;
@@ -202,11 +216,13 @@
   markPrevious: function() {
     if(this.index > 0) this.index--
       else this.index = this.entryCount-1;
+    this.getEntry(this.index).scrollIntoView(true);
   },
   
   markNext: function() {
     if(this.index < this.entryCount-1) this.index++
       else this.index = 0;
+    this.getEntry(this.index).scrollIntoView(false);
   },
   
   getEntry: function(index) {
@@ -254,11 +270,11 @@
     if(!this.changed && this.hasFocus) {
       this.update.innerHTML = choices;
       Element.cleanWhitespace(this.update);
-      Element.cleanWhitespace(this.update.firstChild);
+      Element.cleanWhitespace(this.update.down());
 
-      if(this.update.firstChild && this.update.firstChild.childNodes) {
+      if(this.update.firstChild && this.update.down().childNodes) {
         this.entryCount = 
-          this.update.firstChild.childNodes.length;
+          this.update.down().childNodes.length;
         for (var i = 0; i < this.entryCount; i++) {
           var entry = this.getEntry(i);
           entry.autocompleteIndex = i;
@@ -269,9 +285,14 @@
       }
 
       this.stopIndicator();
-
       this.index = 0;
-      this.render();
+      
+      if(this.entryCount==1 && this.options.autoSelect) {
+        this.selectEntry();
+        this.hide();
+      } else {
+        this.render();
+      }
     }
   },
 
@@ -283,7 +304,6 @@
   onObserverEvent: function() {
     this.changed = false;   
     if(this.getToken().length>=this.options.minChars) {
-      this.startIndicator();
       this.getUpdatedChoices();
     } else {
       this.active = false;
@@ -324,7 +344,9 @@
   },
 
   getUpdatedChoices: function() {
-    entry = encodeURIComponent(this.options.paramName) + '=' + 
+    this.startIndicator();
+    
+    var entry = encodeURIComponent(this.options.paramName) + '=' + 
       encodeURIComponent(this.getToken());
 
     this.options.parameters = this.options.callback ?
@@ -332,7 +354,7 @@
 
     if(this.options.defaultParams) 
       this.options.parameters += '&' + this.options.defaultParams;
-
+    
     new Ajax.Request(this.url, this.options);
   },
 
@@ -459,10 +481,16 @@
     this.element = $(element);
 
     this.options = Object.extend({
+      paramName: "value",
       okButton: true,
+      okLink: false,
       okText: "ok",
+      cancelButton: false,
       cancelLink: true,
       cancelText: "cancel",
+      textBeforeControls: '',
+      textBetweenControls: '',
+      textAfterControls: '',
       savingText: "Saving...",
       clickToEditText: "Click to edit",
       okText: "ok",
@@ -531,7 +559,7 @@
     Element.hide(this.element);
     this.createForm();
     this.element.parentNode.insertBefore(this.form, this.element);
-    Field.scrollFreeActivate(this.editField);
+    if (!this.options.loadTextURL) Field.scrollFreeActivate(this.editField);
     // stop the event to avoid a page refresh in Safari
     if (evt) {
       Event.stop(evt);
@@ -550,23 +578,52 @@
       var br = document.createElement("br");
       this.form.appendChild(br);
     }
+    
+    if (this.options.textBeforeControls)
+      this.form.appendChild(document.createTextNode(this.options.textBeforeControls));
 
     if (this.options.okButton) {
-      okButton = document.createElement("input");
+      var okButton = document.createElement("input");
       okButton.type = "submit";
       okButton.value = this.options.okText;
       okButton.className = 'editor_ok_button';
       this.form.appendChild(okButton);
     }
+    
+    if (this.options.okLink) {
+      var okLink = document.createElement("a");
+      okLink.href = "#";
+      okLink.appendChild(document.createTextNode(this.options.okText));
+      okLink.onclick = this.onSubmit.bind(this);
+      okLink.className = 'editor_ok_link';
+      this.form.appendChild(okLink);
+    }
+    
+    if (this.options.textBetweenControls && 
+      (this.options.okLink || this.options.okButton) && 
+      (this.options.cancelLink || this.options.cancelButton))
+      this.form.appendChild(document.createTextNode(this.options.textBetweenControls));
+      
+    if (this.options.cancelButton) {
+      var cancelButton = document.createElement("input");
+      cancelButton.type = "submit";
+      cancelButton.value = this.options.cancelText;
+      cancelButton.onclick = this.onclickCancel.bind(this);
+      cancelButton.className = 'editor_cancel_button';
+      this.form.appendChild(cancelButton);
+    }
 
     if (this.options.cancelLink) {
-      cancelLink = document.createElement("a");
+      var cancelLink = document.createElement("a");
       cancelLink.href = "#";
       cancelLink.appendChild(document.createTextNode(this.options.cancelText));
       cancelLink.onclick = this.onclickCancel.bind(this);
-      cancelLink.className = 'editor_cancel';      
+      cancelLink.className = 'editor_cancel editor_cancel_link';      
       this.form.appendChild(cancelLink);
     }
+    
+    if (this.options.textAfterControls)
+      this.form.appendChild(document.createTextNode(this.options.textAfterControls));
   },
   hasHTMLLineBreaks: function(string) {
     if (!this.options.handleLineBreaks) return false;
@@ -590,7 +647,7 @@
       var textField = document.createElement("input");
       textField.obj = this;
       textField.type = "text";
-      textField.name = "value";
+      textField.name = this.options.paramName;
       textField.value = text;
       textField.style.backgroundColor = this.options.highlightcolor;
       textField.className = 'editor_field';
@@ -603,7 +660,7 @@
       this.options.textarea = true;
       var textArea = document.createElement("textarea");
       textArea.obj = this;
-      textArea.name = "value";
+      textArea.name = this.options.paramName;
       textArea.value = this.convertHTMLLineBreaks(text);
       textArea.rows = this.options.rows;
       textArea.cols = this.options.cols || 40;
@@ -636,6 +693,7 @@
     Element.removeClassName(this.form, this.options.loadingClassName);
     this.editField.disabled = false;
     this.editField.value = transport.responseText.stripTags();
+    Field.scrollFreeActivate(this.editField);
   },
   onclickCancel: function() {
     this.onComplete();
@@ -772,6 +830,8 @@
       collection.each(function(e,i) {
         optionTag = document.createElement("option");
         optionTag.value = (e instanceof Array) ? e[0] : e;
+        if((typeof this.options.value == 'undefined') && 
+          ((e instanceof Array) ? this.element.innerHTML == e[1] : e == optionTag.value)) optionTag.selected = true;
         if(this.options.value==optionTag.value) optionTag.selected = true;
         optionTag.appendChild(document.createTextNode((e instanceof Array) ? e[1] : e));
         selectTag.appendChild(optionTag);

Modified: trunk/skel/public/javascript/dragdrop.js
===================================================================
--- trunk/skel/public/javascript/dragdrop.js	2007-06-12 14:45:22 UTC (rev 432)
+++ trunk/skel/public/javascript/dragdrop.js	2007-06-15 07:57:36 UTC (rev 433)
@@ -1,9 +1,13 @@
-// Copyright (c) 2005 Thomas Fuchs (http://script.aculo.us, http://mir.aculo.us)
-//           (c) 2005 Sammi Williams (http://www.oriontransfer.co.nz, sammi at oriontransfer.co.nz)
+// script.aculo.us dragdrop.js v1.7.1_beta3, Fri May 25 17:19:41 +0200 2007
+
+// Copyright (c) 2005-2007 Thomas Fuchs (http://script.aculo.us, http://mir.aculo.us)
+//           (c) 2005-2007 Sammi Williams (http://www.oriontransfer.co.nz, sammi at oriontransfer.co.nz)
 // 
-// See scriptaculous.js for full license.
+// script.aculo.us is freely distributable under the terms of an MIT-style license.
+// For details, see the script.aculo.us web site: http://script.aculo.us/
 
-/*--------------------------------------------------------------------------*/
+if(typeof Effect == 'undefined')
+  throw("dragdrop.js requires including script.aculo.us' effects.js library");
 
 var Droppables = {
   drops: [],
@@ -108,8 +112,10 @@
     Position.prepare();
 
     if (this.isAffected([Event.pointerX(event), Event.pointerY(event)], element, this.last_active))
-      if (this.last_active.onDrop) 
-        this.last_active.onDrop(element, this.last_active.element, event);
+      if (this.last_active.onDrop) {
+        this.last_active.onDrop(element, this.last_active.element, event); 
+        return true; 
+      }
   },
 
   reset: function() {
@@ -145,8 +151,16 @@
   },
   
   activate: function(draggable) {
-    window.focus(); // allows keypress events if window isn't currently focused, fails for Safari
-    this.activeDraggable = draggable;
+    if(draggable.options.delay) { 
+      this._timeout = setTimeout(function() { 
+        Draggables._timeout = null; 
+        window.focus(); 
+        Draggables.activeDraggable = draggable; 
+      }.bind(this), draggable.options.delay); 
+    } else {
+      window.focus(); // allows keypress events if window isn't currently focused, fails for Safari
+      this.activeDraggable = draggable;
+    }
   },
   
   deactivate: function() {
@@ -160,10 +174,15 @@
     // the same coordinates, prevent needless redrawing (moz bug?)
     if(this._lastPointer && (this._lastPointer.inspect() == pointer.inspect())) return;
     this._lastPointer = pointer;
+    
     this.activeDraggable.updateDrag(event, pointer);
   },
   
   endDrag: function(event) {
+    if(this._timeout) { 
+      clearTimeout(this._timeout); 
+      this._timeout = null; 
+    }
     if(!this.activeDraggable) return;
     this._lastPointer = null;
     this.activeDraggable.endDrag(event);
@@ -190,6 +209,7 @@
       this.observers.each( function(o) {
         if(o[eventName]) o[eventName](eventName, draggable, event);
       });
+    if(draggable.options[eventName]) draggable.options[eventName](draggable, event);
   },
   
   _cacheObserverCallbacks: function() {
@@ -204,41 +224,60 @@
 /*--------------------------------------------------------------------------*/
 
 var Draggable = Class.create();
+Draggable._dragging    = {};
+
 Draggable.prototype = {
   initialize: function(element) {
-    var options = Object.extend({
+    var defaults = {
       handle: false,
-      starteffect: function(element) {
-        element._opacity = Element.getOpacity(element); 
-        new Effect.Opacity(element, {duration:0.2, from:element._opacity, to:0.7}); 
-      },
       reverteffect: function(element, top_offset, left_offset) {
         var dur = Math.sqrt(Math.abs(top_offset^2)+Math.abs(left_offset^2))*0.02;
-        element._revert = new Effect.Move(element, { x: -left_offset, y: -top_offset, duration: dur});
+        new Effect.Move(element, { x: -left_offset, y: -top_offset, duration: dur,
+          queue: {scope:'_draggable', position:'end'}
+        });
       },
       endeffect: function(element) {
-        var toOpacity = typeof element._opacity == 'number' ? element._opacity : 1.0
-        new Effect.Opacity(element, {duration:0.2, from:0.7, to:toOpacity}); 
+        var toOpacity = typeof element._opacity == 'number' ? element._opacity : 1.0;
+        new Effect.Opacity(element, {duration:0.2, from:0.7, to:toOpacity, 
+          queue: {scope:'_draggable', position:'end'},
+          afterFinish: function(){ 
+            Draggable._dragging[element] = false 
+          }
+        }); 
       },
       zindex: 1000,
       revert: false,
+      quiet: false,
       scroll: false,
       scrollSensitivity: 20,
       scrollSpeed: 15,
-      snap: false   // false, or xy or [x,y] or function(x,y){ return [x,y] }
-    }, arguments[1] || {});
+      snap: false,  // false, or xy or [x,y] or function(x,y){ return [x,y] }
+      delay: 0
+    };
+    
+    if(!arguments[1] || typeof arguments[1].endeffect == 'undefined')
+      Object.extend(defaults, {
+        starteffect: function(element) {
+          element._opacity = Element.getOpacity(element);
+          Draggable._dragging[element] = true;
+          new Effect.Opacity(element, {duration:0.2, from:element._opacity, to:0.7}); 
+        }
+      });
+    
+    var options = Object.extend(defaults, arguments[1] || {});
 
     this.element = $(element);
     
-    if(options.handle && (typeof options.handle == 'string')) {
-      var h = Element.childrenWithClassName(this.element, options.handle, true);
-      if(h.length>0) this.handle = h[0];
-    }
+    if(options.handle && (typeof options.handle == 'string'))
+      this.handle = this.element.down('.'+options.handle, 0);
+    
     if(!this.handle) this.handle = $(options.handle);
     if(!this.handle) this.handle = this.element;
     
-    if(options.scroll && !options.scroll.scrollTo && !options.scroll.outerHTML)
+    if(options.scroll && !options.scroll.scrollTo && !options.scroll.outerHTML) {
       options.scroll = $(options.scroll);
+      this._isScrollChild = Element.childOf(this.element, options.scroll);
+    }
 
     Element.makePositioned(this.element); // fix IE    
 
@@ -264,21 +303,18 @@
   },
   
   initDrag: function(event) {
+    if(typeof Draggable._dragging[this.element] != 'undefined' &&
+      Draggable._dragging[this.element]) return;
     if(Event.isLeftClick(event)) {    
       // abort on form elements, fixes a Firefox issue
       var src = Event.element(event);
-      if(src.tagName && (
-        src.tagName=='INPUT' ||
-        src.tagName=='SELECT' ||
-        src.tagName=='OPTION' ||
-        src.tagName=='BUTTON' ||
-        src.tagName=='TEXTAREA')) return;
+      if((tag_name = src.tagName.toUpperCase()) && (
+        tag_name=='INPUT' ||
+        tag_name=='SELECT' ||
+        tag_name=='OPTION' ||
+        tag_name=='BUTTON' ||
+        tag_name=='TEXTAREA')) return;
         
-      if(this.element._revert) {
-        this.element._revert.cancel();
-        this.element._revert = null;
-      }
-      
       var pointer = [Event.pointerX(event), Event.pointerY(event)];
       var pos     = Position.cumulativeOffset(this.element);
       this.offset = [0,1].map( function(i) { return (pointer[i] - pos[i]) });
@@ -314,14 +350,20 @@
     }
     
     Draggables.notify('onStart', this, event);
+        
     if(this.options.starteffect) this.options.starteffect(this.element);
   },
   
   updateDrag: function(event, pointer) {
     if(!this.dragging) this.startDrag(event);
-    Position.prepare();
-    Droppables.show(pointer, this.element);
+    
+    if(!this.options.quiet){
+      Position.prepare();
+      Droppables.show(pointer, this.element);
+    }
+    
     Draggables.notify('onDrag', this, event);
+    
     this.draw(pointer);
     if(this.options.change) this.options.change(this);
     
@@ -333,8 +375,8 @@
         with(this._getWindowScroll(this.options.scroll)) { p = [ left, top, left+width, top+height ]; }
       } else {
         p = Position.page(this.options.scroll);
-        p[0] += this.options.scroll.scrollLeft;
-        p[1] += this.options.scroll.scrollTop;
+        p[0] += this.options.scroll.scrollLeft + Position.deltaX;
+        p[1] += this.options.scroll.scrollTop + Position.deltaY;
         p.push(p[0]+this.options.scroll.offsetWidth);
         p.push(p[1]+this.options.scroll.offsetHeight);
       }
@@ -347,13 +389,19 @@
     }
     
     // fix AppleWebKit rendering
-    if(navigator.appVersion.indexOf('AppleWebKit')>0) window.scrollBy(0,0);
+    if(Prototype.Browser.WebKit) window.scrollBy(0,0);
     
     Event.stop(event);
   },
   
   finishDrag: function(event, success) {
     this.dragging = false;
+    
+    if(this.options.quiet){
+      Position.prepare();
+      var pointer = [Event.pointerX(event), Event.pointerY(event)];
+      Droppables.show(pointer, this.element);
+    }
 
     if(this.options.ghosting) {
       Position.relativize(this.element);
@@ -361,7 +409,12 @@
       this._clone = null;
     }
 
-    if(success) Droppables.fire(event, this.element);
+    var dropped = false; 
+    if(success) { 
+      dropped = Droppables.fire(event, this.element); 
+      if (!dropped) dropped = false; 
+    }
+    if(dropped && this.options.onDropped) this.options.onDropped(this.element);
     Draggables.notify('onEnd', this, event);
 
     var revert = this.options.revert;
@@ -369,8 +422,9 @@
     
     var d = this.currentDelta();
     if(revert && this.options.reverteffect) {
-      this.options.reverteffect(this.element, 
-        d[1]-this.delta[1], d[0]-this.delta[0]);
+      if (dropped == 0 || revert != 'failure')
+        this.options.reverteffect(this.element,
+          d[1]-this.delta[1], d[0]-this.delta[0]);
     } else {
       this.delta = d;
     }
@@ -380,7 +434,7 @@
 
     if(this.options.endeffect) 
       this.options.endeffect(this.element);
-
+      
     Draggables.deactivate(this);
     Droppables.reset();
   },
@@ -400,10 +454,15 @@
   
   draw: function(point) {
     var pos = Position.cumulativeOffset(this.element);
+    if(this.options.ghosting) {
+      var r   = Position.realOffset(this.element);
+      pos[0] += r[0] - Position.deltaX; pos[1] += r[1] - Position.deltaY;
+    }
+    
     var d = this.currentDelta();
     pos[0] -= d[0]; pos[1] -= d[1];
     
-    if(this.options.scroll && (this.options.scroll != window)) {
+    if(this.options.scroll && (this.options.scroll != window && this._isScrollChild)) {
       pos[0] -= this.options.scroll.scrollLeft-this.originalScrollLeft;
       pos[1] -= this.options.scroll.scrollTop-this.originalScrollTop;
     }
@@ -430,6 +489,7 @@
       style.left = p[0] + "px";
     if((!this.options.constraint) || (this.options.constraint=='vertical'))
       style.top  = p[1] + "px";
+    
     if(style.visibility=="hidden") style.visibility = ""; // fix gecko rendering
   },
   
@@ -442,6 +502,7 @@
   },
   
   startScrolling: function(speed) {
+    if(!(speed[0] || speed[1])) return;
     this.scrollSpeed = [speed[0]*this.options.scrollSpeed,speed[1]*this.options.scrollSpeed];
     this.lastScrolled = new Date();
     this.scrollInterval = setInterval(this.scroll.bind(this), 10);
@@ -466,14 +527,16 @@
     Position.prepare();
     Droppables.show(Draggables._lastPointer, this.element);
     Draggables.notify('onDrag', this);
-    Draggables._lastScrollPointer = Draggables._lastScrollPointer || $A(Draggables._lastPointer);
-    Draggables._lastScrollPointer[0] += this.scrollSpeed[0] * delta / 1000;
-    Draggables._lastScrollPointer[1] += this.scrollSpeed[1] * delta / 1000;
-    if (Draggables._lastScrollPointer[0] < 0)
-      Draggables._lastScrollPointer[0] = 0;
-    if (Draggables._lastScrollPointer[1] < 0)
-      Draggables._lastScrollPointer[1] = 0;
-    this.draw(Draggables._lastScrollPointer);
+    if (this._isScrollChild) {
+      Draggables._lastScrollPointer = Draggables._lastScrollPointer || $A(Draggables._lastPointer);
+      Draggables._lastScrollPointer[0] += this.scrollSpeed[0] * delta / 1000;
+      Draggables._lastScrollPointer[1] += this.scrollSpeed[1] * delta / 1000;
+      if (Draggables._lastScrollPointer[0] < 0)
+        Draggables._lastScrollPointer[0] = 0;
+      if (Draggables._lastScrollPointer[1] < 0)
+        Draggables._lastScrollPointer[1] = 0;
+      this.draw(Draggables._lastScrollPointer);
+    }
     
     if(this.options.change) this.options.change(this);
   },
@@ -525,10 +588,12 @@
 }
 
 var Sortable = {
+  SERIALIZE_RULE: /^[^_\-](?:[A-Za-z0-9\-\_]*)[_](.*)$/,
+  
   sortables: {},
   
   _findRootElement: function(element) {
-    while (element.tagName != "BODY") {  
+    while (element.tagName.toUpperCase() != "BODY") {  
       if(element.id && Sortable.sortables[element.id]) return element;
       element = element.parentNode;
     }
@@ -565,12 +630,20 @@
       containment: element,    // also takes array of elements (or id's); or false
       handle:      false,      // or a CSS class
       only:        false,
+      delay:       0,
       hoverclass:  null,
       ghosting:    false,
+      quiet:       false, 
       scroll:      false,
       scrollSensitivity: 20,
       scrollSpeed: 15,
-      format:      /^[^_]*_(.*)$/,
+      format:      this.SERIALIZE_RULE,
+      
+      // these take arrays of elements or ids and can be 
+      // used for better initialization performance
+      elements:    false,
+      handles:     false,
+      
       onChange:    Prototype.emptyFunction,
       onUpdate:    Prototype.emptyFunction
     }, arguments[1] || {});
@@ -581,9 +654,11 @@
     // build options for the draggables
     var options_for_draggable = {
       revert:      true,
+      quiet:       options.quiet,
       scroll:      options.scroll,
       scrollSpeed: options.scrollSpeed,
       scrollSensitivity: options.scrollSensitivity,
+      delay:       options.delay,
       ghosting:    options.ghosting,
       constraint:  options.constraint,
       handle:      options.handle };
@@ -612,7 +687,6 @@
       tree:        options.tree,
       hoverclass:  options.hoverclass,
       onHover:     Sortable.onHover
-      //greedy:      !options.dropOnEmpty
     }
     
     var options_for_tree = {
@@ -634,10 +708,9 @@
       options.droppables.push(element);
     }
 
-    (this.findElements(element, options) || []).each( function(e) {
-      // handles are per-draggable
-      var handle = options.handle ? 
-        Element.childrenWithClassName(e, options.handle)[0] : e;    
+    (options.elements || this.findElements(element, options) || []).each( function(e,i) {
+      var handle = options.handles ? $(options.handles[i]) :
+        (options.handle ? $(e).getElementsByClassName(options.handle)[0] : e); 
       options.draggables.push(
         new Draggable(e, Object.extend(options_for_draggable, { handle: handle })));
       Droppables.add(e, options_for_droppable);
@@ -708,7 +781,7 @@
     if(!Element.isParent(dropon, element)) {
       var index;
       
-      var children = Sortable.findElements(dropon, {tag: droponOptions.tag});
+      var children = Sortable.findElements(dropon, {tag: droponOptions.tag, only: droponOptions.only});
       var child = null;
             
       if(children) {
@@ -735,7 +808,7 @@
   },
 
   unmark: function() {
-    if(Sortable._marker) Element.hide(Sortable._marker);
+    if(Sortable._marker) Sortable._marker.hide();
   },
 
   mark: function(dropon, position) {
@@ -744,23 +817,21 @@
     if(sortable && !sortable.ghosting) return; 
 
     if(!Sortable._marker) {
-      Sortable._marker = $('dropmarker') || document.createElement('DIV');
-      Element.hide(Sortable._marker);
-      Element.addClassName(Sortable._marker, 'dropmarker');
-      Sortable._marker.style.position = 'absolute';
+      Sortable._marker = 
+        ($('dropmarker') || Element.extend(document.createElement('DIV'))).
+          hide().addClassName('dropmarker').setStyle({position:'absolute'});
       document.getElementsByTagName("body").item(0).appendChild(Sortable._marker);
     }    
     var offsets = Position.cumulativeOffset(dropon);
-    Sortable._marker.style.left = offsets[0] + 'px';
-    Sortable._marker.style.top = offsets[1] + 'px';
+    Sortable._marker.setStyle({left: offsets[0]+'px', top: offsets[1] + 'px'});
     
     if(position=='after')
       if(sortable.overlap == 'horizontal') 
-        Sortable._marker.style.left = (offsets[0]+dropon.clientWidth) + 'px';
+        Sortable._marker.setStyle({left: (offsets[0]+dropon.clientWidth) + 'px'});
       else
-        Sortable._marker.style.top = (offsets[1]+dropon.clientHeight) + 'px';
+        Sortable._marker.setStyle({top: (offsets[1]+dropon.clientHeight) + 'px'});
     
-    Element.show(Sortable._marker);
+    Sortable._marker.show();
   },
   
   _tree: function(element, options, parent) {
@@ -775,9 +846,9 @@
         id: encodeURIComponent(match ? match[1] : null),
         element: element,
         parent: parent,
-        children: new Array,
+        children: [],
         position: parent.children.length,
-        container: Sortable._findChildrenElement(children[i], options.treeTag.toUpperCase())
+        container: $(children[i]).down(options.treeTag)
       }
       
       /* Get the element containing the children and recurse over it */
@@ -790,17 +861,6 @@
     return parent; 
   },
 
-  /* Finds the first element of the given tag type within a parent element.
-    Used for finding the first LI[ST] within a L[IST]I[TEM].*/
-  _findChildrenElement: function (element, containerTag) {
-    if (element && element.hasChildNodes)
-      for (var i = 0; i < element.childNodes.length; ++i)
-        if (element.childNodes[i].tagName == containerTag)
-          return element.childNodes[i];
-  
-    return null;
-  },
-
   tree: function(element) {
     element = $(element);
     var sortableOptions = this.options(element);
@@ -815,12 +875,12 @@
     var root = {
       id: null,
       parent: null,
-      children: new Array,
+      children: [],
       container: element,
       position: 0
     }
     
-    return Sortable._tree (element, options, root);
+    return Sortable._tree(element, options, root);
   },
 
   /* Construct a [i] index for a particular node */
@@ -869,7 +929,7 @@
     
     if (options.tree) {
       return Sortable.tree(element, arguments[1]).children.map( function (item) {
-        return [name + Sortable._constructIndex(item) + "=" + 
+        return [name + Sortable._constructIndex(item) + "[id]=" + 
                 encodeURIComponent(item.id)].concat(item.children.map(arguments.callee));
       }).flatten().join('&');
     } else {
@@ -880,16 +940,14 @@
   }
 }
 
-/* Returns true if child is contained within element */
+// Returns true if child is contained within element
 Element.isParent = function(child, element) {
   if (!child.parentNode || child == element) return false;
-
   if (child.parentNode == element) return true;
-
   return Element.isParent(child.parentNode, element);
 }
 
-Element.findChildren = function(element, only, recursive, tagName) {    
+Element.findChildren = function(element, only, recursive, tagName) {   
   if(!element.hasChildNodes()) return null;
   tagName = tagName.toUpperCase();
   if(only) only = [only].flatten();
@@ -908,8 +966,5 @@
 }
 
 Element.offsetSize = function (element, type) {
-  if (type == 'vertical' || type == 'height')
-    return element.offsetHeight;
-  else
-    return element.offsetWidth;
-}
\ No newline at end of file
+  return element['offset' + ((type=='vertical' || type=='height') ? 'Height' : 'Width')];
+}

Modified: trunk/skel/public/javascript/effects.js
===================================================================
--- trunk/skel/public/javascript/effects.js	2007-06-12 14:45:22 UTC (rev 432)
+++ trunk/skel/public/javascript/effects.js	2007-06-15 07:57:36 UTC (rev 433)
@@ -1,15 +1,18 @@
-// Copyright (c) 2005 Thomas Fuchs (http://script.aculo.us, http://mir.aculo.us)
+// script.aculo.us effects.js v1.7.1_beta3, Fri May 25 17:19:41 +0200 2007
+
+// Copyright (c) 2005-2007 Thomas Fuchs (http://script.aculo.us, http://mir.aculo.us)
 // Contributors:
 //  Justin Palmer (http://encytemedia.com/)
 //  Mark Pilgrim (http://diveintomark.org/)
 //  Martin Bialasinki
 // 
-// See scriptaculous.js for full license.  
+// script.aculo.us is freely distributable under the terms of an MIT-style license.
+// For details, see the script.aculo.us web site: http://script.aculo.us/ 
 
 // converts rgb() and #xxx to #xxxxxx format,  
 // returns self (or first argument) if not convertable  
 String.prototype.parseColor = function() {  
-  var color = '#';  
+  var color = '#';
   if(this.slice(0,4) == 'rgb(') {  
     var cols = this.slice(4,this.length-1).split(',');  
     var i=0; do { color += parseInt(cols[i]).toColorPart() } while (++i<3);  
@@ -41,48 +44,13 @@
 
 Element.setContentZoom = function(element, percent) {
   element = $(element);  
-  Element.setStyle(element, {fontSize: (percent/100) + 'em'});   
-  if(navigator.appVersion.indexOf('AppleWebKit')>0) window.scrollBy(0,0);
+  element.setStyle({fontSize: (percent/100) + 'em'});   
+  if(Prototype.Browser.WebKit) window.scrollBy(0,0);
+  return element;
 }
 
-Element.getOpacity = function(element){  
-  var opacity;
-  if (opacity = Element.getStyle(element, 'opacity'))  
-    return parseFloat(opacity);  
-  if (opacity = (Element.getStyle(element, 'filter') || '').match(/alpha\(opacity=(.*)\)/))  
-    if(opacity[1]) return parseFloat(opacity[1]) / 100;  
-  return 1.0;  
-}
-
-Element.setOpacity = function(element, value){  
-  element= $(element);  
-  if (value == 1){
-    Element.setStyle(element, { opacity: 
-      (/Gecko/.test(navigator.userAgent) && !/Konqueror|Safari|KHTML/.test(navigator.userAgent)) ? 
-      0.999999 : null });
-    if(/MSIE/.test(navigator.userAgent))  
-      Element.setStyle(element, {filter: Element.getStyle(element,'filter').replace(/alpha\([^\)]*\)/gi,'')});  
-  } else {  
-    if(value < 0.00001) value = 0;  
-    Element.setStyle(element, {opacity: value});
-    if(/MSIE/.test(navigator.userAgent))  
-     Element.setStyle(element, 
-       { filter: Element.getStyle(element,'filter').replace(/alpha\([^\)]*\)/gi,'') +
-                 'alpha(opacity='+value*100+')' });  
-  }
-}  
- 
-Element.getInlineOpacity = function(element){  
+Element.getInlineOpacity = function(element){
   return $(element).style.opacity || '';
-}  
-
-Element.childrenWithClassName = function(element, className, findFirst) {
-  var classNameRegExp = new RegExp("(^|\\s)" + className + "(\\s|$)");
-  var results = $A($(element).getElementsByTagName('*'))[findFirst ? 'detect' : 'select']( function(c) { 
-    return (c.className && c.className.match(classNameRegExp));
-  });
-  if(!results) results = [];
-  return results;
 }
 
 Element.forceRerendering = function(element) {
@@ -104,9 +72,17 @@
 /*--------------------------------------------------------------------------*/
 
 var Effect = {
+  _elementDoesNotExistError: {
+    name: 'ElementDoesNotExistError',
+    message: 'The specified DOM element does not exist, but is required for this effect to operate'
+  },
   tagifyText: function(element) {
+    if(typeof Builder == 'undefined')
+      throw("Effect.tagifyText requires including script.aculo.us' builder.js library");
+      
     var tagifyStyle = 'position:relative';
-    if(/MSIE/.test(navigator.userAgent)) tagifyStyle += ';zoom:1';
+    if(Prototype.Browser.IE) tagifyStyle += ';zoom:1';
+    
     element = $(element);
     $A(element.childNodes).each( function(child) {
       if(child.nodeType==3) {
@@ -159,41 +135,44 @@
 
 /* ------------- transitions ------------- */
 
-Effect.Transitions = {}
+Effect.Transitions = {
+  linear: Prototype.K,
+  sinoidal: function(pos) {
+    return (-Math.cos(pos*Math.PI)/2) + 0.5;
+  },
+  reverse: function(pos) {
+    return 1-pos;
+  },
+  flicker: function(pos) {
+    var pos = ((-Math.cos(pos*Math.PI)/4) + 0.75) + Math.random()/4;
+    return (pos > 1 ? 1 : pos);
+  },
+  wobble: function(pos) {
+    return (-Math.cos(pos*Math.PI*(9*pos))/2) + 0.5;
+  },
+  pulse: function(pos, pulses) { 
+    pulses = pulses || 5; 
+    return (
+      Math.round((pos % (1/pulses)) * pulses) == 0 ? 
+            ((pos * pulses * 2) - Math.floor(pos * pulses * 2)) : 
+        1 - ((pos * pulses * 2) - Math.floor(pos * pulses * 2))
+      );
+  },
+  none: function(pos) {
+    return 0;
+  },
+  full: function(pos) {
+    return 1;
+  }
+};
 
-Effect.Transitions.linear = function(pos) {
-  return pos;
-}
-Effect.Transitions.sinoidal = function(pos) {
-  return (-Math.cos(pos*Math.PI)/2) + 0.5;
-}
-Effect.Transitions.reverse  = function(pos) {
-  return 1-pos;
-}
-Effect.Transitions.flicker = function(pos) {
-  return ((-Math.cos(pos*Math.PI)/4) + 0.75) + Math.random()/4;
-}
-Effect.Transitions.wobble = function(pos) {
-  return (-Math.cos(pos*Math.PI*(9*pos))/2) + 0.5;
-}
-Effect.Transitions.pulse = function(pos) {
-  return (Math.floor(pos*10) % 2 == 0 ? 
-    (pos*10-Math.floor(pos*10)) : 1-(pos*10-Math.floor(pos*10)));
-}
-Effect.Transitions.none = function(pos) {
-  return 0;
-}
-Effect.Transitions.full = function(pos) {
-  return 1;
-}
-
 /* ------------- core effects ------------- */
 
 Effect.ScopedQueue = Class.create();
 Object.extend(Object.extend(Effect.ScopedQueue.prototype, Enumerable), {
   initialize: function() {
     this.effects  = [];
-    this.interval = null;
+    this.interval = null;    
   },
   _each: function(iterator) {
     this.effects._each(iterator);
@@ -212,6 +191,9 @@
             e.finishOn += effect.finishOn;
           });
         break;
+      case 'with-last':
+        timestamp = this.effects.pluck('startOn').max() || timestamp;
+        break;
       case 'end':
         // start effect after last queued effect has finished
         timestamp = this.effects.pluck('finishOn').max() || timestamp;
@@ -224,8 +206,8 @@
     if(!effect.options.queue.limit || (this.effects.length < effect.options.queue.limit))
       this.effects.push(effect);
     
-    if(!this.interval) 
-      this.interval = setInterval(this.loop.bind(this), 40);
+    if(!this.interval)
+      this.interval = setInterval(this.loop.bind(this), 15);
   },
   remove: function(effect) {
     this.effects = this.effects.reject(function(e) { return e==effect });
@@ -236,7 +218,8 @@
   },
   loop: function() {
     var timePos = new Date().getTime();
-    this.effects.invoke('loop', timePos);
+    for(var i=0, len=this.effects.length;i<len;i++) 
+      this.effects[i] && this.effects[i].loop(timePos);
   }
 });
 
@@ -256,7 +239,7 @@
 Effect.DefaultOptions = {
   transition: Effect.Transitions.sinoidal,
   duration:   1.0,   // seconds
-  fps:        25.0,  // max. 25fps due to Effect.Queue implementation
+  fps:        100,   // 100= assume 66fps max.
   sync:       false, // true for combining
   from:       0.0,
   to:         1.0,
@@ -268,11 +251,35 @@
 Effect.Base.prototype = {
   position: null,
   start: function(options) {
+    function codeForEvent(options,eventName){
+      return (
+        (options[eventName+'Internal'] ? 'this.options.'+eventName+'Internal(this);' : '') +
+        (options[eventName] ? 'this.options.'+eventName+'(this);' : '')
+      );
+    }
+    if(options.transition === false) options.transition = Effect.Transitions.linear;
     this.options      = Object.extend(Object.extend({},Effect.DefaultOptions), options || {});
     this.currentFrame = 0;
     this.state        = 'idle';
     this.startOn      = this.options.delay*1000;
-    this.finishOn     = this.startOn + (this.options.duration*1000);
+    this.finishOn     = this.startOn+(this.options.duration*1000);
+    this.fromToDelta  = this.options.to-this.options.from;
+    this.totalTime    = this.finishOn-this.startOn;
+    this.totalFrames  = this.options.fps*this.options.duration;
+    
+    eval('this.render = function(pos){ '+
+      'if(this.state=="idle"){this.state="running";'+
+      codeForEvent(options,'beforeSetup')+
+      (this.setup ? 'this.setup();':'')+ 
+      codeForEvent(options,'afterSetup')+
+      '};if(this.state=="running"){'+
+      'pos=this.options.transition(pos)*'+this.fromToDelta+'+'+this.options.from+';'+
+      'this.position=pos;'+
+      codeForEvent(options,'beforeUpdate')+
+      (this.update ? 'this.update(pos);':'')+
+      codeForEvent(options,'afterUpdate')+
+      '}}');
+    
     this.event('beforeStart');
     if(!this.options.sync)
       Effect.Queues.get(typeof this.options.queue == 'string' ? 
@@ -288,31 +295,14 @@
         this.event('afterFinish');
         return;  
       }
-      var pos   = (timePos - this.startOn) / (this.finishOn - this.startOn);
-      var frame = Math.round(pos * this.options.fps * this.options.duration);
+      var pos   = (timePos - this.startOn) / this.totalTime,
+          frame = Math.round(pos * this.totalFrames);
       if(frame > this.currentFrame) {
         this.render(pos);
         this.currentFrame = frame;
       }
     }
   },
-  render: function(pos) {
-    if(this.state == 'idle') {
-      this.state = 'running';
-      this.event('beforeSetup');
-      if(this.setup) this.setup();
-      this.event('afterSetup');
-    }
-    if(this.state == 'running') {
-      if(this.options.transition) pos = this.options.transition(pos);
-      pos *= (this.options.to-this.options.from);
-      pos += this.options.from;
-      this.position = pos;
-      this.event('beforeUpdate');
-      if(this.update) this.update(pos);
-      this.event('afterUpdate');
-    }
-  },
   cancel: function() {
     if(!this.options.sync)
       Effect.Queues.get(typeof this.options.queue == 'string' ? 
@@ -324,7 +314,10 @@
     if(this.options[eventName]) this.options[eventName](this);
   },
   inspect: function() {
-    return '#<Effect:' + $H(this).inspect() + ',options:' + $H(this.options).inspect() + '>';
+    var data = $H();
+    for(property in this)
+      if(typeof this[property] != 'function') data[property] = this[property];
+    return '#<Effect:' + data.inspect() + ',options:' + $H(this.options).inspect() + '>';
   }
 }
 
@@ -348,12 +341,24 @@
   }
 });
 
+Effect.Event = Class.create();
+Object.extend(Object.extend(Effect.Event.prototype, Effect.Base.prototype), {
+  initialize: function() {
+    var options = Object.extend({
+      duration: 0
+    }, arguments[0] || {});
+    this.start(options);
+  },
+  update: Prototype.emptyFunction
+});
+
 Effect.Opacity = Class.create();
 Object.extend(Object.extend(Effect.Opacity.prototype, Effect.Base.prototype), {
   initialize: function(element) {
     this.element = $(element);
+    if(!this.element) throw(Effect._elementDoesNotExistError);
     // make this work on IE on elements without 'layout'
-    if(/MSIE/.test(navigator.userAgent) && (!this.element.hasLayout))
+    if(Prototype.Browser.IE && (!this.element.currentStyle.hasLayout))
       this.element.setStyle({zoom: 1});
     var options = Object.extend({
       from: this.element.getOpacity() || 0.0,
@@ -370,6 +375,7 @@
 Object.extend(Object.extend(Effect.Move.prototype, Effect.Base.prototype), {
   initialize: function(element) {
     this.element = $(element);
+    if(!this.element) throw(Effect._elementDoesNotExistError);
     var options = Object.extend({
       x:    0,
       y:    0,
@@ -393,8 +399,8 @@
   },
   update: function(position) {
     this.element.setStyle({
-      left: this.options.x  * position + this.originalLeft + 'px',
-      top:  this.options.y  * position + this.originalTop  + 'px'
+      left: Math.round(this.options.x  * position + this.originalLeft) + 'px',
+      top:  Math.round(this.options.y  * position + this.originalTop)  + 'px'
     });
   }
 });
@@ -408,7 +414,8 @@
 Effect.Scale = Class.create();
 Object.extend(Object.extend(Effect.Scale.prototype, Effect.Base.prototype), {
   initialize: function(element, percent) {
-    this.element = $(element)
+    this.element = $(element);
+    if(!this.element) throw(Effect._elementDoesNotExistError);
     var options = Object.extend({
       scaleX: true,
       scaleY: true,
@@ -433,7 +440,7 @@
     this.originalLeft = this.element.offsetLeft;
     
     var fontSize = this.element.getStyle('font-size') || '100%';
-    ['em','px','%'].each( function(fontSizeType) {
+    ['em','px','%','pt'].each( function(fontSizeType) {
       if(fontSize.indexOf(fontSizeType)>0) {
         this.fontSize     = parseFloat(fontSize);
         this.fontSizeType = fontSizeType;
@@ -458,12 +465,12 @@
     this.setDimensions(this.dims[0] * currentScale, this.dims[1] * currentScale);
   },
   finish: function(position) {
-    if (this.restoreAfterFinish) this.element.setStyle(this.originalStyle);
+    if(this.restoreAfterFinish) this.element.setStyle(this.originalStyle);
   },
   setDimensions: function(height, width) {
     var d = {};
-    if(this.options.scaleX) d.width = width + 'px';
-    if(this.options.scaleY) d.height = height + 'px';
+    if(this.options.scaleX) d.width = Math.round(width) + 'px';
+    if(this.options.scaleY) d.height = Math.round(height) + 'px';
     if(this.options.scaleFromCenter) {
       var topd  = (height - this.dims[0])/2;
       var leftd = (width  - this.dims[1])/2;
@@ -483,6 +490,7 @@
 Object.extend(Object.extend(Effect.Highlight.prototype, Effect.Base.prototype), {
   initialize: function(element) {
     this.element = $(element);
+    if(!this.element) throw(Effect._elementDoesNotExistError);
     var options = Object.extend({ startcolor: '#ffff99' }, arguments[1] || {});
     this.start(options);
   },
@@ -490,9 +498,11 @@
     // Prevent executing on elements not in the layout flow
     if(this.element.getStyle('display')=='none') { this.cancel(); return; }
     // Disable background image during the effect
-    this.oldStyle = {
-      backgroundImage: this.element.getStyle('background-image') };
-    this.element.setStyle({backgroundImage: 'none'});
+    this.oldStyle = {};
+    if (!this.options.keepBackgroundImage) {
+      this.oldStyle.backgroundImage = this.element.getStyle('background-image');
+      this.element.setStyle({backgroundImage: 'none'});
+    }
     if(!this.options.endcolor)
       this.options.endcolor = this.element.getStyle('background-color').parseColor('#ffffff');
     if(!this.options.restorecolor)
@@ -547,8 +557,7 @@
   to:   0.0,
   afterFinishInternal: function(effect) { 
     if(effect.options.to!=0) return;
-    effect.element.hide();
-    effect.element.setStyle({opacity: oldOpacity}); 
+    effect.element.hide().setStyle({opacity: oldOpacity}); 
   }}, arguments[1] || {});
   return new Effect.Opacity(element,options);
 }
@@ -563,25 +572,31 @@
     effect.element.forceRerendering();
   },
   beforeSetup: function(effect) {
-    effect.element.setOpacity(effect.options.from);
-    effect.element.show(); 
+    effect.element.setOpacity(effect.options.from).show(); 
   }}, arguments[1] || {});
   return new Effect.Opacity(element,options);
 }
 
 Effect.Puff = function(element) {
   element = $(element);
-  var oldStyle = { opacity: element.getInlineOpacity(), position: element.getStyle('position') };
+  var oldStyle = { 
+    opacity: element.getInlineOpacity(), 
+    position: element.getStyle('position'),
+    top:  element.style.top,
+    left: element.style.left,
+    width: element.style.width,
+    height: element.style.height
+  };
   return new Effect.Parallel(
    [ new Effect.Scale(element, 200, 
       { sync: true, scaleFromCenter: true, scaleContent: true, restoreAfterFinish: true }), 
      new Effect.Opacity(element, { sync: true, to: 0.0 } ) ], 
      Object.extend({ duration: 1.0, 
       beforeSetupInternal: function(effect) {
-        effect.effects[0].element.setStyle({position: 'absolute'}); },
+        Position.absolutize(effect.effects[0].element)
+      },
       afterFinishInternal: function(effect) {
-         effect.effects[0].element.hide();
-         effect.effects[0].element.setStyle(oldStyle); }
+         effect.effects[0].element.hide().setStyle(oldStyle); }
      }, arguments[1] || {})
    );
 }
@@ -589,13 +604,12 @@
 Effect.BlindUp = function(element) {
   element = $(element);
   element.makeClipping();
-  return new Effect.Scale(element, 0, 
+  return new Effect.Scale(element, 0,
     Object.extend({ scaleContent: false, 
       scaleX: false, 
       restoreAfterFinish: true,
       afterFinishInternal: function(effect) {
-        effect.element.hide();
-        effect.element.undoClipping();
+        effect.element.hide().undoClipping();
       } 
     }, arguments[1] || {})
   );
@@ -604,28 +618,25 @@
 Effect.BlindDown = function(element) {
   element = $(element);
   var elementDimensions = element.getDimensions();
-  return new Effect.Scale(element, 100, 
-    Object.extend({ scaleContent: false, 
-      scaleX: false,
-      scaleFrom: 0,
-      scaleMode: {originalHeight: elementDimensions.height, originalWidth: elementDimensions.width},
-      restoreAfterFinish: true,
-      afterSetup: function(effect) {
-        effect.element.makeClipping();
-        effect.element.setStyle({height: '0px'});
-        effect.element.show(); 
-      },  
-      afterFinishInternal: function(effect) {
-        effect.element.undoClipping();
-      }
-    }, arguments[1] || {})
-  );
+  return new Effect.Scale(element, 100, Object.extend({ 
+    scaleContent: false, 
+    scaleX: false,
+    scaleFrom: 0,
+    scaleMode: {originalHeight: elementDimensions.height, originalWidth: elementDimensions.width},
+    restoreAfterFinish: true,
+    afterSetup: function(effect) {
+      effect.element.makeClipping().setStyle({height: '0px'}).show(); 
+    },  
+    afterFinishInternal: function(effect) {
+      effect.element.undoClipping();
+    }
+  }, arguments[1] || {}));
 }
 
 Effect.SwitchOff = function(element) {
   element = $(element);
   var oldOpacity = element.getInlineOpacity();
-  return new Effect.Appear(element, { 
+  return new Effect.Appear(element, Object.extend({
     duration: 0.4,
     from: 0,
     transition: Effect.Transitions.flicker,
@@ -634,18 +645,14 @@
         duration: 0.3, scaleFromCenter: true,
         scaleX: false, scaleContent: false, restoreAfterFinish: true,
         beforeSetup: function(effect) { 
-          effect.element.makePositioned();
-          effect.element.makeClipping();
+          effect.element.makePositioned().makeClipping();
         },
         afterFinishInternal: function(effect) {
-          effect.element.hide();
-          effect.element.undoClipping();
-          effect.element.undoPositioned();
-          effect.element.setStyle({opacity: oldOpacity});
+          effect.element.hide().undoClipping().undoPositioned().setStyle({opacity: oldOpacity});
         }
       })
     }
-  });
+  }, arguments[1] || {}));
 }
 
 Effect.DropOut = function(element) {
@@ -663,9 +670,7 @@
           effect.effects[0].element.makePositioned(); 
         },
         afterFinishInternal: function(effect) {
-          effect.effects[0].element.hide();
-          effect.effects[0].element.undoPositioned();
-          effect.effects[0].element.setStyle(oldStyle);
+          effect.effects[0].element.hide().undoPositioned().setStyle(oldStyle);
         } 
       }, arguments[1] || {}));
 }
@@ -687,16 +692,14 @@
       { x:  40, y: 0, duration: 0.1,  afterFinishInternal: function(effect) {
     new Effect.Move(effect.element,
       { x: -20, y: 0, duration: 0.05, afterFinishInternal: function(effect) {
-        effect.element.undoPositioned();
-        effect.element.setStyle(oldStyle);
+        effect.element.undoPositioned().setStyle(oldStyle);
   }}) }}) }}) }}) }}) }});
 }
 
 Effect.SlideDown = function(element) {
-  element = $(element);
-  element.cleanWhitespace();
+  element = $(element).cleanWhitespace();
   // SlideDown need to have the content of the element wrapped in a container element with fixed height!
-  var oldInnerBottom = $(element.firstChild).getStyle('bottom');
+  var oldInnerBottom = element.down().getStyle('bottom');
   var elementDimensions = element.getDimensions();
   return new Effect.Scale(element, 100, Object.extend({ 
     scaleContent: false, 
@@ -706,34 +709,24 @@
     restoreAfterFinish: true,
     afterSetup: function(effect) {
       effect.element.makePositioned();
-      effect.element.firstChild.makePositioned();
+      effect.element.down().makePositioned();
       if(window.opera) effect.element.setStyle({top: ''});
-      effect.element.makeClipping();
-      effect.element.setStyle({height: '0px'});
-      effect.element.show(); },
+      effect.element.makeClipping().setStyle({height: '0px'}).show(); 
+    },
     afterUpdateInternal: function(effect) {
-      effect.element.firstChild.setStyle({bottom:
+      effect.element.down().setStyle({bottom:
         (effect.dims[0] - effect.element.clientHeight) + 'px' }); 
     },
     afterFinishInternal: function(effect) {
-      effect.element.undoClipping(); 
-      // IE will crash if child is undoPositioned first
-      if(/MSIE/.test(navigator.userAgent)){
-        effect.element.undoPositioned();
-        effect.element.firstChild.undoPositioned();
-      }else{
-        effect.element.firstChild.undoPositioned();
-        effect.element.undoPositioned();
-      }
-      effect.element.firstChild.setStyle({bottom: oldInnerBottom}); }
+      effect.element.undoClipping().undoPositioned();
+      effect.element.down().undoPositioned().setStyle({bottom: oldInnerBottom}); }
     }, arguments[1] || {})
   );
 }
-  
+
 Effect.SlideUp = function(element) {
-  element = $(element);
-  element.cleanWhitespace();
-  var oldInnerBottom = $(element.firstChild).getStyle('bottom');
+  element = $(element).cleanWhitespace();
+  var oldInnerBottom = element.down().getStyle('bottom');
   return new Effect.Scale(element, window.opera ? 0 : 1,
    Object.extend({ scaleContent: false, 
     scaleX: false, 
@@ -742,32 +735,32 @@
     restoreAfterFinish: true,
     beforeStartInternal: function(effect) {
       effect.element.makePositioned();
-      effect.element.firstChild.makePositioned();
+      effect.element.down().makePositioned();
       if(window.opera) effect.element.setStyle({top: ''});
-      effect.element.makeClipping();
-      effect.element.show(); },  
+      effect.element.makeClipping().show();
+    },  
     afterUpdateInternal: function(effect) {
-      effect.element.firstChild.setStyle({bottom:
-        (effect.dims[0] - effect.element.clientHeight) + 'px' }); },
+      effect.element.down().setStyle({bottom:
+        (effect.dims[0] - effect.element.clientHeight) + 'px' });
+    },
     afterFinishInternal: function(effect) {
-      effect.element.hide();
-      effect.element.undoClipping();
-      effect.element.firstChild.undoPositioned();
-      effect.element.undoPositioned();
-      effect.element.setStyle({bottom: oldInnerBottom}); }
+      effect.element.hide().undoClipping().undoPositioned().setStyle({bottom: oldInnerBottom});
+      effect.element.down().undoPositioned();
+    }
    }, arguments[1] || {})
   );
 }
 
 // Bug in opera makes the TD containing this element expand for a instance after finish 
 Effect.Squish = function(element) {
-  return new Effect.Scale(element, window.opera ? 1 : 0, 
-    { restoreAfterFinish: true,
-      beforeSetup: function(effect) {
-        effect.element.makeClipping(effect.element); },  
-      afterFinishInternal: function(effect) {
-        effect.element.hide(effect.element); 
-        effect.element.undoClipping(effect.element); }
+  return new Effect.Scale(element, window.opera ? 1 : 0, { 
+    restoreAfterFinish: true,
+    beforeSetup: function(effect) {
+      effect.element.makeClipping(); 
+    },  
+    afterFinishInternal: function(effect) {
+      effect.element.hide().undoClipping(); 
+    }
   });
 }
 
@@ -823,9 +816,7 @@
     y: initialMoveY,
     duration: 0.01, 
     beforeSetup: function(effect) {
-      effect.element.hide();
-      effect.element.makeClipping();
-      effect.element.makePositioned();
+      effect.element.hide().makeClipping().makePositioned();
     },
     afterFinishInternal: function(effect) {
       new Effect.Parallel(
@@ -836,13 +827,10 @@
             sync: true, scaleFrom: window.opera ? 1 : 0, transition: options.scaleTransition, restoreAfterFinish: true})
         ], Object.extend({
              beforeSetup: function(effect) {
-               effect.effects[0].element.setStyle({height: '0px'});
-               effect.effects[0].element.show(); 
+               effect.effects[0].element.setStyle({height: '0px'}).show(); 
              },
              afterFinishInternal: function(effect) {
-               effect.effects[0].element.undoClipping();
-               effect.effects[0].element.undoPositioned();
-               effect.effects[0].element.setStyle(oldStyle); 
+               effect.effects[0].element.undoClipping().undoPositioned().setStyle(oldStyle); 
              }
            }, options)
       )
@@ -896,13 +884,10 @@
       new Effect.Move(element, { x: moveX, y: moveY, sync: true, transition: options.moveTransition })
     ], Object.extend({            
          beforeStartInternal: function(effect) {
-           effect.effects[0].element.makePositioned();
-           effect.effects[0].element.makeClipping(); },
+           effect.effects[0].element.makePositioned().makeClipping(); 
+         },
          afterFinishInternal: function(effect) {
-           effect.effects[0].element.hide();
-           effect.effects[0].element.undoClipping();
-           effect.effects[0].element.undoPositioned();
-           effect.effects[0].element.setStyle(oldStyle); }
+           effect.effects[0].element.hide().undoClipping().undoPositioned().setStyle(oldStyle); }
        }, options)
   );
 }
@@ -912,10 +897,10 @@
   var options    = arguments[1] || {};
   var oldOpacity = element.getInlineOpacity();
   var transition = options.transition || Effect.Transitions.sinoidal;
-  var reverser   = function(pos){ return transition(1-Effect.Transitions.pulse(pos)) };
+  var reverser   = function(pos){ return transition(1-Effect.Transitions.pulse(pos, options.pulses)) };
   reverser.bind(transition);
   return new Effect.Opacity(element, 
-    Object.extend(Object.extend({  duration: 3.0, from: 0,
+    Object.extend(Object.extend({  duration: 2.0, from: 0,
       afterFinishInternal: function(effect) { effect.element.setStyle({opacity: oldOpacity}); }
     }, options), {transition: reverser}));
 }
@@ -927,7 +912,7 @@
     left: element.style.left,
     width: element.style.width,
     height: element.style.height };
-  Element.makeClipping(element);
+  element.makeClipping();
   return new Effect.Scale(element, 5, Object.extend({   
     scaleContent: false,
     scaleX: false,
@@ -936,20 +921,171 @@
       scaleContent: false, 
       scaleY: false,
       afterFinishInternal: function(effect) {
-        effect.element.hide();
-        effect.element.undoClipping(); 
-        effect.element.setStyle(oldStyle);
+        effect.element.hide().undoClipping().setStyle(oldStyle);
       } });
   }}, arguments[1] || {}));
 };
 
-['setOpacity','getOpacity','getInlineOpacity','forceRerendering','setContentZoom',
- 'collectTextNodes','collectTextNodesIgnoreClass','childrenWithClassName'].each( 
+Effect.Morph = Class.create();
+Object.extend(Object.extend(Effect.Morph.prototype, Effect.Base.prototype), {
+  initialize: function(element) {
+    this.element = $(element);
+    if(!this.element) throw(Effect._elementDoesNotExistError);
+    var options = Object.extend({
+      style: {}
+    }, arguments[1] || {});
+    if (typeof options.style == 'string') {
+      if(options.style.indexOf(':') == -1) {
+        var cssText = '', selector = '.' + options.style;
+        $A(document.styleSheets).reverse().each(function(styleSheet) {
+          if (styleSheet.cssRules) cssRules = styleSheet.cssRules;
+          else if (styleSheet.rules) cssRules = styleSheet.rules;
+          $A(cssRules).reverse().each(function(rule) {
+            if (selector == rule.selectorText) {
+              cssText = rule.style.cssText;
+              throw $break;
+            }
+          });
+          if (cssText) throw $break;
+        });
+        this.style = cssText.parseStyle();
+        options.afterFinishInternal = function(effect){
+          effect.element.addClassName(effect.options.style);
+          effect.transforms.each(function(transform) {
+            if(transform.style != 'opacity')
+              effect.element.style[transform.style] = '';
+          });
+        }
+      } else this.style = options.style.parseStyle();
+    } else this.style = $H(options.style)
+    this.start(options);
+  },
+  setup: function(){
+    function parseColor(color){
+      if(!color || ['rgba(0, 0, 0, 0)','transparent'].include(color)) color = '#ffffff';
+      color = color.parseColor();
+      return $R(0,2).map(function(i){
+        return parseInt( color.slice(i*2+1,i*2+3), 16 ) 
+      });
+    }
+    this.transforms = this.style.map(function(pair){
+      var property = pair[0], value = pair[1], unit = null;
+
+      if(value.parseColor('#zzzzzz') != '#zzzzzz') {
+        value = value.parseColor();
+        unit  = 'color';
+      } else if(property == 'opacity') {
+        value = parseFloat(value);
+        if(Prototype.Browser.IE && (!this.element.currentStyle.hasLayout))
+          this.element.setStyle({zoom: 1});
+      } else if(Element.CSS_LENGTH.test(value)) {
+          var components = value.match(/^([\+\-]?[0-9\.]+)(.*)$/);
+          value = parseFloat(components[1]);
+          unit = (components.length == 3) ? components[2] : null;
+      }
+
+      var originalValue = this.element.getStyle(property);
+      return { 
+        style: property.camelize(), 
+        originalValue: unit=='color' ? parseColor(originalValue) : parseFloat(originalValue || 0), 
+        targetValue: unit=='color' ? parseColor(value) : value,
+        unit: unit
+      };
+    }.bind(this)).reject(function(transform){
+      return (
+        (transform.originalValue == transform.targetValue) ||
+        (
+          transform.unit != 'color' &&
+          (isNaN(transform.originalValue) || isNaN(transform.targetValue))
+        )
+      )
+    });
+  },
+  update: function(position) {
+    var style = {}, transform, i = this.transforms.length;
+    while(i--)
+      style[(transform = this.transforms[i]).style] = 
+        transform.unit=='color' ? '#'+
+          (Math.round(transform.originalValue[0]+
+            (transform.targetValue[0]-transform.originalValue[0])*position)).toColorPart() +
+          (Math.round(transform.originalValue[1]+
+            (transform.targetValue[1]-transform.originalValue[1])*position)).toColorPart() +
+          (Math.round(transform.originalValue[2]+
+            (transform.targetValue[2]-transform.originalValue[2])*position)).toColorPart() :
+        transform.originalValue + Math.round(
+          ((transform.targetValue - transform.originalValue) * position) * 1000)/1000 + transform.unit;
+    this.element.setStyle(style, true);
+  }
+});
+
+Effect.Transform = Class.create();
+Object.extend(Effect.Transform.prototype, {
+  initialize: function(tracks){
+    this.tracks  = [];
+    this.options = arguments[1] || {};
+    this.addTracks(tracks);
+  },
+  addTracks: function(tracks){
+    tracks.each(function(track){
+      var data = $H(track).values().first();
+      this.tracks.push($H({
+        ids:     $H(track).keys().first(),
+        effect:  Effect.Morph,
+        options: { style: data }
+      }));
+    }.bind(this));
+    return this;
+  },
+  play: function(){
+    return new Effect.Parallel(
+      this.tracks.map(function(track){
+        var elements = [$(track.ids) || $$(track.ids)].flatten();
+        return elements.map(function(e){ return new track.effect(e, Object.extend({ sync:true }, track.options)) });
+      }).flatten(),
+      this.options
+    );
+  }
+});
+
+Element.CSS_PROPERTIES = $w(
+  'backgroundColor backgroundPosition borderBottomColor borderBottomStyle ' + 
+  'borderBottomWidth borderLeftColor borderLeftStyle borderLeftWidth ' +
+  'borderRightColor borderRightStyle borderRightWidth borderSpacing ' +
+  'borderTopColor borderTopStyle borderTopWidth bottom clip color ' +
+  'fontSize fontWeight height left letterSpacing lineHeight ' +
+  'marginBottom marginLeft marginRight marginTop markerOffset maxHeight '+
+  'maxWidth minHeight minWidth opacity outlineColor outlineOffset ' +
+  'outlineWidth paddingBottom paddingLeft paddingRight paddingTop ' +
+  'right textIndent top width wordSpacing zIndex');
+  
+Element.CSS_LENGTH = /^(([\+\-]?[0-9\.]+)(em|ex|px|in|cm|mm|pt|pc|\%))|0$/;
+
+String.prototype.parseStyle = function(){
+  var element = document.createElement('div');
+  element.innerHTML = '<div style="' + this + '"></div>';
+  var style = element.childNodes[0].style, styleRules = $H();
+  
+  Element.CSS_PROPERTIES.each(function(property){
+    if(style[property]) styleRules[property] = style[property]; 
+  });
+  if(Prototype.Browser.IE && this.indexOf('opacity') > -1) {
+    styleRules.opacity = this.match(/opacity:\s*((?:0|1)?(?:\.\d*)?)/)[1];
+  }
+  return styleRules;
+};
+
+Element.morph = function(element, style) {
+  new Effect.Morph(element, Object.extend({ style: style }, arguments[2] || {}));
+  return element;
+};
+
+['getInlineOpacity','forceRerendering','setContentZoom',
+ 'collectTextNodes','collectTextNodesIgnoreClass','morph'].each( 
   function(f) { Element.Methods[f] = Element[f]; }
 );
 
 Element.Methods.visualEffect = function(element, effect, options) {
-  s = effect.gsub(/_/, '-').camelize();
+  s = effect.dasherize().camelize();
   effect_class = s.charAt(0).toUpperCase() + s.substring(1);
   new Effect[effect_class](element, options);
   return $(element);

Modified: trunk/skel/public/javascript/prototype.js
===================================================================
--- trunk/skel/public/javascript/prototype.js	2007-06-12 14:45:22 UTC (rev 432)
+++ trunk/skel/public/javascript/prototype.js	2007-06-15 07:57:36 UTC (rev 433)
@@ -1,17 +1,34 @@
-/*  Prototype JavaScript framework, version 1.5.0_rc0
- *  (c) 2005 Sam Stephenson <sam at conio.net>
+/*  Prototype JavaScript framework, version 1.5.1
+ *  (c) 2005-2007 Sam Stephenson
  *
  *  Prototype is freely distributable under the terms of an MIT-style license.
- *  For details, see the Prototype web site: http://prototype.conio.net/
+ *  For details, see the Prototype web site: http://www.prototypejs.org/
  *
 /*--------------------------------------------------------------------------*/
 
 var Prototype = {
-  Version: '1.5.0_rc0',
-  ScriptFragment: '(?:<script.*?>)((\n|\r|.)*?)(?:<\/script>)',
+  Version: '1.5.1',
 
-  emptyFunction: function() {},
-  K: function(x) {return x}
+  Browser: {
+    IE:     !!(window.attachEvent && !window.opera),
+    Opera:  !!window.opera,
+    WebKit: navigator.userAgent.indexOf('AppleWebKit/') > -1,
+    Gecko:  navigator.userAgent.indexOf('Gecko') > -1 && navigator.userAgent.indexOf('KHTML') == -1
+  },
+
+  BrowserFeatures: {
+    XPath: !!document.evaluate,
+    ElementExtensions: !!window.HTMLElement,
+    SpecificElementExtensions:
+      (document.createElement('div').__proto__ !==
+       document.createElement('form').__proto__)
+  },
+
+  ScriptFragment: '<script[^>]*>([\u0001-\uFFFF]*?)</script>',
+  JSONFilter: /^\/\*-secure-\s*(.*)\s*\*\/\s*$/,
+
+  emptyFunction: function() { },
+  K: function(x) { return x }
 }
 
 var Class = {
@@ -31,16 +48,56 @@
   return destination;
 }
 
-Object.inspect = function(object) {
-  try {
-    if (object == undefined) return 'undefined';
-    if (object == null) return 'null';
-    return object.inspect ? object.inspect() : object.toString();
-  } catch (e) {
-    if (e instanceof RangeError) return '...';
-    throw e;
+Object.extend(Object, {
+  inspect: function(object) {
+    try {
+      if (object === undefined) return 'undefined';
+      if (object === null) return 'null';
+      return object.inspect ? object.inspect() : object.toString();
+    } catch (e) {
+      if (e instanceof RangeError) return '...';
+      throw e;
+    }
+  },
+
+  toJSON: function(object) {
+    var type = typeof object;
+    switch(type) {
+      case 'undefined':
+      case 'function':
+      case 'unknown': return;
+      case 'boolean': return object.toString();
+    }
+    if (object === null) return 'null';
+    if (object.toJSON) return object.toJSON();
+    if (object.ownerDocument === document) return;
+    var results = [];
+    for (var property in object) {
+      var value = Object.toJSON(object[property]);
+      if (value !== undefined)
+        results.push(property.toJSON() + ': ' + value);
+    }
+    return '{' + results.join(', ') + '}';
+  },
+
+  keys: function(object) {
+    var keys = [];
+    for (var property in object)
+      keys.push(property);
+    return keys;
+  },
+
+  values: function(object) {
+    var values = [];
+    for (var property in object)
+      values.push(object[property]);
+    return values;
+  },
+
+  clone: function(object) {
+    return Object.extend({}, object);
   }
-}
+});
 
 Function.prototype.bind = function() {
   var __method = this, args = $A(arguments), object = args.shift();
@@ -50,17 +107,15 @@
 }
 
 Function.prototype.bindAsEventListener = function(object) {
-  var __method = this;
+  var __method = this, args = $A(arguments), object = args.shift();
   return function(event) {
-    return __method.call(object, event || window.event);
+    return __method.apply(object, [event || window.event].concat(args));
   }
 }
 
 Object.extend(Number.prototype, {
   toColorPart: function() {
-    var digits = this.toString(16);
-    if (this < 16) return '0' + digits;
-    return digits;
+    return this.toPaddedString(2, 16);
   },
 
   succ: function() {
@@ -70,14 +125,32 @@
   times: function(iterator) {
     $R(0, this, true).each(iterator);
     return this;
+  },
+
+  toPaddedString: function(length, radix) {
+    var string = this.toString(radix || 10);
+    return '0'.times(length - string.length) + string;
+  },
+
+  toJSON: function() {
+    return isFinite(this) ? this.toString() : 'null';
   }
 });
 
+Date.prototype.toJSON = function() {
+  return '"' + this.getFullYear() + '-' +
+    (this.getMonth() + 1).toPaddedString(2) + '-' +
+    this.getDate().toPaddedString(2) + 'T' +
+    this.getHours().toPaddedString(2) + ':' +
+    this.getMinutes().toPaddedString(2) + ':' +
+    this.getSeconds().toPaddedString(2) + '"';
+};
+
 var Try = {
   these: function() {
     var returnValue;
 
-    for (var i = 0; i < arguments.length; i++) {
+    for (var i = 0, length = arguments.length; i < length; i++) {
       var lambda = arguments[i];
       try {
         returnValue = lambda();
@@ -102,20 +175,40 @@
   },
 
   registerCallback: function() {
-    setInterval(this.onTimerEvent.bind(this), this.frequency * 1000);
+    this.timer = setInterval(this.onTimerEvent.bind(this), this.frequency * 1000);
   },
 
+  stop: function() {
+    if (!this.timer) return;
+    clearInterval(this.timer);
+    this.timer = null;
+  },
+
   onTimerEvent: function() {
     if (!this.currentlyExecuting) {
       try {
         this.currentlyExecuting = true;
-        this.callback();
+        this.callback(this);
       } finally {
         this.currentlyExecuting = false;
       }
     }
   }
 }
+Object.extend(String, {
+  interpret: function(value) {
+    return value == null ? '' : String(value);
+  },
+  specialChar: {
+    '\b': '\\b',
+    '\t': '\\t',
+    '\n': '\\n',
+    '\f': '\\f',
+    '\r': '\\r',
+    '\\': '\\\\'
+  }
+});
+
 Object.extend(String.prototype, {
   gsub: function(pattern, replacement) {
     var result = '', source = this, match;
@@ -124,7 +217,7 @@
     while (source.length > 0) {
       if (match = source.match(pattern)) {
         result += source.slice(0, match.index);
-        result += (replacement(match) || '').toString();
+        result += String.interpret(replacement(match));
         source  = source.slice(match.index + match[0].length);
       } else {
         result += source, source = '';
@@ -180,24 +273,36 @@
   },
 
   escapeHTML: function() {
-    var div = document.createElement('div');
-    var text = document.createTextNode(this);
-    div.appendChild(text);
-    return div.innerHTML;
+    var self = arguments.callee;
+    self.text.data = this;
+    return self.div.innerHTML;
   },
 
   unescapeHTML: function() {
     var div = document.createElement('div');
     div.innerHTML = this.stripTags();
-    return div.childNodes[0] ? div.childNodes[0].nodeValue : '';
+    return div.childNodes[0] ? (div.childNodes.length > 1 ?
+      $A(div.childNodes).inject('', function(memo, node) { return memo+node.nodeValue }) :
+      div.childNodes[0].nodeValue) : '';
   },
 
-  toQueryParams: function() {
-    var pairs = this.match(/^\??(.*)$/)[1].split('&');
-    return pairs.inject({}, function(params, pairString) {
-      var pair = pairString.split('=');
-      params[pair[0]] = pair[1];
-      return params;
+  toQueryParams: function(separator) {
+    var match = this.strip().match(/([^?#]*)(#.*)?$/);
+    if (!match) return {};
+
+    return match[1].split(separator || '&').inject({}, function(hash, pair) {
+      if ((pair = pair.split('='))[0]) {
+        var key = decodeURIComponent(pair.shift());
+        var value = pair.length > 1 ? pair.join('=') : pair[0];
+        if (value != undefined) value = decodeURIComponent(value);
+
+        if (key in hash) {
+          if (hash[key].constructor != Array) hash[key] = [hash[key]];
+          hash[key].push(value);
+        }
+        else hash[key] = value;
+      }
+      return hash;
     });
   },
 
@@ -205,27 +310,100 @@
     return this.split('');
   },
 
+  succ: function() {
+    return this.slice(0, this.length - 1) +
+      String.fromCharCode(this.charCodeAt(this.length - 1) + 1);
+  },
+
+  times: function(count) {
+    var result = '';
+    for (var i = 0; i < count; i++) result += this;
+    return result;
+  },
+
   camelize: function() {
-    var oStringList = this.split('-');
-    if (oStringList.length == 1) return oStringList[0];
+    var parts = this.split('-'), len = parts.length;
+    if (len == 1) return parts[0];
 
-    var camelizedString = this.indexOf('-') == 0
-      ? oStringList[0].charAt(0).toUpperCase() + oStringList[0].substring(1)
-      : oStringList[0];
+    var camelized = this.charAt(0) == '-'
+      ? parts[0].charAt(0).toUpperCase() + parts[0].substring(1)
+      : parts[0];
 
-    for (var i = 1, len = oStringList.length; i < len; i++) {
-      var s = oStringList[i];
-      camelizedString += s.charAt(0).toUpperCase() + s.substring(1);
-    }
+    for (var i = 1; i < len; i++)
+      camelized += parts[i].charAt(0).toUpperCase() + parts[i].substring(1);
 
-    return camelizedString;
+    return camelized;
   },
 
-  inspect: function() {
-    return "'" + this.replace(/\\/g, '\\\\').replace(/'/g, '\\\'') + "'";
+  capitalize: function() {
+    return this.charAt(0).toUpperCase() + this.substring(1).toLowerCase();
+  },
+
+  underscore: function() {
+    return this.gsub(/::/, '/').gsub(/([A-Z]+)([A-Z][a-z])/,'#{1}_#{2}').gsub(/([a-z\d])([A-Z])/,'#{1}_#{2}').gsub(/-/,'_').toLowerCase();
+  },
+
+  dasherize: function() {
+    return this.gsub(/_/,'-');
+  },
+
+  inspect: function(useDoubleQuotes) {
+    var escapedString = this.gsub(/[\x00-\x1f\\]/, function(match) {
+      var character = String.specialChar[match[0]];
+      return character ? character : '\\u00' + match[0].charCodeAt().toPaddedString(2, 16);
+    });
+    if (useDoubleQuotes) return '"' + escapedString.replace(/"/g, '\\"') + '"';
+    return "'" + escapedString.replace(/'/g, '\\\'') + "'";
+  },
+
+  toJSON: function() {
+    return this.inspect(true);
+  },
+
+  unfilterJSON: function(filter) {
+    return this.sub(filter || Prototype.JSONFilter, '#{1}');
+  },
+
+  evalJSON: function(sanitize) {
+    var json = this.unfilterJSON();
+    try {
+      if (!sanitize || (/^("(\\.|[^"\\\n\r])*?"|[,:{}\[\]0-9.\-+Eaeflnr-u \n\r\t])+?$/.test(json)))
+        return eval('(' + json + ')');
+    } catch (e) { }
+    throw new SyntaxError('Badly formed JSON string: ' + this.inspect());
+  },
+
+  include: function(pattern) {
+    return this.indexOf(pattern) > -1;
+  },
+
+  startsWith: function(pattern) {
+    return this.indexOf(pattern) === 0;
+  },
+
+  endsWith: function(pattern) {
+    var d = this.length - pattern.length;
+    return d >= 0 && this.lastIndexOf(pattern) === d;
+  },
+
+  empty: function() {
+    return this == '';
+  },
+
+  blank: function() {
+    return /^\s*$/.test(this);
   }
 });
 
+if (Prototype.Browser.WebKit || Prototype.Browser.IE) Object.extend(String.prototype, {
+  escapeHTML: function() {
+    return this.replace(/&/g,'&amp;').replace(/</g,'&lt;').replace(/>/g,'&gt;');
+  },
+  unescapeHTML: function() {
+    return this.replace(/&amp;/g,'&').replace(/&lt;/g,'<').replace(/&gt;/g,'>');
+  }
+});
+
 String.prototype.gsub.prepareReplacement = function(replacement) {
   if (typeof replacement == 'function') return replacement;
   var template = new Template(replacement);
@@ -234,6 +412,13 @@
 
 String.prototype.parseQuery = String.prototype.toQueryParams;
 
+Object.extend(String.prototype.escapeHTML, {
+  div:  document.createElement('div'),
+  text: document.createTextNode('')
+});
+
+with (String.prototype.escapeHTML) div.appendChild(text);
+
 var Template = Class.create();
 Template.Pattern = /(^|.|\r|\n)(#\{(.*?)\})/;
 Template.prototype = {
@@ -246,30 +431,33 @@
     return this.template.gsub(this.pattern, function(match) {
       var before = match[1];
       if (before == '\\') return match[2];
-      return before + (object[match[3]] || '').toString();
+      return before + String.interpret(object[match[3]]);
     });
   }
 }
 
-var $break    = new Object();
-var $continue = new Object();
+var $break = {}, $continue = new Error('"throw $continue" is deprecated, use "return" instead');
 
 var Enumerable = {
   each: function(iterator) {
     var index = 0;
     try {
       this._each(function(value) {
-        try {
-          iterator(value, index++);
-        } catch (e) {
-          if (e != $continue) throw e;
-        }
+        iterator(value, index++);
       });
     } catch (e) {
       if (e != $break) throw e;
     }
+    return this;
   },
 
+  eachSlice: function(number, iterator) {
+    var index = -number, slices = [], array = this.toArray();
+    while ((index += number) < array.length)
+      slices.push(array.slice(index, index+number));
+    return slices.map(iterator);
+  },
+
   all: function(iterator) {
     var result = true;
     this.each(function(value, index) {
@@ -280,7 +468,7 @@
   },
 
   any: function(iterator) {
-    var result = true;
+    var result = false;
     this.each(function(value, index) {
       if (result = !!(iterator || Prototype.K)(value, index))
         throw $break;
@@ -291,12 +479,12 @@
   collect: function(iterator) {
     var results = [];
     this.each(function(value, index) {
-      results.push(iterator(value, index));
+      results.push((iterator || Prototype.K)(value, index));
     });
     return results;
   },
 
-  detect: function (iterator) {
+  detect: function(iterator) {
     var result;
     this.each(function(value, index) {
       if (iterator(value, index)) {
@@ -337,6 +525,14 @@
     return found;
   },
 
+  inGroupsOf: function(number, fillWith) {
+    fillWith = fillWith === undefined ? null : fillWith;
+    return this.eachSlice(number, function(slice) {
+      while(slice.length < number) slice.push(fillWith);
+      return slice;
+    });
+  },
+
   inject: function(memo, iterator) {
     this.each(function(value, index) {
       memo = iterator(memo, value, index);
@@ -346,7 +542,7 @@
 
   invoke: function(method) {
     var args = $A(arguments).slice(1);
-    return this.collect(function(value) {
+    return this.map(function(value) {
       return value[method].apply(value, args);
     });
   },
@@ -398,7 +594,7 @@
   },
 
   sortBy: function(iterator) {
-    return this.collect(function(value, index) {
+    return this.map(function(value, index) {
       return {value: value, criteria: iterator(value, index)};
     }).sort(function(left, right) {
       var a = left.criteria, b = right.criteria;
@@ -407,7 +603,7 @@
   },
 
   toArray: function() {
-    return this.collect(Prototype.K);
+    return this.map();
   },
 
   zip: function() {
@@ -421,6 +617,10 @@
     });
   },
 
+  size: function() {
+    return this.toArray().length;
+  },
+
   inspect: function() {
     return '#<Enumerable:' + this.toArray().inspect() + '>';
   }
@@ -439,12 +639,27 @@
     return iterable.toArray();
   } else {
     var results = [];
-    for (var i = 0; i < iterable.length; i++)
+    for (var i = 0, length = iterable.length; i < length; i++)
       results.push(iterable[i]);
     return results;
   }
 }
 
+if (Prototype.Browser.WebKit) {
+  $A = Array.from = function(iterable) {
+    if (!iterable) return [];
+    if (!(typeof iterable == 'function' && iterable == '[object NodeList]') &&
+      iterable.toArray) {
+      return iterable.toArray();
+    } else {
+      var results = [];
+      for (var i = 0, length = iterable.length; i < length; i++)
+        results.push(iterable[i]);
+      return results;
+    }
+  }
+}
+
 Object.extend(Array.prototype, Enumerable);
 
 if (!Array.prototype._reverse)
@@ -452,7 +667,7 @@
 
 Object.extend(Array.prototype, {
   _each: function(iterator) {
-    for (var i = 0; i < this.length; i++)
+    for (var i = 0, length = this.length; i < length; i++)
       iterator(this[i]);
   },
 
@@ -471,7 +686,7 @@
 
   compact: function() {
     return this.select(function(value) {
-      return value != undefined || value != null;
+      return value != null;
     });
   },
 
@@ -490,7 +705,7 @@
   },
 
   indexOf: function(object) {
-    for (var i = 0; i < this.length; i++)
+    for (var i = 0, length = this.length; i < length; i++)
       if (this[i] == object) return i;
     return -1;
   },
@@ -499,15 +714,110 @@
     return (inline !== false ? this : this.toArray())._reverse();
   },
 
+  reduce: function() {
+    return this.length > 1 ? this : this[0];
+  },
+
+  uniq: function(sorted) {
+    return this.inject([], function(array, value, index) {
+      if (0 == index || (sorted ? array.last() != value : !array.include(value)))
+        array.push(value);
+      return array;
+    });
+  },
+
+  clone: function() {
+    return [].concat(this);
+  },
+
+  size: function() {
+    return this.length;
+  },
+
   inspect: function() {
     return '[' + this.map(Object.inspect).join(', ') + ']';
+  },
+
+  toJSON: function() {
+    var results = [];
+    this.each(function(object) {
+      var value = Object.toJSON(object);
+      if (value !== undefined) results.push(value);
+    });
+    return '[' + results.join(', ') + ']';
   }
 });
-var Hash = {
+
+Array.prototype.toArray = Array.prototype.clone;
+
+function $w(string) {
+  string = string.strip();
+  return string ? string.split(/\s+/) : [];
+}
+
+if (Prototype.Browser.Opera){
+  Array.prototype.concat = function() {
+    var array = [];
+    for (var i = 0, length = this.length; i < length; i++) array.push(this[i]);
+    for (var i = 0, length = arguments.length; i < length; i++) {
+      if (arguments[i].constructor == Array) {
+        for (var j = 0, arrayLength = arguments[i].length; j < arrayLength; j++)
+          array.push(arguments[i][j]);
+      } else {
+        array.push(arguments[i]);
+      }
+    }
+    return array;
+  }
+}
+var Hash = function(object) {
+  if (object instanceof Hash) this.merge(object);
+  else Object.extend(this, object || {});
+};
+
+Object.extend(Hash, {
+  toQueryString: function(obj) {
+    var parts = [];
+    parts.add = arguments.callee.addPair;
+
+    this.prototype._each.call(obj, function(pair) {
+      if (!pair.key) return;
+      var value = pair.value;
+
+      if (value && typeof value == 'object') {
+        if (value.constructor == Array) value.each(function(value) {
+          parts.add(pair.key, value);
+        });
+        return;
+      }
+      parts.add(pair.key, value);
+    });
+
+    return parts.join('&');
+  },
+
+  toJSON: function(object) {
+    var results = [];
+    this.prototype._each.call(object, function(pair) {
+      var value = Object.toJSON(pair.value);
+      if (value !== undefined) results.push(pair.key.toJSON() + ': ' + value);
+    });
+    return '{' + results.join(', ') + '}';
+  }
+});
+
+Hash.toQueryString.addPair = function(key, value, prefix) {
+  key = encodeURIComponent(key);
+  if (value === undefined) this.push(key);
+  else this.push(key + '=' + (value == null ? '' : encodeURIComponent(value)));
+}
+
+Object.extend(Hash.prototype, Enumerable);
+Object.extend(Hash.prototype, {
   _each: function(iterator) {
     for (var key in this) {
       var value = this[key];
-      if (typeof value == 'function') continue;
+      if (value && value == Hash.prototype[key]) continue;
 
       var pair = [key, value];
       pair.key = key;
@@ -525,31 +835,66 @@
   },
 
   merge: function(hash) {
-    return $H(hash).inject($H(this), function(mergedHash, pair) {
+    return $H(hash).inject(this, function(mergedHash, pair) {
       mergedHash[pair.key] = pair.value;
       return mergedHash;
     });
   },
 
+  remove: function() {
+    var result;
+    for(var i = 0, length = arguments.length; i < length; i++) {
+      var value = this[arguments[i]];
+      if (value !== undefined){
+        if (result === undefined) result = value;
+        else {
+          if (result.constructor != Array) result = [result];
+          result.push(value)
+        }
+      }
+      delete this[arguments[i]];
+    }
+    return result;
+  },
+
   toQueryString: function() {
-    return this.map(function(pair) {
-      return pair.map(encodeURIComponent).join('=');
-    }).join('&');
+    return Hash.toQueryString(this);
   },
 
   inspect: function() {
     return '#<Hash:{' + this.map(function(pair) {
       return pair.map(Object.inspect).join(': ');
     }).join(', ') + '}>';
+  },
+
+  toJSON: function() {
+    return Hash.toJSON(this);
   }
-}
+});
 
 function $H(object) {
-  var hash = Object.extend({}, object || {});
-  Object.extend(hash, Enumerable);
-  Object.extend(hash, Hash);
-  return hash;
-}
+  if (object instanceof Hash) return object;
+  return new Hash(object);
+};
+
+// Safari iterates over shadowed properties
+if (function() {
+  var i = 0, Test = function(value) { this.key = value };
+  Test.prototype.key = 'foo';
+  for (var property in new Test('bar')) i++;
+  return i > 1;
+}()) Hash.prototype._each = function(iterator) {
+  var cache = [];
+  for (var key in this) {
+    var value = this[key];
+    if ((value && value == Hash.prototype[key]) || cache.include(key)) continue;
+    cache.push(key);
+    var pair = [key, value];
+    pair.key = key;
+    pair.value = value;
+    iterator(pair);
+  }
+};
 ObjectRange = Class.create();
 Object.extend(ObjectRange.prototype, Enumerable);
 Object.extend(ObjectRange.prototype, {
@@ -561,10 +906,10 @@
 
   _each: function(iterator) {
     var value = this.start;
-    do {
+    while (this.include(value)) {
       iterator(value);
       value = value.succ();
-    } while (this.include(value));
+    }
   },
 
   include: function(value) {
@@ -599,18 +944,18 @@
     this.responders._each(iterator);
   },
 
-  register: function(responderToAdd) {
-    if (!this.include(responderToAdd))
-      this.responders.push(responderToAdd);
+  register: function(responder) {
+    if (!this.include(responder))
+      this.responders.push(responder);
   },
 
-  unregister: function(responderToRemove) {
-    this.responders = this.responders.without(responderToRemove);
+  unregister: function(responder) {
+    this.responders = this.responders.without(responder);
   },
 
   dispatch: function(callback, request, transport, json) {
     this.each(function(responder) {
-      if (responder[callback] && typeof responder[callback] == 'function') {
+      if (typeof responder[callback] == 'function') {
         try {
           responder[callback].apply(responder, [request, transport, json]);
         } catch (e) {}
@@ -625,7 +970,6 @@
   onCreate: function() {
     Ajax.activeRequestCount++;
   },
-
   onComplete: function() {
     Ajax.activeRequestCount--;
   }
@@ -638,19 +982,14 @@
       method:       'post',
       asynchronous: true,
       contentType:  'application/x-www-form-urlencoded',
+      encoding:     'UTF-8',
       parameters:   ''
     }
     Object.extend(this.options, options || {});
-  },
 
-  responseIsSuccess: function() {
-    return this.transport.status == undefined
-        || this.transport.status == 0
-        || (this.transport.status >= 200 && this.transport.status < 300);
-  },
-
-  responseIsFailure: function() {
-    return !this.responseIsSuccess();
+    this.options.method = this.options.method.toLowerCase();
+    if (typeof this.options.parameters == 'string')
+      this.options.parameters = this.options.parameters.toQueryParams();
   }
 }
 
@@ -659,6 +998,8 @@
   ['Uninitialized', 'Loading', 'Loaded', 'Interactive', 'Complete'];
 
 Ajax.Request.prototype = Object.extend(new Ajax.Base(), {
+  _complete: false,
+
   initialize: function(url, options) {
     this.transport = Ajax.getTransport();
     this.setOptions(options);
@@ -666,113 +1007,152 @@
   },
 
   request: function(url) {
-    var parameters = this.options.parameters || '';
-    if (parameters.length > 0) parameters += '&_=';
+    this.url = url;
+    this.method = this.options.method;
+    var params = Object.clone(this.options.parameters);
 
+    if (!['get', 'post'].include(this.method)) {
+      // simulate other verbs over post
+      params['_method'] = this.method;
+      this.method = 'post';
+    }
+
+    this.parameters = params;
+
+    if (params = Hash.toQueryString(params)) {
+      // when GET, append parameters to URL
+      if (this.method == 'get')
+        this.url += (this.url.include('?') ? '&' : '?') + params;
+      else if (/Konqueror|Safari|KHTML/.test(navigator.userAgent))
+        params += '&_=';
+    }
+
     try {
-      this.url = url;
-      if (this.options.method == 'get' && parameters.length > 0)
-        this.url += (this.url.match(/\?/) ? '&' : '?') + parameters;
-
+      if (this.options.onCreate) this.options.onCreate(this.transport);
       Ajax.Responders.dispatch('onCreate', this, this.transport);
 
-      this.transport.open(this.options.method, this.url,
+      this.transport.open(this.method.toUpperCase(), this.url,
         this.options.asynchronous);
 
-      if (this.options.asynchronous) {
-        this.transport.onreadystatechange = this.onStateChange.bind(this);
-        setTimeout((function() {this.respondToReadyState(1)}).bind(this), 10);
-      }
+      if (this.options.asynchronous)
+        setTimeout(function() { this.respondToReadyState(1) }.bind(this), 10);
 
+      this.transport.onreadystatechange = this.onStateChange.bind(this);
       this.setRequestHeaders();
 
-      var body = this.options.postBody ? this.options.postBody : parameters;
-      this.transport.send(this.options.method == 'post' ? body : null);
+      this.body = this.method == 'post' ? (this.options.postBody || params) : null;
+      this.transport.send(this.body);
 
-    } catch (e) {
+      /* Force Firefox to handle ready state 4 for synchronous requests */
+      if (!this.options.asynchronous && this.transport.overrideMimeType)
+        this.onStateChange();
+
+    }
+    catch (e) {
       this.dispatchException(e);
     }
   },
 
+  onStateChange: function() {
+    var readyState = this.transport.readyState;
+    if (readyState > 1 && !((readyState == 4) && this._complete))
+      this.respondToReadyState(this.transport.readyState);
+  },
+
   setRequestHeaders: function() {
-    var requestHeaders =
-      ['X-Requested-With', 'XMLHttpRequest',
-       'X-Prototype-Version', Prototype.Version,
-       'Accept', 'text/javascript, text/html, application/xml, text/xml, */*'];
+    var headers = {
+      'X-Requested-With': 'XMLHttpRequest',
+      'X-Prototype-Version': Prototype.Version,
+      'Accept': 'text/javascript, text/html, application/xml, text/xml, */*'
+    };
 
-    if (this.options.method == 'post') {
-      requestHeaders.push('Content-type', this.options.contentType);
+    if (this.method == 'post') {
+      headers['Content-type'] = this.options.contentType +
+        (this.options.encoding ? '; charset=' + this.options.encoding : '');
 
-      /* Force "Connection: close" for Mozilla browsers to work around
-       * a bug where XMLHttpReqeuest sends an incorrect Content-length
-       * header. See Mozilla Bugzilla #246651.
+      /* Force "Connection: close" for older Mozilla browsers to work
+       * around a bug where XMLHttpRequest sends an incorrect
+       * Content-length header. See Mozilla Bugzilla #246651.
        */
-      if (this.transport.overrideMimeType)
-        requestHeaders.push('Connection', 'close');
+      if (this.transport.overrideMimeType &&
+          (navigator.userAgent.match(/Gecko\/(\d{4})/) || [0,2005])[1] < 2005)
+            headers['Connection'] = 'close';
     }
 
-    if (this.options.requestHeaders)
-      requestHeaders.push.apply(requestHeaders, this.options.requestHeaders);
+    // user-defined headers
+    if (typeof this.options.requestHeaders == 'object') {
+      var extras = this.options.requestHeaders;
 
-    for (var i = 0; i < requestHeaders.length; i += 2)
-      this.transport.setRequestHeader(requestHeaders[i], requestHeaders[i+1]);
-  },
+      if (typeof extras.push == 'function')
+        for (var i = 0, length = extras.length; i < length; i += 2)
+          headers[extras[i]] = extras[i+1];
+      else
+        $H(extras).each(function(pair) { headers[pair.key] = pair.value });
+    }
 
-  onStateChange: function() {
-    var readyState = this.transport.readyState;
-    if (readyState != 1)
-      this.respondToReadyState(this.transport.readyState);
+    for (var name in headers)
+      this.transport.setRequestHeader(name, headers[name]);
   },
 
-  header: function(name) {
-    try {
-      return this.transport.getResponseHeader(name);
-    } catch (e) {}
+  success: function() {
+    return !this.transport.status
+        || (this.transport.status >= 200 && this.transport.status < 300);
   },
 
-  evalJSON: function() {
-    try {
-      return eval('(' + this.header('X-JSON') + ')');
-    } catch (e) {}
-  },
-
-  evalResponse: function() {
-    try {
-      return eval(this.transport.responseText);
-    } catch (e) {
-      this.dispatchException(e);
-    }
-  },
-
   respondToReadyState: function(readyState) {
-    var event = Ajax.Request.Events[readyState];
+    var state = Ajax.Request.Events[readyState];
     var transport = this.transport, json = this.evalJSON();
 
-    if (event == 'Complete') {
+    if (state == 'Complete') {
       try {
+        this._complete = true;
         (this.options['on' + this.transport.status]
-         || this.options['on' + (this.responseIsSuccess() ? 'Success' : 'Failure')]
+         || this.options['on' + (this.success() ? 'Success' : 'Failure')]
          || Prototype.emptyFunction)(transport, json);
       } catch (e) {
         this.dispatchException(e);
       }
 
-      if ((this.header('Content-type') || '').match(/^text\/javascript/i))
-        this.evalResponse();
+      var contentType = this.getHeader('Content-type');
+      if (contentType && contentType.strip().
+        match(/^(text|application)\/(x-)?(java|ecma)script(;.*)?$/i))
+          this.evalResponse();
     }
 
     try {
-      (this.options['on' + event] || Prototype.emptyFunction)(transport, json);
-      Ajax.Responders.dispatch('on' + event, this, transport, json);
+      (this.options['on' + state] || Prototype.emptyFunction)(transport, json);
+      Ajax.Responders.dispatch('on' + state, this, transport, json);
     } catch (e) {
       this.dispatchException(e);
     }
 
-    /* Avoid memory leak in MSIE: clean up the oncomplete event handler */
-    if (event == 'Complete')
+    if (state == 'Complete') {
+      // avoid memory leak in MSIE: clean up
       this.transport.onreadystatechange = Prototype.emptyFunction;
+    }
   },
 
+  getHeader: function(name) {
+    try {
+      return this.transport.getResponseHeader(name);
+    } catch (e) { return null }
+  },
+
+  evalJSON: function() {
+    try {
+      var json = this.getHeader('X-JSON');
+      return json ? json.evalJSON() : null;
+    } catch (e) { return null }
+  },
+
+  evalResponse: function() {
+    try {
+      return eval((this.transport.responseText || '').unfilterJSON());
+    } catch (e) {
+      this.dispatchException(e);
+    }
+  },
+
   dispatchException: function(exception) {
     (this.options.onException || Prototype.emptyFunction)(this, exception);
     Ajax.Responders.dispatch('onException', this, exception);
@@ -783,41 +1163,37 @@
 
 Object.extend(Object.extend(Ajax.Updater.prototype, Ajax.Request.prototype), {
   initialize: function(container, url, options) {
-    this.containers = {
-      success: container.success ? $(container.success) : $(container),
-      failure: container.failure ? $(container.failure) :
-        (container.success ? null : $(container))
+    this.container = {
+      success: (container.success || container),
+      failure: (container.failure || (container.success ? null : container))
     }
 
     this.transport = Ajax.getTransport();
     this.setOptions(options);
 
     var onComplete = this.options.onComplete || Prototype.emptyFunction;
-    this.options.onComplete = (function(transport, object) {
+    this.options.onComplete = (function(transport, param) {
       this.updateContent();
-      onComplete(transport, object);
+      onComplete(transport, param);
     }).bind(this);
 
     this.request(url);
   },
 
   updateContent: function() {
-    var receiver = this.responseIsSuccess() ?
-      this.containers.success : this.containers.failure;
+    var receiver = this.container[this.success() ? 'success' : 'failure'];
     var response = this.transport.responseText;
 
-    if (!this.options.evalScripts)
-      response = response.stripScripts();
+    if (!this.options.evalScripts) response = response.stripScripts();
 
-    if (receiver) {
-      if (this.options.insertion) {
+    if (receiver = $(receiver)) {
+      if (this.options.insertion)
         new this.options.insertion(receiver, response);
-      } else {
-        Element.update(receiver, response);
-      }
+      else
+        receiver.update(response);
     }
 
-    if (this.responseIsSuccess()) {
+    if (this.success()) {
       if (this.onComplete)
         setTimeout(this.onComplete.bind(this), 10);
     }
@@ -846,7 +1222,7 @@
   },
 
   stop: function() {
-    this.updater.onComplete = undefined;
+    this.updater.options.onComplete = undefined;
     clearTimeout(this.timer);
     (this.onComplete || Prototype.emptyFunction).apply(this, arguments);
   },
@@ -866,47 +1242,74 @@
     this.updater = new Ajax.Updater(this.container, this.url, this.options);
   }
 });
-function $() {
-  var results = [], element;
-  for (var i = 0; i < arguments.length; i++) {
-    element = arguments[i];
-    if (typeof element == 'string')
-      element = document.getElementById(element);
-    results.push(Element.extend(element));
+function $(element) {
+  if (arguments.length > 1) {
+    for (var i = 0, elements = [], length = arguments.length; i < length; i++)
+      elements.push($(arguments[i]));
+    return elements;
   }
-  return results.length < 2 ? results[0] : results;
+  if (typeof element == 'string')
+    element = document.getElementById(element);
+  return Element.extend(element);
 }
 
-document.getElementsByClassName = function(className, parentElement) {
+if (Prototype.BrowserFeatures.XPath) {
+  document._getElementsByXPath = function(expression, parentElement) {
+    var results = [];
+    var query = document.evaluate(expression, $(parentElement) || document,
+      null, XPathResult.ORDERED_NODE_SNAPSHOT_TYPE, null);
+    for (var i = 0, length = query.snapshotLength; i < length; i++)
+      results.push(query.snapshotItem(i));
+    return results;
+  };
+
+  document.getElementsByClassName = function(className, parentElement) {
+    var q = ".//*[contains(concat(' ', @class, ' '), ' " + className + " ')]";
+    return document._getElementsByXPath(q, parentElement);
+  }
+
+} else document.getElementsByClassName = function(className, parentElement) {
   var children = ($(parentElement) || document.body).getElementsByTagName('*');
-  return $A(children).inject([], function(elements, child) {
-    if (child.className.match(new RegExp("(^|\\s)" + className + "(\\s|$)")))
+  var elements = [], child;
+  for (var i = 0, length = children.length; i < length; i++) {
+    child = children[i];
+    if (Element.hasClassName(child, className))
       elements.push(Element.extend(child));
-    return elements;
-  });
-}
+  }
+  return elements;
+};
 
 /*--------------------------------------------------------------------------*/
 
-if (!window.Element)
-  var Element = new Object();
+if (!window.Element) var Element = {};
 
 Element.extend = function(element) {
-  if (!element) return;
-  if (_nativeExtensions) return element;
+  var F = Prototype.BrowserFeatures;
+  if (!element || !element.tagName || element.nodeType == 3 ||
+   element._extended || F.SpecificElementExtensions || element == window)
+    return element;
 
-  if (!element._extended && element.tagName && element != window) {
-    var methods = Element.Methods, cache = Element.extend.cache;
-    for (property in methods) {
-      var value = methods[property];
-      if (typeof value == 'function')
-        element[property] = cache.findOrStore(value);
-    }
+  var methods = {}, tagName = element.tagName, cache = Element.extend.cache,
+   T = Element.Methods.ByTag;
+
+  // extend methods for all tags (Safari doesn't need this)
+  if (!F.ElementExtensions) {
+    Object.extend(methods, Element.Methods),
+    Object.extend(methods, Element.Methods.Simulated);
   }
 
-  element._extended = true;
+  // extend methods for specific tags
+  if (T[tagName]) Object.extend(methods, T[tagName]);
+
+  for (var property in methods) {
+    var value = methods[property];
+    if (typeof value == 'function' && !(property in element))
+      element[property] = cache.findOrStore(value);
+  }
+
+  element._extended = Prototype.emptyFunction;
   return element;
-}
+};
 
 Element.extend.cache = {
   findOrStore: function(value) {
@@ -914,46 +1317,45 @@
       return value.apply(null, [this].concat($A(arguments)));
     }
   }
-}
+};
 
 Element.Methods = {
   visible: function(element) {
     return $(element).style.display != 'none';
   },
 
-  toggle: function() {
-    for (var i = 0; i < arguments.length; i++) {
-      var element = $(arguments[i]);
-      Element[Element.visible(element) ? 'hide' : 'show'](element);
-    }
+  toggle: function(element) {
+    element = $(element);
+    Element[Element.visible(element) ? 'hide' : 'show'](element);
+    return element;
   },
 
-  hide: function() {
-    for (var i = 0; i < arguments.length; i++) {
-      var element = $(arguments[i]);
-      element.style.display = 'none';
-    }
+  hide: function(element) {
+    $(element).style.display = 'none';
+    return element;
   },
 
-  show: function() {
-    for (var i = 0; i < arguments.length; i++) {
-      var element = $(arguments[i]);
-      element.style.display = '';
-    }
+  show: function(element) {
+    $(element).style.display = '';
+    return element;
   },
 
   remove: function(element) {
     element = $(element);
     element.parentNode.removeChild(element);
+    return element;
   },
 
   update: function(element, html) {
+    html = typeof html == 'undefined' ? '' : html.toString();
     $(element).innerHTML = html.stripScripts();
     setTimeout(function() {html.evalScripts()}, 10);
+    return element;
   },
 
   replace: function(element, html) {
     element = $(element);
+    html = typeof html == 'undefined' ? '' : html.toString();
     if (element.outerHTML) {
       element.outerHTML = html.stripScripts();
     } else {
@@ -963,47 +1365,191 @@
         range.createContextualFragment(html.stripScripts()), element);
     }
     setTimeout(function() {html.evalScripts()}, 10);
+    return element;
   },
 
-  getHeight: function(element) {
+  inspect: function(element) {
     element = $(element);
-    return element.offsetHeight;
+    var result = '<' + element.tagName.toLowerCase();
+    $H({'id': 'id', 'className': 'class'}).each(function(pair) {
+      var property = pair.first(), attribute = pair.last();
+      var value = (element[property] || '').toString();
+      if (value) result += ' ' + attribute + '=' + value.inspect(true);
+    });
+    return result + '>';
   },
 
+  recursivelyCollect: function(element, property) {
+    element = $(element);
+    var elements = [];
+    while (element = element[property])
+      if (element.nodeType == 1)
+        elements.push(Element.extend(element));
+    return elements;
+  },
+
+  ancestors: function(element) {
+    return $(element).recursivelyCollect('parentNode');
+  },
+
+  descendants: function(element) {
+    return $A($(element).getElementsByTagName('*')).each(Element.extend);
+  },
+
+  firstDescendant: function(element) {
+    element = $(element).firstChild;
+    while (element && element.nodeType != 1) element = element.nextSibling;
+    return $(element);
+  },
+
+  immediateDescendants: function(element) {
+    if (!(element = $(element).firstChild)) return [];
+    while (element && element.nodeType != 1) element = element.nextSibling;
+    if (element) return [element].concat($(element).nextSiblings());
+    return [];
+  },
+
+  previousSiblings: function(element) {
+    return $(element).recursivelyCollect('previousSibling');
+  },
+
+  nextSiblings: function(element) {
+    return $(element).recursivelyCollect('nextSibling');
+  },
+
+  siblings: function(element) {
+    element = $(element);
+    return element.previousSiblings().reverse().concat(element.nextSiblings());
+  },
+
+  match: function(element, selector) {
+    if (typeof selector == 'string')
+      selector = new Selector(selector);
+    return selector.match($(element));
+  },
+
+  up: function(element, expression, index) {
+    element = $(element);
+    if (arguments.length == 1) return $(element.parentNode);
+    var ancestors = element.ancestors();
+    return expression ? Selector.findElement(ancestors, expression, index) :
+      ancestors[index || 0];
+  },
+
+  down: function(element, expression, index) {
+    element = $(element);
+    if (arguments.length == 1) return element.firstDescendant();
+    var descendants = element.descendants();
+    return expression ? Selector.findElement(descendants, expression, index) :
+      descendants[index || 0];
+  },
+
+  previous: function(element, expression, index) {
+    element = $(element);
+    if (arguments.length == 1) return $(Selector.handlers.previousElementSibling(element));
+    var previousSiblings = element.previousSiblings();
+    return expression ? Selector.findElement(previousSiblings, expression, index) :
+      previousSiblings[index || 0];
+  },
+
+  next: function(element, expression, index) {
+    element = $(element);
+    if (arguments.length == 1) return $(Selector.handlers.nextElementSibling(element));
+    var nextSiblings = element.nextSiblings();
+    return expression ? Selector.findElement(nextSiblings, expression, index) :
+      nextSiblings[index || 0];
+  },
+
+  getElementsBySelector: function() {
+    var args = $A(arguments), element = $(args.shift());
+    return Selector.findChildElements(element, args);
+  },
+
+  getElementsByClassName: function(element, className) {
+    return document.getElementsByClassName(className, element);
+  },
+
+  readAttribute: function(element, name) {
+    element = $(element);
+    if (Prototype.Browser.IE) {
+      if (!element.attributes) return null;
+      var t = Element._attributeTranslations;
+      if (t.values[name]) return t.values[name](element, name);
+      if (t.names[name])  name = t.names[name];
+      var attribute = element.attributes[name];
+      return attribute ? attribute.nodeValue : null;
+    }
+    return element.getAttribute(name);
+  },
+
+  getHeight: function(element) {
+    return $(element).getDimensions().height;
+  },
+
+  getWidth: function(element) {
+    return $(element).getDimensions().width;
+  },
+
   classNames: function(element) {
     return new Element.ClassNames(element);
   },
 
   hasClassName: function(element, className) {
     if (!(element = $(element))) return;
-    return Element.classNames(element).include(className);
+    var elementClassName = element.className;
+    if (elementClassName.length == 0) return false;
+    if (elementClassName == className ||
+        elementClassName.match(new RegExp("(^|\\s)" + className + "(\\s|$)")))
+      return true;
+    return false;
   },
 
   addClassName: function(element, className) {
     if (!(element = $(element))) return;
-    return Element.classNames(element).add(className);
+    Element.classNames(element).add(className);
+    return element;
   },
 
   removeClassName: function(element, className) {
     if (!(element = $(element))) return;
-    return Element.classNames(element).remove(className);
+    Element.classNames(element).remove(className);
+    return element;
   },
 
+  toggleClassName: function(element, className) {
+    if (!(element = $(element))) return;
+    Element.classNames(element)[element.hasClassName(className) ? 'remove' : 'add'](className);
+    return element;
+  },
+
+  observe: function() {
+    Event.observe.apply(Event, arguments);
+    return $A(arguments).first();
+  },
+
+  stopObserving: function() {
+    Event.stopObserving.apply(Event, arguments);
+    return $A(arguments).first();
+  },
+
   // removes whitespace-only text node children
   cleanWhitespace: function(element) {
     element = $(element);
-    for (var i = 0; i < element.childNodes.length; i++) {
-      var node = element.childNodes[i];
+    var node = element.firstChild;
+    while (node) {
+      var nextNode = node.nextSibling;
       if (node.nodeType == 3 && !/\S/.test(node.nodeValue))
-        Element.remove(node);
+        element.removeChild(node);
+      node = nextNode;
     }
+    return element;
   },
 
   empty: function(element) {
-    return $(element).innerHTML.match(/^\s*$/);
+    return $(element).innerHTML.blank();
   },
 
-  childOf: function(element, ancestor) {
+  descendantOf: function(element, ancestor) {
     element = $(element), ancestor = $(ancestor);
     while (element = element.parentNode)
       if (element == ancestor) return true;
@@ -1012,38 +1558,52 @@
 
   scrollTo: function(element) {
     element = $(element);
-    var x = element.x ? element.x : element.offsetLeft,
-        y = element.y ? element.y : element.offsetTop;
-    window.scrollTo(x, y);
+    var pos = Position.cumulativeOffset(element);
+    window.scrollTo(pos[0], pos[1]);
+    return element;
   },
 
   getStyle: function(element, style) {
     element = $(element);
-    var value = element.style[style.camelize()];
+    style = style == 'float' ? 'cssFloat' : style.camelize();
+    var value = element.style[style];
     if (!value) {
-      if (document.defaultView && document.defaultView.getComputedStyle) {
-        var css = document.defaultView.getComputedStyle(element, null);
-        value = css ? css.getPropertyValue(style) : null;
-      } else if (element.currentStyle) {
-        value = element.currentStyle[style.camelize()];
-      }
+      var css = document.defaultView.getComputedStyle(element, null);
+      value = css ? css[style] : null;
     }
+    if (style == 'opacity') return value ? parseFloat(value) : 1.0;
+    return value == 'auto' ? null : value;
+  },
 
-    if (window.opera && ['left', 'top', 'right', 'bottom'].include(style))
-      if (Element.getStyle(element, 'position') == 'static') value = 'auto';
+  getOpacity: function(element) {
+    return $(element).getStyle('opacity');
+  },
 
-    return value == 'auto' ? null : value;
+  setStyle: function(element, styles, camelized) {
+    element = $(element);
+    var elementStyle = element.style;
+
+    for (var property in styles)
+      if (property == 'opacity') element.setOpacity(styles[property])
+      else
+        elementStyle[(property == 'float' || property == 'cssFloat') ?
+          (elementStyle.styleFloat === undefined ? 'cssFloat' : 'styleFloat') :
+          (camelized ? property : property.camelize())] = styles[property];
+
+    return element;
   },
 
-  setStyle: function(element, style) {
+  setOpacity: function(element, value) {
     element = $(element);
-    for (var name in style)
-      element.style[name.camelize()] = style[name];
+    element.style.opacity = (value == 1 || value === '') ? '' :
+      (value < 0.00001) ? 0 : value;
+    return element;
   },
 
   getDimensions: function(element) {
     element = $(element);
-    if (Element.getStyle(element, 'display') != 'none')
+    var display = $(element).getStyle('display');
+    if (display != 'none' && display != null) // Safari bug
       return {width: element.offsetWidth, height: element.offsetHeight};
 
     // All *Width and *Height properties give 0 on elements with display none,
@@ -1051,12 +1611,13 @@
     var els = element.style;
     var originalVisibility = els.visibility;
     var originalPosition = els.position;
+    var originalDisplay = els.display;
     els.visibility = 'hidden';
     els.position = 'absolute';
-    els.display = '';
+    els.display = 'block';
     var originalWidth = element.clientWidth;
     var originalHeight = element.clientHeight;
-    els.display = 'none';
+    els.display = originalDisplay;
     els.position = originalPosition;
     els.visibility = originalVisibility;
     return {width: originalWidth, height: originalHeight};
@@ -1075,6 +1636,7 @@
         element.style.left = 0;
       }
     }
+    return element;
   },
 
   undoPositioned: function(element) {
@@ -1087,52 +1649,271 @@
         element.style.bottom =
         element.style.right = '';
     }
+    return element;
   },
 
   makeClipping: function(element) {
     element = $(element);
-    if (element._overflow) return;
-    element._overflow = element.style.overflow;
+    if (element._overflow) return element;
+    element._overflow = element.style.overflow || 'auto';
     if ((Element.getStyle(element, 'overflow') || 'visible') != 'hidden')
       element.style.overflow = 'hidden';
+    return element;
   },
 
   undoClipping: function(element) {
     element = $(element);
-    if (element._overflow) return;
-    element.style.overflow = element._overflow;
-    element._overflow = undefined;
+    if (!element._overflow) return element;
+    element.style.overflow = element._overflow == 'auto' ? '' : element._overflow;
+    element._overflow = null;
+    return element;
   }
+};
+
+Object.extend(Element.Methods, {
+  childOf: Element.Methods.descendantOf,
+  childElements: Element.Methods.immediateDescendants
+});
+
+if (Prototype.Browser.Opera) {
+  Element.Methods._getStyle = Element.Methods.getStyle;
+  Element.Methods.getStyle = function(element, style) {
+    switch(style) {
+      case 'left':
+      case 'top':
+      case 'right':
+      case 'bottom':
+        if (Element._getStyle(element, 'position') == 'static') return null;
+      default: return Element._getStyle(element, style);
+    }
+  };
 }
+else if (Prototype.Browser.IE) {
+  Element.Methods.getStyle = function(element, style) {
+    element = $(element);
+    style = (style == 'float' || style == 'cssFloat') ? 'styleFloat' : style.camelize();
+    var value = element.style[style];
+    if (!value && element.currentStyle) value = element.currentStyle[style];
 
-Object.extend(Element, Element.Methods);
+    if (style == 'opacity') {
+      if (value = (element.getStyle('filter') || '').match(/alpha\(opacity=(.*)\)/))
+        if (value[1]) return parseFloat(value[1]) / 100;
+      return 1.0;
+    }
 
-var _nativeExtensions = false;
+    if (value == 'auto') {
+      if ((style == 'width' || style == 'height') && (element.getStyle('display') != 'none'))
+        return element['offset'+style.capitalize()] + 'px';
+      return null;
+    }
+    return value;
+  };
 
-if(!HTMLElement && /Konqueror|Safari|KHTML/.test(navigator.userAgent)) {
-  var HTMLElement = {}
-  HTMLElement.prototype = document.createElement('div').__proto__;
+  Element.Methods.setOpacity = function(element, value) {
+    element = $(element);
+    var filter = element.getStyle('filter'), style = element.style;
+    if (value == 1 || value === '') {
+      style.filter = filter.replace(/alpha\([^\)]*\)/gi,'');
+      return element;
+    } else if (value < 0.00001) value = 0;
+    style.filter = filter.replace(/alpha\([^\)]*\)/gi, '') +
+      'alpha(opacity=' + (value * 100) + ')';
+    return element;
+  };
+
+  // IE is missing .innerHTML support for TABLE-related elements
+  Element.Methods.update = function(element, html) {
+    element = $(element);
+    html = typeof html == 'undefined' ? '' : html.toString();
+    var tagName = element.tagName.toUpperCase();
+    if (['THEAD','TBODY','TR','TD'].include(tagName)) {
+      var div = document.createElement('div');
+      switch (tagName) {
+        case 'THEAD':
+        case 'TBODY':
+          div.innerHTML = '<table><tbody>' +  html.stripScripts() + '</tbody></table>';
+          depth = 2;
+          break;
+        case 'TR':
+          div.innerHTML = '<table><tbody><tr>' +  html.stripScripts() + '</tr></tbody></table>';
+          depth = 3;
+          break;
+        case 'TD':
+          div.innerHTML = '<table><tbody><tr><td>' +  html.stripScripts() + '</td></tr></tbody></table>';
+          depth = 4;
+      }
+      $A(element.childNodes).each(function(node) { element.removeChild(node) });
+      depth.times(function() { div = div.firstChild });
+      $A(div.childNodes).each(function(node) { element.appendChild(node) });
+    } else {
+      element.innerHTML = html.stripScripts();
+    }
+    setTimeout(function() { html.evalScripts() }, 10);
+    return element;
+  }
 }
+else if (Prototype.Browser.Gecko) {
+  Element.Methods.setOpacity = function(element, value) {
+    element = $(element);
+    element.style.opacity = (value == 1) ? 0.999999 :
+      (value === '') ? '' : (value < 0.00001) ? 0 : value;
+    return element;
+  };
+}
 
+Element._attributeTranslations = {
+  names: {
+    colspan:   "colSpan",
+    rowspan:   "rowSpan",
+    valign:    "vAlign",
+    datetime:  "dateTime",
+    accesskey: "accessKey",
+    tabindex:  "tabIndex",
+    enctype:   "encType",
+    maxlength: "maxLength",
+    readonly:  "readOnly",
+    longdesc:  "longDesc"
+  },
+  values: {
+    _getAttr: function(element, attribute) {
+      return element.getAttribute(attribute, 2);
+    },
+    _flag: function(element, attribute) {
+      return $(element).hasAttribute(attribute) ? attribute : null;
+    },
+    style: function(element) {
+      return element.style.cssText.toLowerCase();
+    },
+    title: function(element) {
+      var node = element.getAttributeNode('title');
+      return node.specified ? node.nodeValue : null;
+    }
+  }
+};
+
+(function() {
+  Object.extend(this, {
+    href: this._getAttr,
+    src:  this._getAttr,
+    type: this._getAttr,
+    disabled: this._flag,
+    checked:  this._flag,
+    readonly: this._flag,
+    multiple: this._flag
+  });
+}).call(Element._attributeTranslations.values);
+
+Element.Methods.Simulated = {
+  hasAttribute: function(element, attribute) {
+    var t = Element._attributeTranslations, node;
+    attribute = t.names[attribute] || attribute;
+    node = $(element).getAttributeNode(attribute);
+    return node && node.specified;
+  }
+};
+
+Element.Methods.ByTag = {};
+
+Object.extend(Element, Element.Methods);
+
+if (!Prototype.BrowserFeatures.ElementExtensions &&
+ document.createElement('div').__proto__) {
+  window.HTMLElement = {};
+  window.HTMLElement.prototype = document.createElement('div').__proto__;
+  Prototype.BrowserFeatures.ElementExtensions = true;
+}
+
+Element.hasAttribute = function(element, attribute) {
+  if (element.hasAttribute) return element.hasAttribute(attribute);
+  return Element.Methods.Simulated.hasAttribute(element, attribute);
+};
+
 Element.addMethods = function(methods) {
-  Object.extend(Element.Methods, methods || {});
+  var F = Prototype.BrowserFeatures, T = Element.Methods.ByTag;
 
-  if(typeof HTMLElement != 'undefined') {
-    var methods = Element.Methods, cache = Element.extend.cache;
-    for (property in methods) {
+  if (!methods) {
+    Object.extend(Form, Form.Methods);
+    Object.extend(Form.Element, Form.Element.Methods);
+    Object.extend(Element.Methods.ByTag, {
+      "FORM":     Object.clone(Form.Methods),
+      "INPUT":    Object.clone(Form.Element.Methods),
+      "SELECT":   Object.clone(Form.Element.Methods),
+      "TEXTAREA": Object.clone(Form.Element.Methods)
+    });
+  }
+
+  if (arguments.length == 2) {
+    var tagName = methods;
+    methods = arguments[1];
+  }
+
+  if (!tagName) Object.extend(Element.Methods, methods || {});
+  else {
+    if (tagName.constructor == Array) tagName.each(extend);
+    else extend(tagName);
+  }
+
+  function extend(tagName) {
+    tagName = tagName.toUpperCase();
+    if (!Element.Methods.ByTag[tagName])
+      Element.Methods.ByTag[tagName] = {};
+    Object.extend(Element.Methods.ByTag[tagName], methods);
+  }
+
+  function copy(methods, destination, onlyIfAbsent) {
+    onlyIfAbsent = onlyIfAbsent || false;
+    var cache = Element.extend.cache;
+    for (var property in methods) {
       var value = methods[property];
-      if (typeof value == 'function')
-        HTMLElement.prototype[property] = cache.findOrStore(value);
+      if (!onlyIfAbsent || !(property in destination))
+        destination[property] = cache.findOrStore(value);
     }
-    _nativeExtensions = true;
   }
-}
 
-Element.addMethods();
+  function findDOMClass(tagName) {
+    var klass;
+    var trans = {
+      "OPTGROUP": "OptGroup", "TEXTAREA": "TextArea", "P": "Paragraph",
+      "FIELDSET": "FieldSet", "UL": "UList", "OL": "OList", "DL": "DList",
+      "DIR": "Directory", "H1": "Heading", "H2": "Heading", "H3": "Heading",
+      "H4": "Heading", "H5": "Heading", "H6": "Heading", "Q": "Quote",
+      "INS": "Mod", "DEL": "Mod", "A": "Anchor", "IMG": "Image", "CAPTION":
+      "TableCaption", "COL": "TableCol", "COLGROUP": "TableCol", "THEAD":
+      "TableSection", "TFOOT": "TableSection", "TBODY": "TableSection", "TR":
+      "TableRow", "TH": "TableCell", "TD": "TableCell", "FRAMESET":
+      "FrameSet", "IFRAME": "IFrame"
+    };
+    if (trans[tagName]) klass = 'HTML' + trans[tagName] + 'Element';
+    if (window[klass]) return window[klass];
+    klass = 'HTML' + tagName + 'Element';
+    if (window[klass]) return window[klass];
+    klass = 'HTML' + tagName.capitalize() + 'Element';
+    if (window[klass]) return window[klass];
 
-var Toggle = new Object();
-Toggle.display = Element.toggle;
+    window[klass] = {};
+    window[klass].prototype = document.createElement(tagName).__proto__;
+    return window[klass];
+  }
 
+  if (F.ElementExtensions) {
+    copy(Element.Methods, HTMLElement.prototype);
+    copy(Element.Methods.Simulated, HTMLElement.prototype, true);
+  }
+
+  if (F.SpecificElementExtensions) {
+    for (var tag in Element.Methods.ByTag) {
+      var klass = findDOMClass(tag);
+      if (typeof klass == "undefined") continue;
+      copy(T[tag], klass.prototype);
+    }
+  }
+
+  Object.extend(Element, Element.Methods);
+  delete Element.ByTag;
+};
+
+var Toggle = { display: Element.toggle };
+
 /*--------------------------------------------------------------------------*/
 
 Abstract.Insertion = function(adjacency) {
@@ -1148,8 +1929,8 @@
       try {
         this.element.insertAdjacentHTML(this.adjacency, this.content);
       } catch (e) {
-        var tagName = this.element.tagName.toLowerCase();
-        if (tagName == 'tbody' || tagName == 'tr') {
+        var tagName = this.element.tagName.toUpperCase();
+        if (['TBODY', 'TR'].include(tagName)) {
           this.insertContent(this.contentFromAnonymousTable());
         } else {
           throw e;
@@ -1248,324 +2029,814 @@
 
   add: function(classNameToAdd) {
     if (this.include(classNameToAdd)) return;
-    this.set(this.toArray().concat(classNameToAdd).join(' '));
+    this.set($A(this).concat(classNameToAdd).join(' '));
   },
 
   remove: function(classNameToRemove) {
     if (!this.include(classNameToRemove)) return;
-    this.set(this.select(function(className) {
-      return className != classNameToRemove;
-    }).join(' '));
+    this.set($A(this).without(classNameToRemove).join(' '));
   },
 
   toString: function() {
-    return this.toArray().join(' ');
+    return $A(this).join(' ');
   }
-}
+};
 
 Object.extend(Element.ClassNames.prototype, Enumerable);
+/* Portions of the Selector class are derived from Jack Slocum?s DomQuery,
+ * part of YUI-Ext version 0.40, distributed under the terms of an MIT-style
+ * license.  Please see http://www.yui-ext.com/ for more information. */
+
 var Selector = Class.create();
+
 Selector.prototype = {
   initialize: function(expression) {
-    this.params = {classNames: []};
-    this.expression = expression.toString().strip();
-    this.parseExpression();
+    this.expression = expression.strip();
     this.compileMatcher();
   },
 
-  parseExpression: function() {
-    function abort(message) { throw 'Parse error in selector: ' + message; }
+  compileMatcher: function() {
+    // Selectors with namespaced attributes can't use the XPath version
+    if (Prototype.BrowserFeatures.XPath && !(/\[[\w-]*?:/).test(this.expression))
+      return this.compileXPathMatcher();
 
-    if (this.expression == '')  abort('empty expression');
+    var e = this.expression, ps = Selector.patterns, h = Selector.handlers,
+        c = Selector.criteria, le, p, m;
 
-    var params = this.params, expr = this.expression, match, modifier, clause, rest;
-    while (match = expr.match(/^(.*)\[([a-z0-9_:-]+?)(?:([~\|!]?=)(?:"([^"]*)"|([^\]\s]*)))?\]$/i)) {
-      params.attributes = params.attributes || [];
-      params.attributes.push({name: match[2], operator: match[3], value: match[4] || match[5] || ''});
-      expr = match[1];
+    if (Selector._cache[e]) {
+      this.matcher = Selector._cache[e]; return;
     }
+    this.matcher = ["this.matcher = function(root) {",
+                    "var r = root, h = Selector.handlers, c = false, n;"];
 
-    if (expr == '*') return this.params.wildcard = true;
-
-    while (match = expr.match(/^([^a-z0-9_-])?([a-z0-9_-]+)(.*)/i)) {
-      modifier = match[1], clause = match[2], rest = match[3];
-      switch (modifier) {
-        case '#':       params.id = clause; break;
-        case '.':       params.classNames.push(clause); break;
-        case '':
-        case undefined: params.tagName = clause.toUpperCase(); break;
-        default:        abort(expr.inspect());
+    while (e && le != e && (/\S/).test(e)) {
+      le = e;
+      for (var i in ps) {
+        p = ps[i];
+        if (m = e.match(p)) {
+          this.matcher.push(typeof c[i] == 'function' ? c[i](m) :
+    	      new Template(c[i]).evaluate(m));
+          e = e.replace(m[0], '');
+          break;
+        }
       }
-      expr = rest;
     }
 
-    if (expr.length > 0) abort(expr.inspect());
+    this.matcher.push("return h.unique(n);\n}");
+    eval(this.matcher.join('\n'));
+    Selector._cache[this.expression] = this.matcher;
   },
 
-  buildMatchExpression: function() {
-    var params = this.params, conditions = [], clause;
+  compileXPathMatcher: function() {
+    var e = this.expression, ps = Selector.patterns,
+        x = Selector.xpath, le,  m;
 
-    if (params.wildcard)
-      conditions.push('true');
-    if (clause = params.id)
-      conditions.push('element.id == ' + clause.inspect());
-    if (clause = params.tagName)
-      conditions.push('element.tagName.toUpperCase() == ' + clause.inspect());
-    if ((clause = params.classNames).length > 0)
-      for (var i = 0; i < clause.length; i++)
-        conditions.push('Element.hasClassName(element, ' + clause[i].inspect() + ')');
-    if (clause = params.attributes) {
-      clause.each(function(attribute) {
-        var value = 'element.getAttribute(' + attribute.name.inspect() + ')';
-        var splitValueBy = function(delimiter) {
-          return value + ' && ' + value + '.split(' + delimiter.inspect() + ')';
+    if (Selector._cache[e]) {
+      this.xpath = Selector._cache[e]; return;
+    }
+
+    this.matcher = ['.//*'];
+    while (e && le != e && (/\S/).test(e)) {
+      le = e;
+      for (var i in ps) {
+        if (m = e.match(ps[i])) {
+          this.matcher.push(typeof x[i] == 'function' ? x[i](m) :
+            new Template(x[i]).evaluate(m));
+          e = e.replace(m[0], '');
+          break;
         }
+      }
+    }
 
-        switch (attribute.operator) {
-          case '=':       conditions.push(value + ' == ' + attribute.value.inspect()); break;
-          case '~=':      conditions.push(splitValueBy(' ') + '.include(' + attribute.value.inspect() + ')'); break;
-          case '|=':      conditions.push(
-                            splitValueBy('-') + '.first().toUpperCase() == ' + attribute.value.toUpperCase().inspect()
-                          ); break;
-          case '!=':      conditions.push(value + ' != ' + attribute.value.inspect()); break;
-          case '':
-          case undefined: conditions.push(value + ' != null'); break;
-          default:        throw 'Unknown operator ' + attribute.operator + ' in selector';
+    this.xpath = this.matcher.join('');
+    Selector._cache[this.expression] = this.xpath;
+  },
+
+  findElements: function(root) {
+    root = root || document;
+    if (this.xpath) return document._getElementsByXPath(this.xpath, root);
+    return this.matcher(root);
+  },
+
+  match: function(element) {
+    return this.findElements(document).include(element);
+  },
+
+  toString: function() {
+    return this.expression;
+  },
+
+  inspect: function() {
+    return "#<Selector:" + this.expression.inspect() + ">";
+  }
+};
+
+Object.extend(Selector, {
+  _cache: {},
+
+  xpath: {
+    descendant:   "//*",
+    child:        "/*",
+    adjacent:     "/following-sibling::*[1]",
+    laterSibling: '/following-sibling::*',
+    tagName:      function(m) {
+      if (m[1] == '*') return '';
+      return "[local-name()='" + m[1].toLowerCase() +
+             "' or local-name()='" + m[1].toUpperCase() + "']";
+    },
+    className:    "[contains(concat(' ', @class, ' '), ' #{1} ')]",
+    id:           "[@id='#{1}']",
+    attrPresence: "[@#{1}]",
+    attr: function(m) {
+      m[3] = m[5] || m[6];
+      return new Template(Selector.xpath.operators[m[2]]).evaluate(m);
+    },
+    pseudo: function(m) {
+      var h = Selector.xpath.pseudos[m[1]];
+      if (!h) return '';
+      if (typeof h === 'function') return h(m);
+      return new Template(Selector.xpath.pseudos[m[1]]).evaluate(m);
+    },
+    operators: {
+      '=':  "[@#{1}='#{3}']",
+      '!=': "[@#{1}!='#{3}']",
+      '^=': "[starts-with(@#{1}, '#{3}')]",
+      '$=': "[substring(@#{1}, (string-length(@#{1}) - string-length('#{3}') + 1))='#{3}']",
+      '*=': "[contains(@#{1}, '#{3}')]",
+      '~=': "[contains(concat(' ', @#{1}, ' '), ' #{3} ')]",
+      '|=': "[contains(concat('-', @#{1}, '-'), '-#{3}-')]"
+    },
+    pseudos: {
+      'first-child': '[not(preceding-sibling::*)]',
+      'last-child':  '[not(following-sibling::*)]',
+      'only-child':  '[not(preceding-sibling::* or following-sibling::*)]',
+      'empty':       "[count(*) = 0 and (count(text()) = 0 or translate(text(), ' \t\r\n', '') = '')]",
+      'checked':     "[@checked]",
+      'disabled':    "[@disabled]",
+      'enabled':     "[not(@disabled)]",
+      'not': function(m) {
+        var e = m[6], p = Selector.patterns,
+            x = Selector.xpath, le, m, v;
+
+        var exclusion = [];
+        while (e && le != e && (/\S/).test(e)) {
+          le = e;
+          for (var i in p) {
+            if (m = e.match(p[i])) {
+              v = typeof x[i] == 'function' ? x[i](m) : new Template(x[i]).evaluate(m);
+              exclusion.push("(" + v.substring(1, v.length - 1) + ")");
+              e = e.replace(m[0], '');
+              break;
+            }
+          }
         }
-      });
+        return "[not(" + exclusion.join(" and ") + ")]";
+      },
+      'nth-child':      function(m) {
+        return Selector.xpath.pseudos.nth("(count(./preceding-sibling::*) + 1) ", m);
+      },
+      'nth-last-child': function(m) {
+        return Selector.xpath.pseudos.nth("(count(./following-sibling::*) + 1) ", m);
+      },
+      'nth-of-type':    function(m) {
+        return Selector.xpath.pseudos.nth("position() ", m);
+      },
+      'nth-last-of-type': function(m) {
+        return Selector.xpath.pseudos.nth("(last() + 1 - position()) ", m);
+      },
+      'first-of-type':  function(m) {
+        m[6] = "1"; return Selector.xpath.pseudos['nth-of-type'](m);
+      },
+      'last-of-type':   function(m) {
+        m[6] = "1"; return Selector.xpath.pseudos['nth-last-of-type'](m);
+      },
+      'only-of-type':   function(m) {
+        var p = Selector.xpath.pseudos; return p['first-of-type'](m) + p['last-of-type'](m);
+      },
+      nth: function(fragment, m) {
+        var mm, formula = m[6], predicate;
+        if (formula == 'even') formula = '2n+0';
+        if (formula == 'odd')  formula = '2n+1';
+        if (mm = formula.match(/^(\d+)$/)) // digit only
+          return '[' + fragment + "= " + mm[1] + ']';
+        if (mm = formula.match(/^(-?\d*)?n(([+-])(\d+))?/)) { // an+b
+          if (mm[1] == "-") mm[1] = -1;
+          var a = mm[1] ? Number(mm[1]) : 1;
+          var b = mm[2] ? Number(mm[2]) : 0;
+          predicate = "[((#{fragment} - #{b}) mod #{a} = 0) and " +
+          "((#{fragment} - #{b}) div #{a} >= 0)]";
+          return new Template(predicate).evaluate({
+            fragment: fragment, a: a, b: b });
+        }
+      }
     }
+  },
 
-    return conditions.join(' && ');
+  criteria: {
+    tagName:      'n = h.tagName(n, r, "#{1}", c);   c = false;',
+    className:    'n = h.className(n, r, "#{1}", c); c = false;',
+    id:           'n = h.id(n, r, "#{1}", c);        c = false;',
+    attrPresence: 'n = h.attrPresence(n, r, "#{1}"); c = false;',
+    attr: function(m) {
+      m[3] = (m[5] || m[6]);
+      return new Template('n = h.attr(n, r, "#{1}", "#{3}", "#{2}"); c = false;').evaluate(m);
+    },
+    pseudo:       function(m) {
+      if (m[6]) m[6] = m[6].replace(/"/g, '\\"');
+      return new Template('n = h.pseudo(n, "#{1}", "#{6}", r, c); c = false;').evaluate(m);
+    },
+    descendant:   'c = "descendant";',
+    child:        'c = "child";',
+    adjacent:     'c = "adjacent";',
+    laterSibling: 'c = "laterSibling";'
   },
 
-  compileMatcher: function() {
-    this.match = new Function('element', 'if (!element.tagName) return false; \
-      return ' + this.buildMatchExpression());
+  patterns: {
+    // combinators must be listed first
+    // (and descendant needs to be last combinator)
+    laterSibling: /^\s*~\s*/,
+    child:        /^\s*>\s*/,
+    adjacent:     /^\s*\+\s*/,
+    descendant:   /^\s/,
+
+    // selectors follow
+    tagName:      /^\s*(\*|[\w\-]+)(\b|$)?/,
+    id:           /^#([\w\-\*]+)(\b|$)/,
+    className:    /^\.([\w\-\*]+)(\b|$)/,
+    pseudo:       /^:((first|last|nth|nth-last|only)(-child|-of-type)|empty|checked|(en|dis)abled|not)(\((.*?)\))?(\b|$|\s|(?=:))/,
+    attrPresence: /^\[([\w]+)\]/,
+    attr:         /\[((?:[\w-]*:)?[\w-]+)\s*(?:([!^$*~|]?=)\s*((['"])([^\]]*?)\4|([^'"][^\]]*?)))?\]/
   },
 
-  findElements: function(scope) {
-    var element;
+  handlers: {
+    // UTILITY FUNCTIONS
+    // joins two collections
+    concat: function(a, b) {
+      for (var i = 0, node; node = b[i]; i++)
+        a.push(node);
+      return a;
+    },
 
-    if (element = $(this.params.id))
-      if (this.match(element))
-        if (!scope || Element.childOf(element, scope))
-          return [element];
+    // marks an array of nodes for counting
+    mark: function(nodes) {
+      for (var i = 0, node; node = nodes[i]; i++)
+        node._counted = true;
+      return nodes;
+    },
 
-    scope = (scope || document).getElementsByTagName(this.params.tagName || '*');
+    unmark: function(nodes) {
+      for (var i = 0, node; node = nodes[i]; i++)
+        node._counted = undefined;
+      return nodes;
+    },
 
-    var results = [];
-    for (var i = 0; i < scope.length; i++)
-      if (this.match(element = scope[i]))
-        results.push(Element.extend(element));
+    // mark each child node with its position (for nth calls)
+    // "ofType" flag indicates whether we're indexing for nth-of-type
+    // rather than nth-child
+    index: function(parentNode, reverse, ofType) {
+      parentNode._counted = true;
+      if (reverse) {
+        for (var nodes = parentNode.childNodes, i = nodes.length - 1, j = 1; i >= 0; i--) {
+          node = nodes[i];
+          if (node.nodeType == 1 && (!ofType || node._counted)) node.nodeIndex = j++;
+        }
+      } else {
+        for (var i = 0, j = 1, nodes = parentNode.childNodes; node = nodes[i]; i++)
+          if (node.nodeType == 1 && (!ofType || node._counted)) node.nodeIndex = j++;
+      }
+    },
 
-    return results;
+    // filters out duplicates and extends all nodes
+    unique: function(nodes) {
+      if (nodes.length == 0) return nodes;
+      var results = [], n;
+      for (var i = 0, l = nodes.length; i < l; i++)
+        if (!(n = nodes[i])._counted) {
+          n._counted = true;
+          results.push(Element.extend(n));
+        }
+      return Selector.handlers.unmark(results);
+    },
+
+    // COMBINATOR FUNCTIONS
+    descendant: function(nodes) {
+      var h = Selector.handlers;
+      for (var i = 0, results = [], node; node = nodes[i]; i++)
+        h.concat(results, node.getElementsByTagName('*'));
+      return results;
+    },
+
+    child: function(nodes) {
+      var h = Selector.handlers;
+      for (var i = 0, results = [], node; node = nodes[i]; i++) {
+        for (var j = 0, children = [], child; child = node.childNodes[j]; j++)
+          if (child.nodeType == 1 && child.tagName != '!') results.push(child);
+      }
+      return results;
+    },
+
+    adjacent: function(nodes) {
+      for (var i = 0, results = [], node; node = nodes[i]; i++) {
+        var next = this.nextElementSibling(node);
+        if (next) results.push(next);
+      }
+      return results;
+    },
+
+    laterSibling: function(nodes) {
+      var h = Selector.handlers;
+      for (var i = 0, results = [], node; node = nodes[i]; i++)
+        h.concat(results, Element.nextSiblings(node));
+      return results;
+    },
+
+    nextElementSibling: function(node) {
+      while (node = node.nextSibling)
+	      if (node.nodeType == 1) return node;
+      return null;
+    },
+
+    previousElementSibling: function(node) {
+      while (node = node.previousSibling)
+        if (node.nodeType == 1) return node;
+      return null;
+    },
+
+    // TOKEN FUNCTIONS
+    tagName: function(nodes, root, tagName, combinator) {
+      tagName = tagName.toUpperCase();
+      var results = [], h = Selector.handlers;
+      if (nodes) {
+        if (combinator) {
+          // fastlane for ordinary descendant combinators
+          if (combinator == "descendant") {
+            for (var i = 0, node; node = nodes[i]; i++)
+              h.concat(results, node.getElementsByTagName(tagName));
+            return results;
+          } else nodes = this[combinator](nodes);
+          if (tagName == "*") return nodes;
+        }
+        for (var i = 0, node; node = nodes[i]; i++)
+          if (node.tagName.toUpperCase() == tagName) results.push(node);
+        return results;
+      } else return root.getElementsByTagName(tagName);
+    },
+
+    id: function(nodes, root, id, combinator) {
+      var targetNode = $(id), h = Selector.handlers;
+      if (!nodes && root == document) return targetNode ? [targetNode] : [];
+      if (nodes) {
+        if (combinator) {
+          if (combinator == 'child') {
+            for (var i = 0, node; node = nodes[i]; i++)
+              if (targetNode.parentNode == node) return [targetNode];
+          } else if (combinator == 'descendant') {
+            for (var i = 0, node; node = nodes[i]; i++)
+              if (Element.descendantOf(targetNode, node)) return [targetNode];
+          } else if (combinator == 'adjacent') {
+            for (var i = 0, node; node = nodes[i]; i++)
+              if (Selector.handlers.previousElementSibling(targetNode) == node)
+                return [targetNode];
+          } else nodes = h[combinator](nodes);
+        }
+        for (var i = 0, node; node = nodes[i]; i++)
+          if (node == targetNode) return [targetNode];
+        return [];
+      }
+      return (targetNode && Element.descendantOf(targetNode, root)) ? [targetNode] : [];
+    },
+
+    className: function(nodes, root, className, combinator) {
+      if (nodes && combinator) nodes = this[combinator](nodes);
+      return Selector.handlers.byClassName(nodes, root, className);
+    },
+
+    byClassName: function(nodes, root, className) {
+      if (!nodes) nodes = Selector.handlers.descendant([root]);
+      var needle = ' ' + className + ' ';
+      for (var i = 0, results = [], node, nodeClassName; node = nodes[i]; i++) {
+        nodeClassName = node.className;
+        if (nodeClassName.length == 0) continue;
+        if (nodeClassName == className || (' ' + nodeClassName + ' ').include(needle))
+          results.push(node);
+      }
+      return results;
+    },
+
+    attrPresence: function(nodes, root, attr) {
+      var results = [];
+      for (var i = 0, node; node = nodes[i]; i++)
+        if (Element.hasAttribute(node, attr)) results.push(node);
+      return results;
+    },
+
+    attr: function(nodes, root, attr, value, operator) {
+      if (!nodes) nodes = root.getElementsByTagName("*");
+      var handler = Selector.operators[operator], results = [];
+      for (var i = 0, node; node = nodes[i]; i++) {
+        var nodeValue = Element.readAttribute(node, attr);
+        if (nodeValue === null) continue;
+        if (handler(nodeValue, value)) results.push(node);
+      }
+      return results;
+    },
+
+    pseudo: function(nodes, name, value, root, combinator) {
+      if (nodes && combinator) nodes = this[combinator](nodes);
+      if (!nodes) nodes = root.getElementsByTagName("*");
+      return Selector.pseudos[name](nodes, value, root);
+    }
   },
 
-  toString: function() {
-    return this.expression;
-  }
-}
+  pseudos: {
+    'first-child': function(nodes, value, root) {
+      for (var i = 0, results = [], node; node = nodes[i]; i++) {
+        if (Selector.handlers.previousElementSibling(node)) continue;
+          results.push(node);
+      }
+      return results;
+    },
+    'last-child': function(nodes, value, root) {
+      for (var i = 0, results = [], node; node = nodes[i]; i++) {
+        if (Selector.handlers.nextElementSibling(node)) continue;
+          results.push(node);
+      }
+      return results;
+    },
+    'only-child': function(nodes, value, root) {
+      var h = Selector.handlers;
+      for (var i = 0, results = [], node; node = nodes[i]; i++)
+        if (!h.previousElementSibling(node) && !h.nextElementSibling(node))
+          results.push(node);
+      return results;
+    },
+    'nth-child':        function(nodes, formula, root) {
+      return Selector.pseudos.nth(nodes, formula, root);
+    },
+    'nth-last-child':   function(nodes, formula, root) {
+      return Selector.pseudos.nth(nodes, formula, root, true);
+    },
+    'nth-of-type':      function(nodes, formula, root) {
+      return Selector.pseudos.nth(nodes, formula, root, false, true);
+    },
+    'nth-last-of-type': function(nodes, formula, root) {
+      return Selector.pseudos.nth(nodes, formula, root, true, true);
+    },
+    'first-of-type':    function(nodes, formula, root) {
+      return Selector.pseudos.nth(nodes, "1", root, false, true);
+    },
+    'last-of-type':     function(nodes, formula, root) {
+      return Selector.pseudos.nth(nodes, "1", root, true, true);
+    },
+    'only-of-type':     function(nodes, formula, root) {
+      var p = Selector.pseudos;
+      return p['last-of-type'](p['first-of-type'](nodes, formula, root), formula, root);
+    },
 
-function $$() {
-  return $A(arguments).map(function(expression) {
-    return expression.strip().split(/\s+/).inject([null], function(results, expr) {
-      var selector = new Selector(expr);
-      return results.map(selector.findElements.bind(selector)).flatten();
-    });
-  }).flatten();
-}
-var Field = {
-  clear: function() {
-    for (var i = 0; i < arguments.length; i++)
-      $(arguments[i]).value = '';
+    // handles the an+b logic
+    getIndices: function(a, b, total) {
+      if (a == 0) return b > 0 ? [b] : [];
+      return $R(1, total).inject([], function(memo, i) {
+        if (0 == (i - b) % a && (i - b) / a >= 0) memo.push(i);
+        return memo;
+      });
+    },
+
+    // handles nth(-last)-child, nth(-last)-of-type, and (first|last)-of-type
+    nth: function(nodes, formula, root, reverse, ofType) {
+      if (nodes.length == 0) return [];
+      if (formula == 'even') formula = '2n+0';
+      if (formula == 'odd')  formula = '2n+1';
+      var h = Selector.handlers, results = [], indexed = [], m;
+      h.mark(nodes);
+      for (var i = 0, node; node = nodes[i]; i++) {
+        if (!node.parentNode._counted) {
+          h.index(node.parentNode, reverse, ofType);
+          indexed.push(node.parentNode);
+        }
+      }
+      if (formula.match(/^\d+$/)) { // just a number
+        formula = Number(formula);
+        for (var i = 0, node; node = nodes[i]; i++)
+          if (node.nodeIndex == formula) results.push(node);
+      } else if (m = formula.match(/^(-?\d*)?n(([+-])(\d+))?/)) { // an+b
+        if (m[1] == "-") m[1] = -1;
+        var a = m[1] ? Number(m[1]) : 1;
+        var b = m[2] ? Number(m[2]) : 0;
+        var indices = Selector.pseudos.getIndices(a, b, nodes.length);
+        for (var i = 0, node, l = indices.length; node = nodes[i]; i++) {
+          for (var j = 0; j < l; j++)
+            if (node.nodeIndex == indices[j]) results.push(node);
+        }
+      }
+      h.unmark(nodes);
+      h.unmark(indexed);
+      return results;
+    },
+
+    'empty': function(nodes, value, root) {
+      for (var i = 0, results = [], node; node = nodes[i]; i++) {
+        // IE treats comments as element nodes
+        if (node.tagName == '!' || (node.firstChild && !node.innerHTML.match(/^\s*$/))) continue;
+        results.push(node);
+      }
+      return results;
+    },
+
+    'not': function(nodes, selector, root) {
+      var h = Selector.handlers, selectorType, m;
+      var exclusions = new Selector(selector).findElements(root);
+      h.mark(exclusions);
+      for (var i = 0, results = [], node; node = nodes[i]; i++)
+        if (!node._counted) results.push(node);
+      h.unmark(exclusions);
+      return results;
+    },
+
+    'enabled': function(nodes, value, root) {
+      for (var i = 0, results = [], node; node = nodes[i]; i++)
+        if (!node.disabled) results.push(node);
+      return results;
+    },
+
+    'disabled': function(nodes, value, root) {
+      for (var i = 0, results = [], node; node = nodes[i]; i++)
+        if (node.disabled) results.push(node);
+      return results;
+    },
+
+    'checked': function(nodes, value, root) {
+      for (var i = 0, results = [], node; node = nodes[i]; i++)
+        if (node.checked) results.push(node);
+      return results;
+    }
   },
 
-  focus: function(element) {
-    $(element).focus();
+  operators: {
+    '=':  function(nv, v) { return nv == v; },
+    '!=': function(nv, v) { return nv != v; },
+    '^=': function(nv, v) { return nv.startsWith(v); },
+    '$=': function(nv, v) { return nv.endsWith(v); },
+    '*=': function(nv, v) { return nv.include(v); },
+    '~=': function(nv, v) { return (' ' + nv + ' ').include(' ' + v + ' '); },
+    '|=': function(nv, v) { return ('-' + nv.toUpperCase() + '-').include('-' + v.toUpperCase() + '-'); }
   },
 
-  present: function() {
-    for (var i = 0; i < arguments.length; i++)
-      if ($(arguments[i]).value == '') return false;
-    return true;
+  matchElements: function(elements, expression) {
+    var matches = new Selector(expression).findElements(), h = Selector.handlers;
+    h.mark(matches);
+    for (var i = 0, results = [], element; element = elements[i]; i++)
+      if (element._counted) results.push(element);
+    h.unmark(matches);
+    return results;
   },
 
-  select: function(element) {
-    $(element).select();
+  findElement: function(elements, expression, index) {
+    if (typeof expression == 'number') {
+      index = expression; expression = false;
+    }
+    return Selector.matchElements(elements, expression || '*')[index || 0];
   },
 
-  activate: function(element) {
-    element = $(element);
-    element.focus();
-    if (element.select)
-      element.select();
+  findChildElements: function(element, expressions) {
+    var exprs = expressions.join(','), expressions = [];
+    exprs.scan(/(([\w#:.~>+()\s-]+|\*|\[.*?\])+)\s*(,|$)/, function(m) {
+      expressions.push(m[1].strip());
+    });
+    var results = [], h = Selector.handlers;
+    for (var i = 0, l = expressions.length, selector; i < l; i++) {
+      selector = new Selector(expressions[i].strip());
+      h.concat(results, selector.findElements(element));
+    }
+    return (l > 1) ? h.unique(results) : results;
   }
+});
+
+function $$() {
+  return Selector.findChildElements(document, $A(arguments));
 }
+var Form = {
+  reset: function(form) {
+    $(form).reset();
+    return form;
+  },
 
-/*--------------------------------------------------------------------------*/
+  serializeElements: function(elements, getHash) {
+    var data = elements.inject({}, function(result, element) {
+      if (!element.disabled && element.name) {
+        var key = element.name, value = $(element).getValue();
+        if (value != null) {
+         	if (key in result) {
+            if (result[key].constructor != Array) result[key] = [result[key]];
+            result[key].push(value);
+          }
+          else result[key] = value;
+        }
+      }
+      return result;
+    });
 
-var Form = {
-  serialize: function(form) {
-    var elements = Form.getElements($(form));
-    var queryComponents = new Array();
+    return getHash ? data : Hash.toQueryString(data);
+  }
+};
 
-    for (var i = 0; i < elements.length; i++) {
-      var queryComponent = Form.Element.serialize(elements[i]);
-      if (queryComponent)
-        queryComponents.push(queryComponent);
-    }
-
-    return queryComponents.join('&');
+Form.Methods = {
+  serialize: function(form, getHash) {
+    return Form.serializeElements(Form.getElements(form), getHash);
   },
 
   getElements: function(form) {
-    form = $(form);
-    var elements = new Array();
-
-    for (var tagName in Form.Element.Serializers) {
-      var tagElements = form.getElementsByTagName(tagName);
-      for (var j = 0; j < tagElements.length; j++)
-        elements.push(tagElements[j]);
-    }
-    return elements;
+    return $A($(form).getElementsByTagName('*')).inject([],
+      function(elements, child) {
+        if (Form.Element.Serializers[child.tagName.toLowerCase()])
+          elements.push(Element.extend(child));
+        return elements;
+      }
+    );
   },
 
   getInputs: function(form, typeName, name) {
     form = $(form);
     var inputs = form.getElementsByTagName('input');
 
-    if (!typeName && !name)
-      return inputs;
+    if (!typeName && !name) return $A(inputs).map(Element.extend);
 
-    var matchingInputs = new Array();
-    for (var i = 0; i < inputs.length; i++) {
+    for (var i = 0, matchingInputs = [], length = inputs.length; i < length; i++) {
       var input = inputs[i];
-      if ((typeName && input.type != typeName) ||
-          (name && input.name != name))
+      if ((typeName && input.type != typeName) || (name && input.name != name))
         continue;
-      matchingInputs.push(input);
+      matchingInputs.push(Element.extend(input));
     }
 
     return matchingInputs;
   },
 
   disable: function(form) {
-    var elements = Form.getElements(form);
-    for (var i = 0; i < elements.length; i++) {
-      var element = elements[i];
-      element.blur();
-      element.disabled = 'true';
-    }
+    form = $(form);
+    Form.getElements(form).invoke('disable');
+    return form;
   },
 
   enable: function(form) {
-    var elements = Form.getElements(form);
-    for (var i = 0; i < elements.length; i++) {
-      var element = elements[i];
-      element.disabled = '';
-    }
+    form = $(form);
+    Form.getElements(form).invoke('enable');
+    return form;
   },
 
   findFirstElement: function(form) {
-    return Form.getElements(form).find(function(element) {
+    return $(form).getElements().find(function(element) {
       return element.type != 'hidden' && !element.disabled &&
         ['input', 'select', 'textarea'].include(element.tagName.toLowerCase());
     });
   },
 
   focusFirstElement: function(form) {
-    Field.activate(Form.findFirstElement(form));
+    form = $(form);
+    form.findFirstElement().activate();
+    return form;
   },
 
-  reset: function(form) {
-    $(form).reset();
+  request: function(form, options) {
+    form = $(form), options = Object.clone(options || {});
+
+    var params = options.parameters;
+    options.parameters = form.serialize(true);
+
+    if (params) {
+      if (typeof params == 'string') params = params.toQueryParams();
+      Object.extend(options.parameters, params);
+    }
+
+    if (form.hasAttribute('method') && !options.method)
+      options.method = form.method;
+
+    return new Ajax.Request(form.readAttribute('action'), options);
   }
 }
 
+/*--------------------------------------------------------------------------*/
+
 Form.Element = {
+  focus: function(element) {
+    $(element).focus();
+    return element;
+  },
+
+  select: function(element) {
+    $(element).select();
+    return element;
+  }
+}
+
+Form.Element.Methods = {
   serialize: function(element) {
     element = $(element);
+    if (!element.disabled && element.name) {
+      var value = element.getValue();
+      if (value != undefined) {
+        var pair = {};
+        pair[element.name] = value;
+        return Hash.toQueryString(pair);
+      }
+    }
+    return '';
+  },
+
+  getValue: function(element) {
+    element = $(element);
     var method = element.tagName.toLowerCase();
-    var parameter = Form.Element.Serializers[method](element);
+    return Form.Element.Serializers[method](element);
+  },
 
-    if (parameter) {
-      var key = encodeURIComponent(parameter[0]);
-      if (key.length == 0) return;
+  clear: function(element) {
+    $(element).value = '';
+    return element;
+  },
 
-      if (parameter[1].constructor != Array)
-        parameter[1] = [parameter[1]];
+  present: function(element) {
+    return $(element).value != '';
+  },
 
-      return parameter[1].map(function(value) {
-        return key + '=' + encodeURIComponent(value);
-      }).join('&');
-    }
+  activate: function(element) {
+    element = $(element);
+    try {
+      element.focus();
+      if (element.select && (element.tagName.toLowerCase() != 'input' ||
+        !['button', 'reset', 'submit'].include(element.type)))
+        element.select();
+    } catch (e) {}
+    return element;
   },
 
-  getValue: function(element) {
+  disable: function(element) {
     element = $(element);
-    var method = element.tagName.toLowerCase();
-    var parameter = Form.Element.Serializers[method](element);
+    element.blur();
+    element.disabled = true;
+    return element;
+  },
 
-    if (parameter)
-      return parameter[1];
+  enable: function(element) {
+    element = $(element);
+    element.disabled = false;
+    return element;
   }
 }
 
+/*--------------------------------------------------------------------------*/
+
+var Field = Form.Element;
+var $F = Form.Element.Methods.getValue;
+
+/*--------------------------------------------------------------------------*/
+
 Form.Element.Serializers = {
   input: function(element) {
     switch (element.type.toLowerCase()) {
-      case 'submit':
-      case 'hidden':
-      case 'password':
-      case 'text':
-        return Form.Element.Serializers.textarea(element);
       case 'checkbox':
       case 'radio':
         return Form.Element.Serializers.inputSelector(element);
+      default:
+        return Form.Element.Serializers.textarea(element);
     }
-    return false;
   },
 
   inputSelector: function(element) {
-    if (element.checked)
-      return [element.name, element.value];
+    return element.checked ? element.value : null;
   },
 
   textarea: function(element) {
-    return [element.name, element.value];
+    return element.value;
   },
 
   select: function(element) {
-    return Form.Element.Serializers[element.type == 'select-one' ?
+    return this[element.type == 'select-one' ?
       'selectOne' : 'selectMany'](element);
   },
 
   selectOne: function(element) {
-    var value = '', opt, index = element.selectedIndex;
-    if (index >= 0) {
-      opt = element.options[index];
-      value = opt.value || opt.text;
-    }
-    return [element.name, value];
+    var index = element.selectedIndex;
+    return index >= 0 ? this.optionValue(element.options[index]) : null;
   },
 
   selectMany: function(element) {
-    var value = [];
-    for (var i = 0; i < element.length; i++) {
+    var values, length = element.length;
+    if (!length) return null;
+
+    for (var i = 0, values = []; i < length; i++) {
       var opt = element.options[i];
-      if (opt.selected)
-        value.push(opt.value || opt.text);
+      if (opt.selected) values.push(this.optionValue(opt));
     }
-    return [element.name, value];
+    return values;
+  },
+
+  optionValue: function(opt) {
+    // extend element because hasAttribute may not be native
+    return Element.extend(opt).hasAttribute('value') ? opt.value : opt.text;
   }
 }
 
 /*--------------------------------------------------------------------------*/
 
-var $F = Form.Element.getValue;
-
-/*--------------------------------------------------------------------------*/
-
 Abstract.TimedObserver = function() {}
 Abstract.TimedObserver.prototype = {
   initialize: function(element, frequency, callback) {
@@ -1583,7 +2854,9 @@
 
   onTimerEvent: function() {
     var value = this.getValue();
-    if (this.lastValue != value) {
+    var changed = ('string' == typeof this.lastValue && 'string' == typeof value
+      ? this.lastValue != value : String(this.lastValue) != String(value));
+    if (changed) {
       this.callback(this.element, value);
       this.lastValue = value;
     }
@@ -1628,9 +2901,7 @@
   },
 
   registerFormCallbacks: function() {
-    var elements = Form.getElements(this.element);
-    for (var i = 0; i < elements.length; i++)
-      this.registerCallback(elements[i]);
+    Form.getElements(this.element).each(this.registerCallback.bind(this));
   },
 
   registerCallback: function(element) {
@@ -1640,11 +2911,7 @@
         case 'radio':
           Event.observe(element, 'click', this.onElementEvent.bind(this));
           break;
-        case 'password':
-        case 'text':
-        case 'textarea':
-        case 'select-one':
-        case 'select-multiple':
+        default:
           Event.observe(element, 'change', this.onElementEvent.bind(this));
           break;
       }
@@ -1679,9 +2946,13 @@
   KEY_RIGHT:    39,
   KEY_DOWN:     40,
   KEY_DELETE:   46,
+  KEY_HOME:     36,
+  KEY_END:      35,
+  KEY_PAGEUP:   33,
+  KEY_PAGEDOWN: 34,
 
   element: function(event) {
-    return event.target || event.srcElement;
+    return $(event.target || event.srcElement);
   },
 
   isLeftClick: function(event) {
@@ -1734,7 +3005,7 @@
 
   unloadCache: function() {
     if (!Event.observers) return;
-    for (var i = 0; i < Event.observers.length; i++) {
+    for (var i = 0, length = Event.observers.length; i < length; i++) {
       Event.stopObserving.apply(this, Event.observers[i]);
       Event.observers[i][0] = null;
     }
@@ -1742,36 +3013,36 @@
   },
 
   observe: function(element, name, observer, useCapture) {
-    var element = $(element);
+    element = $(element);
     useCapture = useCapture || false;
 
     if (name == 'keypress' &&
-        (navigator.appVersion.match(/Konqueror|Safari|KHTML/)
-        || element.attachEvent))
+      (Prototype.Browser.WebKit || element.attachEvent))
       name = 'keydown';
 
-    this._observeAndCache(element, name, observer, useCapture);
+    Event._observeAndCache(element, name, observer, useCapture);
   },
 
   stopObserving: function(element, name, observer, useCapture) {
-    var element = $(element);
+    element = $(element);
     useCapture = useCapture || false;
 
     if (name == 'keypress' &&
-        (navigator.appVersion.match(/Konqueror|Safari|KHTML/)
-        || element.detachEvent))
+        (Prototype.Browser.WebKit || element.attachEvent))
       name = 'keydown';
 
     if (element.removeEventListener) {
       element.removeEventListener(name, observer, useCapture);
     } else if (element.detachEvent) {
-      element.detachEvent('on' + name, observer);
+      try {
+        element.detachEvent('on' + name, observer);
+      } catch (e) {}
     }
   }
 });
 
 /* prevent memory leaks in IE */
-if (navigator.appVersion.match(/\bMSIE\b/))
+if (Prototype.Browser.IE)
   Event.observe(window, 'unload', Event.unloadCache, false);
 var Position = {
   // set to true if needed, warning: firefox performance problems
@@ -1819,7 +3090,8 @@
       valueL += element.offsetLeft || 0;
       element = element.offsetParent;
       if (element) {
-        p = Element.getStyle(element, 'position');
+        if(element.tagName=='BODY') break;
+        var p = Element.getStyle(element, 'position');
         if (p == 'relative' || p == 'absolute') break;
       }
     } while (element);
@@ -1875,17 +3147,6 @@
         element.offsetWidth;
   },
 
-  clone: function(source, target) {
-    source = $(source);
-    target = $(target);
-    target.style.position = 'absolute';
-    var offsets = this.cumulativeOffset(source);
-    target.style.top    = offsets[1] + 'px';
-    target.style.left   = offsets[0] + 'px';
-    target.style.width  = source.offsetWidth + 'px';
-    target.style.height = source.offsetHeight + 'px';
-  },
-
   page: function(forElement) {
     var valueT = 0, valueL = 0;
 
@@ -1895,15 +3156,17 @@
       valueL += element.offsetLeft || 0;
 
       // Safari fix
-      if (element.offsetParent==document.body)
+      if (element.offsetParent == document.body)
         if (Element.getStyle(element,'position')=='absolute') break;
 
     } while (element = element.offsetParent);
 
     element = forElement;
     do {
-      valueT -= element.scrollTop  || 0;
-      valueL -= element.scrollLeft || 0;
+      if (!window.opera || element.tagName=='BODY') {
+        valueT -= element.scrollTop  || 0;
+        valueL -= element.scrollLeft || 0;
+      }
     } while (element = element.parentNode);
 
     return [valueL, valueT];
@@ -1964,10 +3227,10 @@
     element._originalHeight = element.style.height;
 
     element.style.position = 'absolute';
-    element.style.top    = top + 'px';;
-    element.style.left   = left + 'px';;
-    element.style.width  = width + 'px';;
-    element.style.height = height + 'px';;
+    element.style.top    = top + 'px';
+    element.style.left   = left + 'px';
+    element.style.width  = width + 'px';
+    element.style.height = height + 'px';
   },
 
   relativize: function(element) {
@@ -1989,7 +3252,7 @@
 // Safari returns margins on body which is incorrect if the child is absolutely
 // positioned.  For performance reasons, redefine Position.cumulativeOffset for
 // KHTML/WebKit only.
-if (/Konqueror|Safari|KHTML/.test(navigator.userAgent)) {
+if (Prototype.Browser.WebKit) {
   Position.cumulativeOffset = function(element) {
     var valueT = 0, valueL = 0;
     do {
@@ -2003,4 +3266,6 @@
 
     return [valueL, valueT];
   }
-}
\ No newline at end of file
+}
+
+Element.addMethods();
\ No newline at end of file

Modified: trunk/skel/public/javascript/scriptaculous.js
===================================================================
--- trunk/skel/public/javascript/scriptaculous.js	2007-06-12 14:45:22 UTC (rev 432)
+++ trunk/skel/public/javascript/scriptaculous.js	2007-06-15 07:57:36 UTC (rev 433)
@@ -1,4 +1,6 @@
-// Copyright (c) 2005 Thomas Fuchs (http://script.aculo.us, http://mir.aculo.us)
+// script.aculo.us scriptaculous.js v1.7.1_beta3, Fri May 25 17:19:41 +0200 2007
+
+// Copyright (c) 2005-2007 Thomas Fuchs (http://script.aculo.us, http://mir.aculo.us)
 // 
 // Permission is hereby granted, free of charge, to any person obtaining
 // a copy of this software and associated documentation files (the
@@ -18,27 +20,36 @@
 // LIABLE FOR ANY CLAIM, DAMAGES OR OTHER LIABILITY, WHETHER IN AN ACTION
 // OF CONTRACT, TORT OR OTHERWISE, ARISING FROM, OUT OF OR IN CONNECTION
 // WITH THE SOFTWARE OR THE USE OR OTHER DEALINGS IN THE SOFTWARE.
+//
+// For details, see the script.aculo.us web site: http://script.aculo.us/
 
 var Scriptaculous = {
-  Version: '1.6.1',
+  Version: '1.7.1_beta3',
   require: function(libraryName) {
     // inserting via DOM fails in Safari 2.0, so brute force approach
     document.write('<script type="text/javascript" src="'+libraryName+'"></script>');
   },
+  REQUIRED_PROTOTYPE: '1.5.1',
   load: function() {
+    function convertVersionString(versionString){
+      var r = versionString.split('.');
+      return parseInt(r[0])*100000 + parseInt(r[1])*1000 + parseInt(r[2]);
+    }
+ 
     if((typeof Prototype=='undefined') || 
        (typeof Element == 'undefined') || 
        (typeof Element.Methods=='undefined') ||
-       parseFloat(Prototype.Version.split(".")[0] + "." +
-                  Prototype.Version.split(".")[1]) < 1.5)
-       throw("script.aculo.us requires the Prototype JavaScript framework >= 1.5.0");
+       (convertVersionString(Prototype.Version) < 
+        convertVersionString(Scriptaculous.REQUIRED_PROTOTYPE)))
+       throw("script.aculo.us requires the Prototype JavaScript framework >= " +
+        Scriptaculous.REQUIRED_PROTOTYPE);
     
     $A(document.getElementsByTagName("script")).findAll( function(s) {
       return (s.src && s.src.match(/scriptaculous\.js(\?.*)?$/))
     }).each( function(s) {
       var path = s.src.replace(/scriptaculous\.js(\?.*)?$/,'');
       var includes = s.src.match(/\?.*load=([a-z,]*)/);
-      (includes ? includes[1] : 'builder,effects,dragdrop,controls,slider').split(',').each(
+      (includes ? includes[1] : 'builder,effects,dragdrop,controls,slider,sound').split(',').each(
        function(include) { Scriptaculous.require(path+include+'.js') });
     });
   }

Modified: trunk/skel/public/javascript/slider.js
===================================================================
--- trunk/skel/public/javascript/slider.js	2007-06-12 14:45:22 UTC (rev 432)
+++ trunk/skel/public/javascript/slider.js	2007-06-15 07:57:36 UTC (rev 433)
@@ -1,25 +1,9 @@
-// Copyright (c) 2005 Marty Haught, Thomas Fuchs 
+// script.aculo.us slider.js v1.7.1_beta3, Fri May 25 17:19:41 +0200 2007
+
+// Copyright (c) 2005-2007 Marty Haught, Thomas Fuchs 
 //
-// See http://script.aculo.us for more info
-// 
-// Permission is hereby granted, free of charge, to any person obtaining
-// a copy of this software and associated documentation files (the
-// "Software"), to deal in the Software without restriction, including
-// without limitation the rights to use, copy, modify, merge, publish,
-// distribute, sublicense, and/or sell copies of the Software, and to
-// permit persons to whom the Software is furnished to do so, subject to
-// the following conditions:
-// 
-// The above copyright notice and this permission notice shall be
-// included in all copies or substantial portions of the Software.
-//
-// THE SOFTWARE IS PROVIDED "AS IS", WITHOUT WARRANTY OF ANY KIND,
-// EXPRESS OR IMPLIED, INCLUDING BUT NOT LIMITED TO THE WARRANTIES OF
-// MERCHANTABILITY, FITNESS FOR A PARTICULAR PURPOSE AND
-// NONINFRINGEMENT. IN NO EVENT SHALL THE AUTHORS OR COPYRIGHT HOLDERS BE
-// LIABLE FOR ANY CLAIM, DAMAGES OR OTHER LIABILITY, WHETHER IN AN ACTION
-// OF CONTRACT, TORT OR OTHERWISE, ARISING FROM, OUT OF OR IN CONNECTION
-// WITH THE SOFTWARE OR THE USE OR OTHER DEALINGS IN THE SOFTWARE.
+// script.aculo.us is freely distributable under the terms of an MIT-style license.
+// For details, see the script.aculo.us web site: http://script.aculo.us/
 
 if(!Control) var Control = {};
 Control.Slider = Class.create();
@@ -64,8 +48,13 @@
     this.alignY = parseInt(this.options.alignY || '0');
     
     this.trackLength = this.maximumOffset() - this.minimumOffset();
-    this.handleLength = this.isVertical() ? this.handles[0].offsetHeight : this.handles[0].offsetWidth;
 
+    this.handleLength = this.isVertical() ? 
+      (this.handles[0].offsetHeight != 0 ? 
+        this.handles[0].offsetHeight : this.handles[0].style.height.replace(/px$/,"")) : 
+      (this.handles[0].offsetWidth != 0 ? this.handles[0].offsetWidth : 
+        this.handles[0].style.width.replace(/px$/,""));
+
     this.active   = false;
     this.dragging = false;
     this.disabled = false;
@@ -137,8 +126,8 @@
   },
   setValue: function(sliderValue, handleIdx){
     if(!this.active) {
-      this.activeHandle    = this.handles[handleIdx];
-      this.activeHandleIdx = handleIdx;
+      this.activeHandleIdx = handleIdx || 0;
+      this.activeHandle    = this.handles[this.activeHandleIdx];
       this.updateStyles();
     }
     handleIdx = handleIdx || this.activeHandleIdx || 0;
@@ -180,8 +169,11 @@
     return(this.isVertical() ? this.alignY : this.alignX);
   },
   maximumOffset: function(){
-    return(this.isVertical() ?
-      this.track.offsetHeight - this.alignY : this.track.offsetWidth - this.alignX);
+    return(this.isVertical() ? 
+      (this.track.offsetHeight != 0 ? this.track.offsetHeight :
+        this.track.style.height.replace(/px$/,"")) - this.alignY : 
+      (this.track.offsetWidth != 0 ? this.track.offsetWidth : 
+        this.track.style.width.replace(/px$/,"")) - this.alignY);
   },  
   isVertical:  function(){
     return (this.axis == 'vertical');
@@ -217,7 +209,8 @@
         
         var handle = Event.element(event);
         var pointer  = [Event.pointerX(event), Event.pointerY(event)];
-        if(handle==this.track) {
+        var track = handle;
+        if(track==this.track) {
           var offsets  = Position.cumulativeOffset(this.track); 
           this.event = event;
           this.setValue(this.translateToValue( 
@@ -230,14 +223,16 @@
           // find the handle (prevents issues with Safari)
           while((this.handles.indexOf(handle) == -1) && handle.parentNode) 
             handle = handle.parentNode;
-        
-          this.activeHandle    = handle;
-          this.activeHandleIdx = this.handles.indexOf(this.activeHandle);
-          this.updateStyles();
-        
-          var offsets  = Position.cumulativeOffset(this.activeHandle);
-          this.offsetX = (pointer[0] - offsets[0]);
-          this.offsetY = (pointer[1] - offsets[1]);
+            
+          if(this.handles.indexOf(handle)!=-1) {
+            this.activeHandle    = handle;
+            this.activeHandleIdx = this.handles.indexOf(this.activeHandle);
+            this.updateStyles();
+            
+            var offsets  = Position.cumulativeOffset(this.activeHandle);
+            this.offsetX = (pointer[0] - offsets[0]);
+            this.offsetY = (pointer[1] - offsets[1]);
+          }
         }
       }
       Event.stop(event);
@@ -247,8 +242,7 @@
    if(this.active) {
       if(!this.dragging) this.dragging = true;
       this.draw(event);
-      // fix AppleWebKit rendering
-      if(navigator.appVersion.indexOf('AppleWebKit')>0) window.scrollBy(0,0);
+      if(Prototype.Browser.WebKit) window.scrollBy(0,0);
       Event.stop(event);
    }
   },

Added: trunk/skel/public/javascript/sound.js
===================================================================
--- trunk/skel/public/javascript/sound.js	2007-06-12 14:45:22 UTC (rev 432)
+++ trunk/skel/public/javascript/sound.js	2007-06-15 07:57:36 UTC (rev 433)
@@ -0,0 +1,60 @@
+// script.aculo.us sound.js v1.7.1_beta3, Fri May 25 17:19:41 +0200 2007
+
+// Copyright (c) 2005-2007 Thomas Fuchs (http://script.aculo.us, http://mir.aculo.us)
+//
+// Based on code created by Jules Gravinese (http://www.webveteran.com/)
+//
+// script.aculo.us is freely distributable under the terms of an MIT-style license.
+// For details, see the script.aculo.us web site: http://script.aculo.us/
+
+Sound = {
+  tracks: {},
+  _enabled: true,
+  template:
+    new Template('<embed style="height:0" id="sound_#{track}_#{id}" src="#{url}" loop="false" autostart="true" hidden="true"/>'),
+  enable: function(){
+    Sound._enabled = true;
+  },
+  disable: function(){
+    Sound._enabled = false;
+  },
+  play: function(url){
+    if(!Sound._enabled) return;
+    var options = Object.extend({
+      track: 'global', url: url, replace: false
+    }, arguments[1] || {});
+    
+    if(options.replace && this.tracks[options.track]) {
+      $R(0, this.tracks[options.track].id).each(function(id){
+        var sound = $('sound_'+options.track+'_'+id);
+        sound.Stop && sound.Stop();
+        sound.remove();
+      })
+      this.tracks[options.track] = null;
+    }
+      
+    if(!this.tracks[options.track])
+      this.tracks[options.track] = { id: 0 }
+    else
+      this.tracks[options.track].id++;
+      
+    options.id = this.tracks[options.track].id;
+    if (Prototype.Browser.IE) {
+      var sound = document.createElement('bgsound');
+      sound.setAttribute('id','sound_'+options.track+'_'+options.id);
+      sound.setAttribute('src',options.url);
+      sound.setAttribute('loop','1');
+      sound.setAttribute('autostart','true');
+      $$('body')[0].appendChild(sound);
+    }  
+    else
+      new Insertion.Bottom($$('body')[0], Sound.template.evaluate(options));
+  }
+};
+
+if(Prototype.Browser.Gecko && navigator.userAgent.indexOf("Win") > 0){
+  if(navigator.plugins && $A(navigator.plugins).detect(function(p){ return p.name.indexOf('QuickTime') != -1 }))
+    Sound.template = new Template('<object id="sound_#{track}_#{id}" width="0" height="0" type="audio/mpeg" data="#{url}"/>')
+  else
+    Sound.play = function(){}
+}



From aurelian at mail.berlios.de  Sun Jun 17 13:35:55 2007
From: aurelian at mail.berlios.de (aurelian at BerliOS)
Date: Sun, 17 Jun 2007 13:35:55 +0200
Subject: [Medick-svn] r436 - in trunk: . libs/medick
Message-ID: <200706171135.l5HBZt6S003477@sheep.berlios.de>

Author: aurelian
Date: 2007-06-17 13:35:55 +0200 (Sun, 17 Jun 2007)
New Revision: 436

Modified:
   trunk/README
   trunk/VERSION
   trunk/libs/medick/Medick.php
Log:
 -- preparing for version 0.4.0

Modified: trunk/README
===================================================================
--- trunk/README	2007-06-15 09:03:43 UTC (rev 435)
+++ trunk/README	2007-06-17 11:35:55 UTC (rev 436)
@@ -5,10 +5,10 @@
 
 ABOUT:
 ------
-    This is the README file for version 0.3.0pre2 of Medick released on 23.July.2006.
+    This is the README file for version 0.4.0 of Medick released on 17.June.2007.
     Medick is an open-source software licensed under a BSD-style licence, see LICENSE file for details.
     Medick is a PHP 5 web framework, not a collection of PHP classes.
-    Medick is alpha stage project, use it on your own risk. 
+    Medick is alpha stage project, use it on your own risk: 
     Function names or framework workflow might change without prior notice.
 
 REQUIREMENTS:
@@ -49,4 +49,3 @@
 --------
     aurelian [ AT ] locknet [ DOT ] ro
     http://medick.locknet.ro
-

Modified: trunk/VERSION
===================================================================
--- trunk/VERSION	2007-06-15 09:03:43 UTC (rev 435)
+++ trunk/VERSION	2007-06-17 11:35:55 UTC (rev 436)
@@ -1 +1 @@
-0.4-svn
+0.4.0

Modified: trunk/libs/medick/Medick.php
===================================================================
--- trunk/libs/medick/Medick.php	2007-06-15 09:03:43 UTC (rev 435)
+++ trunk/libs/medick/Medick.php	2007-06-17 11:35:55 UTC (rev 436)
@@ -52,7 +52,7 @@
      * @return string the medick version
      */
     public static function getVersion() {
-        return '0.4-svn';
+        return '0.4.0';
     }
 
 }



From aurelian at mail.berlios.de  Sun Jun 17 14:36:04 2007
From: aurelian at mail.berlios.de (aurelian at BerliOS)
Date: Sun, 17 Jun 2007 14:36:04 +0200
Subject: [Medick-svn] r437 - in trunk/docs: . medick.api.template
	medick.api.template/media
Message-ID: <200706171236.l5HCa4DB007535@sheep.berlios.de>

Author: aurelian
Date: 2007-06-17 14:36:03 +0200 (Sun, 17 Jun 2007)
New Revision: 437

Added:
   trunk/docs/medick.api.template/
   trunk/docs/medick.api.template/blank.html
   trunk/docs/medick.api.template/media/
   trunk/docs/medick.api.template/media/stylesheet.css
   trunk/docs/medick.api.template/packages.html
Log:
 -- added medick API templates

Added: trunk/docs/medick.api.template/blank.html
===================================================================
--- trunk/docs/medick.api.template/blank.html	2007-06-17 11:35:55 UTC (rev 436)
+++ trunk/docs/medick.api.template/blank.html	2007-06-17 12:36:03 UTC (rev 437)
@@ -0,0 +1,7 @@
+<html><head><title>Medick PHP 5 Web Framework :: API Documentation</title>
+  <link rel="stylesheet" href="media/stylesheet.css" type="text/css" />
+  <meta http-equiv='Content-Type' content='text/html; charset=iso-8859-1'/>
+</head><body><div align="center"><h1>Medick API Documentation</h1><p>
+  This documentation was generated by <a href="http://www.phpdoc.org" target="self">phpDocumentor</a><br /> 
+  from <a href="medick.locknet.ro" target="_top">medick</a> version 0.4 on <em>on Fri, 14 Jun 2007 18:12:46 +0300</em></p>
+</div></body></html>
\ No newline at end of file

Added: trunk/docs/medick.api.template/media/stylesheet.css
===================================================================
--- trunk/docs/medick.api.template/media/stylesheet.css	2007-06-17 11:35:55 UTC (rev 436)
+++ trunk/docs/medick.api.template/media/stylesheet.css	2007-06-17 12:36:03 UTC (rev 437)
@@ -0,0 +1,155 @@
+a { color: #000090; text-decoration: none; }
+a:hover, a:active, a:focus { color: highlighttext; background-color: highlight; text-decoration: none; }
+
+body { 
+    /* background: #FFFFFF;*/
+    background-color: #F5FEE8;
+}
+body, table { font-family: Verdana, Arial, Helvetica, sans-serif; font-size: 10pt; }
+
+a img { border: 0px; }
+
+/* Page layout/boxes */
+
+.info-box {  }
+.info-box-title { 
+    margin: 1em 0em 0em 0em; 
+    font-weight: normal; 
+    font-size: 14pt; 
+    color: #999999; 
+    border-bottom: 2px solid #E5328B;
+}
+.info-box-body { border: 1px solid #999999; padding: .5em; }
+.nav-bar { font-size: 8pt; white-space: nowrap; text-align: right; padding: .2em; margin: 0em 0em 1em 0em; }
+
+.oddrow { background-color: #F8F8F8; border: 1px solid #AAAAAA; padding: .5em; margin-bottom: 1em}
+.evenrow { border: 1px solid #AAAAAA; padding: .5em; margin-bottom: 1em}
+
+.page-body { max-width: 800px; margin: auto; }
+.tree { white-space: nowrap; font: icon }
+.tree dd { margin-left: 19px }
+.tree dl { margin: 0px }
+.tree-icon { 	vertical-align: middle; border: 0px; margin-right: 3px }
+
+/* Index formatting classes */
+
+.index-item-body { margin-top: .5em; margin-bottom: .5em}
+.index-item-description { margin-top: .25em }
+.index-item-details { font-weight: normal; font-style: italic; font-size: 8pt }
+.index-letter-section { background-color: #EEEEEE; border: 1px dotted #999999; padding: .5em; margin-bottom: 1em}
+.index-letter-title { font-size: 12pt; font-weight: bold }
+.index-letter-menu { text-align: center; margin: 1em }
+.index-letter { font-size: 12pt }
+
+/* Docbook classes */
+
+.description {}
+.short-description { font-weight: bold; color: #666666; }
+.tags {	padding-left: 0em; margin-left: 3em; color: #666666; list-style-type: square; }
+.parameters {	padding-left: 0em; margin-left: 3em; color: #014fbe; list-style-type: square; }
+.redefinitions { font-size: 8pt; padding-left: 0em; margin-left: 2em; }
+.package { font-weight: bold; }
+.package-title { font-weight: bold; font-size: 14pt; border-bottom: 1px solid #E5328B; }
+.package-details { font-size: 85%; }
+.sub-package { font-weight: bold; }
+.tutorial { border-width: thin; border-color: #0066ff; }
+.tutorial-nav-box { width: 100%; border: 1px solid #999999; background-color: #F8F8F8; }
+.folder-title { font-style: italic; font-family: Verdana, Arial, Helvetica, sans-serif }
+
+/* Generic formatting */
+
+.field { font-weight: bold; }
+.detail { font-size: 8pt; }
+.notes { font-style: italic; font-size: 8pt; }
+.separator { background-color: #999999; height: 2px; }
+.warning {  color: #FF6600; }
+.disabled { font-style: italic; color: #999999; }
+
+/* Code elements */
+
+.line-number {  }
+
+.class-table { width: 100%; }
+.class-table-header { border-bottom: 1px dotted #666666; text-align: left}
+.class-name { color: #0000AA; font-weight: bold; }
+
+.method-summary { color: #009000; padding-left: 1em; font-size: 8pt; }
+.method-header { }
+.method-definition { margin-bottom: .2em }
+.method-title { color: #009000; font-weight: bold; }
+.method-name { font-weight: bold; }
+.method-signature { font-size: 85%; color: #666666; margin: .5em 0em }
+.method-result { font-style: italic; }
+
+.var-summary { padding-left: 1em; font-size: 8pt; }
+.var-header { }
+.var-title { color: #014fbe; margin-bottom: .3em }
+.var-type { font-style: italic; }
+.var-name { font-weight: bold; }
+.var-default {}
+.var-description { font-weight: normal; color: #000000; }
+
+.include-title { color: #014fbe;}
+.include-type { font-style: italic; }
+.include-name { font-weight: bold; }
+
+.const-title { color: #FF6600; }
+.const-name { font-weight: bold; }
+
+/* Syntax highlighting */
+
+.src-code {  }
+*[class="src-code"] {	line-height : 0.5em }
+
+.src-code a:link { padding: 1px; text-decoration: underline; color: #0000DD; }
+.src-code a:visited { text-decoration: underline; color: #0000DD; }
+.src-code a:active { background-color: #FFFF66; color: #008000; }
+.src-code a:hover { background-color: #FFFF66; text-decoration: overline underline; color: #008000; }
+
+.src-comm { color: #666666; }
+.src-id { color: #FF6600; font-style: italic; }
+.src-inc { color: #0000AA; font-weight: bold; }
+.src-key { color: #0000AA; font-weight: bold; }
+.src-num { color: #CC0000; }
+.src-str { color: #CC0000; }
+.src-sym { }
+.src-var { }
+
+.src-php { font-weight: bold; }
+
+.src-doc { color: #666666; }
+.src-doc-close-template { color: #666666 }
+.src-doc-coretag { color: #008000; }
+.src-doc-inlinetag {}
+.src-doc-internal {}
+.src-doc-tag { color: #0080CC; }
+.src-doc-template { color: #666666 }
+.src-doc-type { font-style: italic; color: #444444 }
+.src-doc-var { color: #444444 }
+
+.tute-tag { color: #009999 }
+.tute-attribute-name { color: #0000FF }
+.tute-attribute-value { color: #0099FF }
+.tute-entity { font-weight: bold; }
+.tute-comment { font-style: italic }
+.tute-inline-tag { color: #636311; font-weight: bold }
+
+/* tutorial */
+
+.authors {  }
+.author { font-style: italic; font-weight: bold }
+.author-blurb { margin: .5em 0em .5em 2em; font-size: 85%; font-weight: normal; font-style: normal }
+.example { border: 1px dashed #999999; background-color: #EEEEEE; padding: .5em; }
+*[class="example"] { line-height : 0.5em; }
+.listing { border: 1px dashed #999999; background-color: #EEEEEE; padding: .5em; white-space: nowrap; }
+*[class="listing"] { line-height : 0.5em; }
+.release-info { font-size: 85%; font-style: italic; margin: 1em 0em }
+.ref-title-box {  }
+.ref-title {  }
+.ref-purpose { font-style: italic; color: #666666 }
+.ref-synopsis {  }
+.title { font-weight: bold; border-bottom: 1px solid #999999; color: #999999;  }
+.cmd-synopsis { margin: 1em 0em }
+.cmd-title { font-weight: bold }
+.toc { margin-left: 2em; padding-left: 0em }
+

Added: trunk/docs/medick.api.template/packages.html
===================================================================
--- trunk/docs/medick.api.template/packages.html	2007-06-17 11:35:55 UTC (rev 436)
+++ trunk/docs/medick.api.template/packages.html	2007-06-17 12:36:03 UTC (rev 437)
@@ -0,0 +1,46 @@
+<?xml version="1.0" encoding="iso-8859-1"?>
+<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
+  <html xmlns="http://www.w3.org/1999/xhtml">
+		<head>
+			<!-- template designed by Marco Von Ballmoos -->
+			<title>Medick PHP 5 Web Framework :: API Docs</title>
+			<link rel="stylesheet" href="media/stylesheet.css" type="text/css" />
+			<link rel="stylesheet" href="media/banner.css" type="text/css" />
+			<meta http-equiv='Content-Type' content='text/html; charset=iso-8859-1'/>
+		</head>
+		<body>
+			<div class="banner">
+				<div class="banner-title">Medick :: The PHP Framework</div>
+				<div class="banner-menu">
+					<form>
+						<table cellpadding="0" cellspacing="0" style="width: 100%">
+							<tr>
+								<td>
+<a href="http://medick.locknet.ro" target="_top">Medick Home Page</a> | 
+<a href="http://medick.locknet.ro/api" target="_top">Api Home</a> | 
+<a href="ric_CHANGELOG.html" target="right">CHANGELOG</a> | 
+<a href="ric_LICENSE.html" target="right">LICENSE</a> |	
+<a href="ric_README.html" target="right">README</a> | 
+<a href="ric_TODO.html" target="right">TODO</a>
+    </td>
+								<td style="width: 2em">&nbsp;</td>
+								<td style="text-align: right">
+																			<span class="field">Packages</span> 
+										<select class="package-selector" onchange="window.parent.left_bottom.location=this[selectedIndex].value">
+																					<option value="li_medick.core.html">medick.core</option>
+																					<option value="li_medick.action.controller.html">medick.action.controller</option>
+																					<option value="li_medick.action.view.html">medick.action.view</option>
+																					<option value="li_medick.active.record.html">medick.active.record</option>
+																					<option value="li_medick.active.support.html">medick.active.support</option>
+																					<option value="li_medick.configurator.html">medick.configurator</option>
+																					<option value="li_medick.context.html">medick.context</option>
+																					<option value="li_medick.logger.html">medick.logger</option>
+																				</select>
+																	</td>
+							</tr>
+						</table>
+					</form>
+				</div>
+			</div>
+		</body>
+	</html>
\ No newline at end of file



From aurelian at mail.berlios.de  Sun Jun 17 15:39:22 2007
From: aurelian at mail.berlios.de (aurelian at BerliOS)
Date: Sun, 17 Jun 2007 15:39:22 +0200
Subject: [Medick-svn] r438 - in trunk: docs/medick.api.template
	docs/medick.api.template/media scripts
Message-ID: <200706171339.l5HDdMg1013140@sheep.berlios.de>

Author: aurelian
Date: 2007-06-17 15:39:22 +0200 (Sun, 17 Jun 2007)
New Revision: 438

Added:
   trunk/scripts/build.sh
Modified:
   trunk/docs/medick.api.template/blank.html
   trunk/docs/medick.api.template/media/stylesheet.css
   trunk/docs/medick.api.template/packages.html
Log:
 -- changes to API layout && a nice build script

Modified: trunk/docs/medick.api.template/blank.html
===================================================================
--- trunk/docs/medick.api.template/blank.html	2007-06-17 12:36:03 UTC (rev 437)
+++ trunk/docs/medick.api.template/blank.html	2007-06-17 13:39:22 UTC (rev 438)
@@ -3,5 +3,5 @@
   <meta http-equiv='Content-Type' content='text/html; charset=iso-8859-1'/>
 </head><body><div align="center"><h1>Medick API Documentation</h1><p>
   This documentation was generated by <a href="http://www.phpdoc.org" target="self">phpDocumentor</a><br /> 
-  from <a href="medick.locknet.ro" target="_top">medick</a> version 0.4 on <em>on Fri, 14 Jun 2007 18:12:46 +0300</em></p>
+  from <a href="medick.locknet.ro" target="_top">medick</a> version #{version} on <em>on #{date}</em></p>
 </div></body></html>
\ No newline at end of file

Modified: trunk/docs/medick.api.template/media/stylesheet.css
===================================================================
--- trunk/docs/medick.api.template/media/stylesheet.css	2007-06-17 12:36:03 UTC (rev 437)
+++ trunk/docs/medick.api.template/media/stylesheet.css	2007-06-17 13:39:22 UTC (rev 438)
@@ -9,6 +9,8 @@
 
 a img { border: 0px; }
 
+li { margin:0px; padding:0px; }
+
 /* Page layout/boxes */
 
 .info-box {  }

Modified: trunk/docs/medick.api.template/packages.html
===================================================================
--- trunk/docs/medick.api.template/packages.html	2007-06-17 12:36:03 UTC (rev 437)
+++ trunk/docs/medick.api.template/packages.html	2007-06-17 13:39:22 UTC (rev 438)
@@ -23,24 +23,24 @@
 <a href="ric_README.html" target="right">README</a> | 
 <a href="ric_TODO.html" target="right">TODO</a>
     </td>
-								<td style="width: 2em">&nbsp;</td>
-								<td style="text-align: right">
-																			<span class="field">Packages</span> 
-										<select class="package-selector" onchange="window.parent.left_bottom.location=this[selectedIndex].value">
-																					<option value="li_medick.core.html">medick.core</option>
-																					<option value="li_medick.action.controller.html">medick.action.controller</option>
-																					<option value="li_medick.action.view.html">medick.action.view</option>
-																					<option value="li_medick.active.record.html">medick.active.record</option>
-																					<option value="li_medick.active.support.html">medick.active.support</option>
-																					<option value="li_medick.configurator.html">medick.configurator</option>
-																					<option value="li_medick.context.html">medick.context</option>
-																					<option value="li_medick.logger.html">medick.logger</option>
-																				</select>
-																	</td>
-							</tr>
-						</table>
-					</form>
-				</div>
-			</div>
-		</body>
+								<td style="width: 2em">&nbsp;</td>
+								<td style="text-align: right">
+								<span class="field">Packages</span>
+								<select class="package-selector" onchange="window.parent.left_bottom.location=this[selectedIndex].value">
+								    <option value="li_medick.core.html">medick.core</option>
+								    <option value="li_medick.action.controller.html">medick.action.controller</option>
+								    <option value="li_medick.action.view.html">medick.action.view</option>
+								    <option value="li_medick.active.record.html">medick.active.record</option>
+								    <option value="li_medick.active.support.html">medick.active.support</option>
+								    <option value="li_medick.configurator.html">medick.configurator</option>
+								    <option value="li_medick.context.html">medick.context</option>
+								    <option value="li_medick.logger.html">medick.logger</option>
+								</select>
+							    </td>
+							</tr>
+						</table>
+					</form>
+				</div>
+			</div>
+		</body>
 	</html>
\ No newline at end of file

Added: trunk/scripts/build.sh
===================================================================
--- trunk/scripts/build.sh	2007-06-17 12:36:03 UTC (rev 437)
+++ trunk/scripts/build.sh	2007-06-17 13:39:22 UTC (rev 438)
@@ -0,0 +1,111 @@
+#!/bin/bash
+
+#
+# $Id$
+#
+
+# php doc path.
+PHPDOC="/W/Devel/PhpDocumentor-1.3.0RC4"
+
+# "log" function
+function say {
+	echo "[`date +"%Y-%m-%d %H:%M:%S"`] ===> $1"
+}
+
+# {{{ find what version we are building
+version=`cat VERSION`
+build="build/medick-$version"
+
+say "Building release of medick-$version"
+# }}}
+
+# {{{ check if the build folder exists or if we have the force option
+if [ -d $build ]; then
+	say "$build exists"
+	if [[ ("$1" == "-f") || ("$1" == "--force") ]]; then
+		say "force a re-build"
+		rm -rf $build
+	else
+		say "Use -f [--force] to force a re-build."
+		exit
+	fi
+fi
+# }}}
+
+# {{{ prepare for build
+framework=$build/framework
+applications=$build/applications
+doc=$build/doc
+api=$build/api
+mkdir -p build
+mkdir -p $build
+rm -rf $doc
+rm -rf $api
+mkdir -p $doc
+mkdir -p $api
+# }}}
+
+# {{{ svn export 
+say "Exporting applications to $applications"
+svn export -q svn://svn.berlios.de/medick/applications $applications
+
+say "Exporting trunk to $framework"
+svn export -q svn://svn.berlios.de/medick/trunk $framework
+# }}}}
+
+# {{{ build the API docs 
+doc_entries=( $framework/libs/action/ \
+						  $framework/libs/active/ \
+						  $framework/libs/context/ \
+						  $framework/libs/configurator/ \
+						  $framework/libs/logger/ \
+						  $framework/libs/medick/ \
+							$framework/README \
+							$framework/TODO \
+							$framework/LICENSE \
+							$framework/CHANGELOG \
+							$framework/VERSION )
+							
+say "Preparing API docs."							
+for entry in ${doc_entries[@]}
+do
+	if echo "$entry" | grep -q libs
+	then
+		p=`echo $entry | sed -e "s/framework\/libs/doc/"`
+		cp -r $entry $p
+	else
+		cp $entry $doc
+	fi
+done
+
+say "Running phpdoc..."
+
+php -dinclude_path=$PHPDOC -derror_reporting='E_ALL ^ E_NOTICE' $PHPDOC/pear-phpdoc --pear off -q -d $doc/ -t $api -ti "Medick API Documentation" -dn "medick.core" -s on -o "HTML:frames:earthli"
+
+# copy our templates
+# cp docs/medick.api.template/blank.html $api/.
+
+say "Apply medick templates on API docs."
+sed -e "s/#{date}/`date`/" -e "s/#{version}/$version/" docs/medick.api.template/blank.html > $api/blank.html
+cp docs/medick.api.template/packages.html $api/.
+cp docs/medick.api.template/media/stylesheet.css $api/media/.
+
+# cleanup
+say "Clean up."
+rm -rf $doc $framework/docs $framework/scripts $framework/test/
+mv $api $framework/docs
+
+# }}}
+
+# {{{ pack.
+say "Packing files..."
+cd build
+tar -czf medick-$version.tgz medick-$version
+zip -9 -q -r medick-$version.zip medick-$version
+cd ../
+
+say "Created tgz file to build/medick-$version.tgz"
+say "Created zip file to build/medick-$version.zip"
+# }}}
+
+say "All Done."


Property changes on: trunk/scripts/build.sh
___________________________________________________________________
Name: svn:executable
   + *
Name: svn:keywords
   + Id



From aurelian at mail.berlios.de  Sun Jun 17 15:40:50 2007
From: aurelian at mail.berlios.de (aurelian at BerliOS)
Date: Sun, 17 Jun 2007 15:40:50 +0200
Subject: [Medick-svn] r439 - tags
Message-ID: <200706171340.l5HDeoER013298@sheep.berlios.de>

Author: aurelian
Date: 2007-06-17 15:40:50 +0200 (Sun, 17 Jun 2007)
New Revision: 439

Added:
   tags/medick-0.4.0/
Log:
 -- creating release tag

Copied: tags/medick-0.4.0 (from rev 438, trunk)



From aurelian at mail.berlios.de  Sun Jun 17 15:41:56 2007
From: aurelian at mail.berlios.de (aurelian at BerliOS)
Date: Sun, 17 Jun 2007 15:41:56 +0200
Subject: [Medick-svn] r440 - tags/medick-0.4.0
Message-ID: <200706171341.l5HDfuGM013402@sheep.berlios.de>

Author: aurelian
Date: 2007-06-17 15:41:53 +0200 (Sun, 17 Jun 2007)
New Revision: 440

Removed:
   tags/medick-0.4.0/docs/
   tags/medick-0.4.0/scripts/
   tags/medick-0.4.0/test/
Log:
 -- removed unused folders



From aurelian at mail.berlios.de  Sun Jun 17 15:44:16 2007
From: aurelian at mail.berlios.de (aurelian at BerliOS)
Date: Sun, 17 Jun 2007 15:44:16 +0200
Subject: [Medick-svn] r441 - in trunk: . libs/medick
Message-ID: <200706171344.l5HDiGYX013644@sheep.berlios.de>

Author: aurelian
Date: 2007-06-17 15:44:15 +0200 (Sun, 17 Jun 2007)
New Revision: 441

Modified:
   trunk/CHANGELOG
   trunk/VERSION
   trunk/libs/medick/Medick.php
Log:
 -- bumped revision to 0.4.1

Modified: trunk/CHANGELOG
===================================================================
--- trunk/CHANGELOG	2007-06-17 13:41:53 UTC (rev 440)
+++ trunk/CHANGELOG	2007-06-17 13:44:15 UTC (rev 441)
@@ -1,11 +1,13 @@
 $Id$
-(*) SVN version
 
-0.4 (*)
+0.4.1-svn
+
+0.4.0 (17.Jun.2007)
     - added HTTPRequest::is_xhr() method
     - added JSON decode / encode
     - added after filters for ActionController
     - changed before_filter to before_filters for ActionController
+    - reverted database settings to XML config file
     - skeleton for docs in ActionController
 
 0.3.0pre2 (23.Jul.2006)

Modified: trunk/VERSION
===================================================================
--- trunk/VERSION	2007-06-17 13:41:53 UTC (rev 440)
+++ trunk/VERSION	2007-06-17 13:44:15 UTC (rev 441)
@@ -1 +1 @@
-0.4.0
+0.4.1-svn

Modified: trunk/libs/medick/Medick.php
===================================================================
--- trunk/libs/medick/Medick.php	2007-06-17 13:41:53 UTC (rev 440)
+++ trunk/libs/medick/Medick.php	2007-06-17 13:44:15 UTC (rev 441)
@@ -52,7 +52,7 @@
      * @return string the medick version
      */
     public static function getVersion() {
-        return '0.4.0';
+        return '0.4.1-svn';
     }
 
 }



